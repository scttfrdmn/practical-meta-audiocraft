<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Batch Processing and Automation for AI Audio Generation</title>
  <meta name="description" content="“I need to create variations of 50 different musical themes, each in 3 different styles with 2 different parameter settings. That’s 300 audio files! Generati...">
  <link rel="canonical" href="https://scttfrdmn.github.io/practical-meta-audiocraft/chapters/part2/batch-processing-automation/">
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .wrapper {
      max-width: 100%;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 20px;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    h1 { color: #1a73e8; }
    h2 { color: #34a853; }
    a {
      color: #1a73e8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .site-header {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
      margin-bottom: 30px;
    }
    .site-title {
      margin: 0;
      font-size: 1.8rem;
    }
    .site-title a {
      color: #1a73e8;
      text-decoration: none;
    }
    .site-nav {
      float: right;
      margin-top: 10px;
    }
    .site-nav .page-link {
      margin-left: 20px;
    }
    .nav-trigger {
      display: none;
    }
    .menu-icon {
      display: none;
    }
    .page-content {
      padding: 20px 0;
    }
    .site-footer {
      border-top: 1px solid #eee;
      padding: 30px 0;
      margin-top: 60px;
    }
    .footer-col-wrapper {
      display: flex;
      flex-wrap: wrap;
    }
    .footer-col {
      flex: 1;
      min-width: 200px;
      padding-right: 20px;
    }
    code {
      background-color: #f5f5f5;
      padding: 2px 5px;
      border-radius: 3px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .highlight {
      background-color: #f5f5f5;
      border-radius: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px 12px;
    }
    th {
      background-color: #f5f5f5;
      text-align: left;
    }
    button, .button {
      display: inline-block;
      background-color: #1a73e8;
      color: white !important;
      padding: 10px 20px;
      border-radius: 4px;
      font-weight: bold;
      margin-top: 20px;
      border: none;
      cursor: pointer;
      text-decoration: none !important;
    }
    button:hover, .button:hover {
      background-color: #0d65d9;
    }
    .feature {
      background-color: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #1a73e8;
      margin-bottom: 20px;
    }
    
    @media screen and (max-width: 600px) {
      .site-nav {
        position: absolute;
        top: 70px;
        right: 20px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        text-align: right;
        padding: 0;
        z-index: 1;
      }
      .site-nav .page-link {
        display: block;
        padding: 10px;
        margin: 0;
      }
      .site-nav .menu-icon {
        display: block;
        float: right;
        width: 36px;
        height: 26px;
        line-height: 0;
        padding-top: 10px;
        text-align: center;
      }
      .site-nav .trigger {
        clear: both;
        display: none;
      }
      .site-nav input:checked ~ .trigger {
        display: block;
        padding-bottom: 5px;
      }
      .footer-col-wrapper {
        flex-direction: column;
      }
      .footer-col {
        margin-bottom: 20px;
      }
    }
  </style>
</head><body>
    <div class="wrapper">
      <header class="site-header">
        <div class="container">
          <h1 class="site-title"><a href="/practical-meta-audiocraft/">Practical Meta AudioCraft</a></h1>
          <nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger">
              <span class="menu-icon">
                <svg viewBox="0 0 18 15" width="18px" height="15px">
                  <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484c0-0.82,0.665-1.485,1.484-1.485 h15.032C17.335,0,18,0.665,18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516 c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,6.031,18,6.696,18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516c0-0.82,0.665-1.483,1.484-1.483h15.032 C17.335,12.031,18,12.696,18,13.516z"/>
                </svg>
              </span>
            </label>

            <div class="trigger">
              <a class="page-link" href="/practical-meta-audiocraft/">Home</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part1/introduction/">Getting Started</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part2/basic-music/">MusicGen</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part3/introduction-to-audiogen/">AudioGen</a>
              <a class="page-link" href="/practical-meta-audiocraft/tutorials/getting-started/">Tutorials</a>
            </div>
          </nav>
        </div>
      </header>

      <main class="page-content" aria-label="Content">
        <div class="container">
          <div class="chapter">
  <div class="chapter-header">
    <div class="chapter-metadata">
      <span class="difficulty intermediate">Intermediate</span>
      <span class="estimated-time">60</span>
    </div>
    <h1>Batch Processing and Automation for AI Audio Generation</h1>
  </div>
  
  
  
  <blockquote>
  <p><em>“I need to create variations of 50 different musical themes, each in 3 different styles with 2 different parameter settings. That’s 300 audio files! Generating them one by one would take forever, not to mention keeping everything organized. There must be a way to automate this process and handle it efficiently.”</em></p>

  <p>— Alex Winters, game audio director</p>
</blockquote>

<h1 id="chapter-9-batch-processing-and-automation-for-ai-audio-generation">Chapter 9: Batch Processing and Automation for AI Audio Generation</h1>

<h2 id="the-challenge">The Challenge</h2>

<p>You’ve mastered generating individual music pieces with MusicGen and you understand how to optimize parameters and use melody conditioning. But real-world projects often require generating dozens, hundreds, or even thousands of audio samples efficiently. Manual generation quickly becomes impractical at scale.</p>

<p>In this chapter, we’ll tackle the challenge of building scalable, automated audio generation systems. We’ll create frameworks for batch processing, implement organizational structures for the outputs, and develop efficient workflows that can handle large-scale audio generation tasks.</p>

<h2 id="learning-objectives">Learning Objectives</h2>

<p>By the end of this chapter, you will be able to:</p>

<ul>
  <li>Implement batch processing systems for generating multiple audio samples</li>
  <li>Create frameworks for systematic variation experiments</li>
  <li>Build audio generation pipelines with configurable workflows</li>
  <li>Develop organizational structures for managing large collections of generated audio</li>
  <li>Automate the documentation process for generated content</li>
  <li>Optimize system resources for efficient large-scale generation</li>
  <li>Implement progress tracking and error handling for long-running processes</li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Basic understanding of MusicGen and AudioGen (Chapters 5-8)</li>
  <li>Experience with Python programming and file operations</li>
  <li>Familiarity with parameter optimization (Chapter 7)</li>
  <li>Python environment with AudioCraft installed</li>
</ul>

<h2 id="key-concepts-approaches-to-batch-processing">Key Concepts: Approaches to Batch Processing</h2>

<p>Before diving into implementation, let’s explore different approaches to batch processing for AI audio generation:</p>

<h3 id="1-sequential-batch-processing">1. Sequential Batch Processing</h3>

<p>The simplest approach is to process items one after another in a sequential manner:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_sequential_batch</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s">"music"</span><span class="p">,</span> <span class="n">model_size</span><span class="o">=</span><span class="s">"small"</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="s">"""
    Generate multiple audio samples one after another.
    
    Args:
        prompts (list): List of text prompts to generate
        output_dir (str): Directory to save all outputs
        model_type (str): "music" or "audio"
        model_size (str): Model size to use
        duration (float): Duration for all samples
        
    Returns:
        list: Paths to all generated files
    """</span>
    <span class="c1"># Create output directory
</span>    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="c1"># Load the appropriate model
</span>    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s">"music"</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MusicGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">AudioGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>
    
    <span class="c1"># Determine device
</span>    <span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">"cpu"</span>
    <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s">"mps"</span>
    <span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># Set generation parameters
</span>    <span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">top_k</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
        <span class="n">top_p</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="c1"># Track generated files
</span>    <span class="n">generated_files</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Generate each prompt and save the output
</span>    <span class="n">total_prompts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prompts</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_prompts</span><span class="si">}</span><span class="s">] Generating: '</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
        
        <span class="c1"># Create a safe filename from the prompt
</span>        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">03</span><span class="n">d</span><span class="si">}</span><span class="s">_"</span> <span class="o">+</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">"_"</span> <span class="k">else</span> <span class="s">"_"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prompt</span><span class="p">[:</span><span class="mi">50</span><span class="p">])</span>
        
        <span class="c1"># Generate audio
</span>        <span class="n">wav</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
        
        <span class="c1"># Save the audio
</span>        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">audio_write</span><span class="p">(</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
            <span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
        <span class="p">)</span>
        
        <span class="c1"># Add to generated files list
</span>        <span class="n">generated_files</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">)</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Batch generation complete. Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">generated_files</span><span class="p">)</span><span class="si">}</span><span class="s"> files."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">generated_files</span>
</code></pre></div></div>

<p>This approach is straightforward but doesn’t take advantage of potential parallel processing opportunities.</p>

<h3 id="2-parameterized-batch-processing">2. Parameterized Batch Processing</h3>

<p>A more flexible approach is to generate variations across multiple parameters:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_parameter_variations</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">parameters_to_vary</span><span class="p">):</span>
    <span class="s">"""
    Generate variations of a single prompt with different parameter settings.
    
    Args:
        prompt (str): Base text prompt to use for all variations
        output_dir (str): Directory to save outputs
        parameters_to_vary (dict): Dictionary mapping parameter names to lists of values
            Example: {"temperature": [0.5, 1.0, 1.5], "duration": [5.0, 10.0]}
            
    Returns:
        list: Paths to all generated files
    """</span>
    <span class="c1"># Create output directory
</span>    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="c1"># Load model (using small for faster iteration)
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">MusicGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="s">"small"</span><span class="p">)</span>
    
    <span class="c1"># Determine device
</span>    <span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">"cpu"</span>
    <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s">"mps"</span>
    <span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># Create all possible parameter combinations
</span>    <span class="kn">import</span> <span class="nn">itertools</span>
    
    <span class="c1"># Get parameter names and values
</span>    <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters_to_vary</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">param_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameters_to_vary</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">]</span>
    
    <span class="c1"># Generate all combinations
</span>    <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">param_values</span><span class="p">))</span>
    
    <span class="c1"># Default parameters (will be overridden by specific variations)
</span>    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s">"top_k"</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
        <span class="s">"top_p"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s">"cfg_coef"</span><span class="p">:</span> <span class="mf">3.0</span>
    <span class="p">}</span>
    
    <span class="c1"># Track generated files
</span>    <span class="n">generated_files</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Generate each parameter combination
</span>    <span class="n">total_combinations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinations</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">combination</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">):</span>
        <span class="c1"># Create parameter dictionary for this combination
</span>        <span class="n">params</span> <span class="o">=</span> <span class="n">default_params</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Add specific parameters for this combination
</span>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">combination</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        
        <span class="c1"># Create descriptive filename
</span>        <span class="n">filename_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">param_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">combination</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s">"</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">))]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">"_"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename_parts</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_combinations</span><span class="si">}</span><span class="s">] Generating with parameters: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Set generation parameters
</span>        <span class="n">generation_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="p">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">"duration"</span><span class="p">}</span>
        <span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"duration"</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
            <span class="o">**</span><span class="n">generation_params</span>
        <span class="p">)</span>
        
        <span class="c1"># Generate audio
</span>        <span class="n">wav</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
        
        <span class="c1"># Save the audio
</span>        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">audio_write</span><span class="p">(</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
            <span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
        <span class="p">)</span>
        
        <span class="c1"># Save parameter metadata
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.json"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">({</span>
                <span class="s">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                <span class="s">"parameters"</span><span class="p">:</span> <span class="n">params</span>
            <span class="p">},</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Add to generated files list
</span>        <span class="n">generated_files</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">)</span>
    
    <span class="c1"># Create summary file
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"variations_summary.txt"</span><span class="p">),</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"PARAMETER VARIATIONS SUMMARY</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"=========================</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"Base prompt: </span><span class="se">\"</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="se">\"\n\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Parameters varied:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">parameters_to_vary</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Total variations: </span><span class="si">{</span><span class="n">total_combinations</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Parameter variation complete. Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">generated_files</span><span class="p">)</span><span class="si">}</span><span class="s"> files."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">generated_files</span>
</code></pre></div></div>

<p>This approach allows for systematic exploration of parameter spaces, which is valuable for experimentation and finding optimal settings.</p>

<h3 id="3-pipeline-based-batch-processing">3. Pipeline-based Batch Processing</h3>

<p>For more complex workflows, a pipeline architecture provides better modularity and reusability:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AudioGenerationPipeline</span><span class="p">:</span>
    <span class="s">"""
    A modular pipeline for batch processing audio generation tasks.
    
    This class encapsulates the entire generation workflow with distinct stages:
    1. Pipeline initialization (models, devices)
    2. Batch configuration (parameters, outputs)
    3. Generation execution
    4. Post-processing
    5. Documentation
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s">"music"</span><span class="p">,</span> <span class="n">model_size</span><span class="o">=</span><span class="s">"small"</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Initialize the generation pipeline with models and device settings."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">model_size</span>
        
        <span class="c1"># Determine device automatically if not specified
</span>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"mps"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using MPS (Metal) for generation"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using CUDA for generation"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"cpu"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using CPU for generation (this will be slow)"</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        
        <span class="c1"># Load the appropriate model
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Loading </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s"> model (</span><span class="si">{</span><span class="n">model_size</span><span class="si">}</span><span class="s">)..."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s">"music"</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MusicGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AudioGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Initialize state variables
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">batch_config</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">generated_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">configure_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">generation_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">batch_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Configure the batch generation parameters.
        
        Args:
            prompts (list or dict): List of prompts or dictionary mapping IDs to prompts
            output_dir (str): Directory to save outputs
            generation_params (dict): Generation parameters
            batch_name (str): Optional name for this batch
        """</span>
        <span class="c1"># Convert prompts to dictionary if it's a list
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">prompts</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s">"prompt_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">03</span><span class="n">d</span><span class="si">}</span><span class="s">"</span><span class="p">:</span> <span class="n">prompt</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prompts</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">prompts</span> <span class="o">=</span> <span class="n">prompts</span>
        
        <span class="c1"># Store output directory
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Store batch name
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">batch_name</span> <span class="o">=</span> <span class="n">batch_name</span> <span class="ow">or</span> <span class="sa">f</span><span class="s">"batch_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span><span class="si">}</span><span class="s">"</span>
        
        <span class="c1"># Set default generation parameters if not specified
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">generation_params</span> <span class="o">=</span> <span class="n">generation_params</span> <span class="ow">or</span> <span class="p">{</span>
            <span class="s">"duration"</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
            <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s">"top_k"</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
            <span class="s">"top_p"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s">"cfg_coef"</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="p">}</span>
        
        <span class="c1"># Store configuration for metadata
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">batch_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"batch_name"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_name</span><span class="p">,</span>
            <span class="s">"model_type"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_type</span><span class="p">,</span>
            <span class="s">"model_size"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="p">,</span>
            <span class="s">"device"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">,</span>
            <span class="s">"prompt_count"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">prompts</span><span class="p">),</span>
            <span class="s">"generation_params"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">generation_params</span><span class="p">,</span>
            <span class="s">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Batch configured: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">prompts</span><span class="p">)</span><span class="si">}</span><span class="s"> prompts, output to </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progressive_save</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">"""
        Execute the batch generation process.
        
        Args:
            progressive_save (bool): Whether to save files as they're generated
                                   or all at once at the end
                                   
        Returns:
            list: Paths to generated files
        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Batch not configured. Call configure_batch first."</span><span class="p">)</span>
        
        <span class="c1"># Set generation parameters
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span>
            <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">generation_params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"duration"</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
            <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">generation_params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"temperature"</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="n">top_k</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">generation_params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"top_k"</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span>
            <span class="n">top_p</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">generation_params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"top_p"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="n">cfg_coef</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">generation_params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"cfg_coef"</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Prepare to store results
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">generated_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"config"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_config</span><span class="p">,</span>
            <span class="s">"generations"</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Track progress
</span>        <span class="n">total_prompts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">prompts</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Starting batch generation of </span><span class="si">{</span><span class="n">total_prompts</span><span class="si">}</span><span class="s"> audio samples..."</span><span class="p">)</span>
        
        <span class="c1"># Generate each prompt
</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">prompt_id</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">prompts</span><span class="p">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># Create safe filename
</span>            <span class="n">safe_id</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">"_"</span> <span class="k">else</span> <span class="s">"_"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prompt_id</span><span class="p">)</span>
            
            <span class="c1"># Display progress
</span>            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_prompts</span><span class="si">}</span><span class="s">] Generating </span><span class="si">{</span><span class="n">prompt_id</span><span class="si">}</span><span class="s">: '</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
            
            <span class="c1"># Generate audio
</span>            <span class="n">generation_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
            <span class="n">generation_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">generation_start</span>
            
            <span class="c1"># Create output path
</span>            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">safe_id</span><span class="p">)</span>
            
            <span class="c1"># Save the audio if progressive saving is enabled
</span>            <span class="k">if</span> <span class="n">progressive_save</span><span class="p">:</span>
                <span class="n">audio_write</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span>
                    <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
                    <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
                <span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav (</span><span class="si">{</span><span class="n">generation_time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s)"</span><span class="p">)</span>
            
            <span class="c1"># Store generation information
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">generated_files</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">"prompt_id"</span><span class="p">:</span> <span class="n">prompt_id</span><span class="p">,</span>
                <span class="s">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                <span class="s">"output_path"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">,</span>
                <span class="s">"wav_tensor"</span><span class="p">:</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">progressive_save</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="p">})</span>
            
            <span class="c1"># Store metadata
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">"generations"</span><span class="p">][</span><span class="n">prompt_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                <span class="s">"output_file"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">,</span>
                <span class="s">"generation_time"</span><span class="p">:</span> <span class="n">generation_time</span>
            <span class="p">}</span>
        
        <span class="c1"># Save any remaining files if not using progressive save
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">progressive_save</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Saving all generated files..."</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">generated_files</span><span class="p">:</span>
                <span class="n">audio_write</span><span class="p">(</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">"output_path"</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">item</span><span class="p">[</span><span class="s">"wav_tensor"</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
                    <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
                <span class="p">)</span>
                <span class="c1"># Clear tensor reference to free memory
</span>                <span class="n">item</span><span class="p">[</span><span class="s">"wav_tensor"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Calculate statistics
</span>        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">avg_time</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">/</span> <span class="n">total_prompts</span>
        
        <span class="c1"># Add statistics to metadata
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">"statistics"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"total_generation_time"</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
            <span class="s">"average_per_sample"</span><span class="p">:</span> <span class="n">avg_time</span><span class="p">,</span>
            <span class="s">"total_samples"</span><span class="p">:</span> <span class="n">total_prompts</span>
        <span class="p">}</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Batch generation complete!"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total time: </span><span class="si">{</span><span class="n">total_time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s, Average per sample: </span><span class="si">{</span><span class="n">avg_time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s"</span><span class="p">)</span>
        
        <span class="c1"># Return list of just the output paths for convenience
</span>        <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s">"output_path"</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">generated_files</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">create_documentation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Create comprehensive documentation for the batch generation.
        
        This includes:
        - README with batch overview
        - CSV listing of all generated files
        - JSON metadata file with all generation details
        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"No generation metadata available. Run execute first."</span><span class="p">)</span>
        
        <span class="c1"># Save complete metadata as JSON
</span>        <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"batch_metadata.json"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Create CSV listing for easy spreadsheet import
</span>        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"generation_listing.csv"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">""</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="c1"># Write header
</span>            <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">([</span><span class="s">"Prompt ID"</span><span class="p">,</span> <span class="s">"Prompt"</span><span class="p">,</span> <span class="s">"Output File"</span><span class="p">,</span> <span class="s">"Generation Time (s)"</span><span class="p">])</span>
            <span class="c1"># Write data
</span>            <span class="k">for</span> <span class="n">prompt_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">"generations"</span><span class="p">].</span><span class="n">items</span><span class="p">():</span>
                <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">([</span>
                    <span class="n">prompt_id</span><span class="p">,</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">"prompt"</span><span class="p">],</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">"output_file"</span><span class="p">]),</span>
                    <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s">'generation_time'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">"</span>
                <span class="p">])</span>
        
        <span class="c1"># Create README with batch overview
</span>        <span class="n">readme_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"README.txt"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"BATCH GENERATION: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">batch_name</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"="</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">batch_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">18</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Configuration summary
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"CONFIGURATION:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Model: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_type</span><span class="p">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Device: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Generation date: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">batch_config</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Total prompts: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">prompts</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Generation parameters
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"GENERATION PARAMETERS:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">generation_params</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Statistics
</span>            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">"statistics"</span><span class="p">]</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"STATISTICS:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Total generation time: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s">'total_generation_time'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> seconds</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Average time per sample: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s">'average_per_sample'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> seconds</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Total samples generated: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s">'total_samples'</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Files guide
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"FILES:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- *.wav: Generated audio files</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- batch_metadata.json: Complete generation metadata</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- generation_listing.csv: Spreadsheet-compatible listing of all files</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- README.txt: This file</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Documentation created:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">readme_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">metadata_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"readme"</span><span class="p">:</span> <span class="n">readme_path</span><span class="p">,</span>
            <span class="s">"csv"</span><span class="p">:</span> <span class="n">csv_path</span><span class="p">,</span>
            <span class="s">"metadata"</span><span class="p">:</span> <span class="n">metadata_path</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>The pipeline approach offers several advantages:</p>
<ul>
  <li>Modular design with clear separation of concerns</li>
  <li>Easier to extend and customize for different workflows</li>
  <li>Better organization with built-in documentation generation</li>
  <li>Cleaner error handling and resource management</li>
</ul>

<h2 id="implementing-systematic-variation-experiments">Implementing Systematic Variation Experiments</h2>

<p>One common use case for batch processing is conducting systematic variation experiments to explore how different parameters and prompts affect generation results. Let’s implement a framework specifically designed for this purpose:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># variation_experiments.py
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">audiocraft.models</span> <span class="kn">import</span> <span class="n">MusicGen</span><span class="p">,</span> <span class="n">AudioGen</span>
<span class="kn">from</span> <span class="nn">audiocraft.data.audio</span> <span class="kn">import</span> <span class="n">audio_write</span>

<span class="k">class</span> <span class="nc">VariationExperiment</span><span class="p">:</span>
    <span class="s">"""
    Framework for conducting systematic audio generation variation experiments.
    
    This class allows you to explore how different parameters and prompt
    formulations affect generation results through structured experiments.
    
    Key features:
    - Experiment definition with control variables and experimental variables
    - Automated generation of all experiment conditions
    - Structured output organization
    - Comprehensive experiment documentation
    - Built-in visualization capabilities
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s">"music"</span><span class="p">,</span> <span class="n">model_size</span><span class="o">=</span><span class="s">"small"</span><span class="p">,</span> <span class="n">base_output_dir</span><span class="o">=</span><span class="s">"experiments"</span><span class="p">):</span>
        <span class="s">"""
        Initialize a new variation experiment.
        
        Args:
            name (str): Name of the experiment
            model_type (str): Type of model to use ("music" or "audio")
            model_size (str): Size of model to use
            base_output_dir (str): Base directory for all experiments
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">model_size</span>
        
        <span class="c1"># Create timestamp for this experiment
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y%m%d_%H%M%S"</span><span class="p">)</span>
        
        <span class="c1"># Create a unique experiment directory
</span>        <span class="n">safe_name</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">"_"</span> <span class="k">else</span> <span class="s">"_"</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Initialize model
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_initialize_model</span><span class="p">()</span>
        
        <span class="c1"># Experiment definition (to be set by configure methods)
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">control_variables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Results storage
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">_initialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Load the appropriate model and move to the best available device."""</span>
        <span class="c1"># Determine the best available device
</span>        <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"mps"</span>
        <span class="k">elif</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"cpu"</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Loading </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_type</span><span class="si">}</span><span class="s"> model (</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="si">}</span><span class="s">) on </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="si">}</span><span class="s">..."</span><span class="p">)</span>
        
        <span class="c1"># Load the appropriate model
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s">"music"</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MusicGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AudioGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_control_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">"""
        Set control variables that remain constant throughout the experiment.
        
        Args:
            **kwargs: Control variables as keyword arguments
                     (e.g., duration=5.0, top_k=250)
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">control_variables</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">set_experiment_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">"""
        Set experiment variables that will be systematically varied.
        
        Args:
            **kwargs: Variables as keyword arguments mapping to lists of values
                     (e.g., temperature=[0.5, 1.0, 1.5], prompt=["A", "B", "C"])
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">design_full_factorial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Create a full factorial design testing all combinations of experiment variables.
        
        This creates all possible combinations of the experiment variables,
        resulting in a comprehensive but potentially large experiment.
        """</span>
        <span class="kn">import</span> <span class="nn">itertools</span>
        
        <span class="c1"># Verify we have experiment variables
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"No experiment variables defined. Use set_experiment_variables first."</span><span class="p">)</span>
        
        <span class="c1"># Get variable names and values
</span>        <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">]</span>
        
        <span class="c1"># Generate all combinations
</span>        <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">var_values</span><span class="p">))</span>
        
        <span class="c1"># Create experiment design
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">combination</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">):</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">"condition_id"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"condition_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">03</span><span class="n">d</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
                <span class="s">"variables"</span><span class="p">:</span> <span class="p">{</span><span class="n">var_names</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> <span class="n">combination</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">))}</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Designed full factorial experiment with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span><span class="p">)</span><span class="si">}</span><span class="s"> conditions"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">design_one_factor_at_a_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Create a one-factor-at-a-time design.
        
        This varies each experiment variable independently while keeping others
        at their base values, resulting in a more manageable experiment size.
        
        Args:
            base_values (dict): Base values for each variable when not being varied
                               If not provided, first value of each variable is used
        """</span>
        <span class="c1"># Verify we have experiment variables
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"No experiment variables defined. Use set_experiment_variables first."</span><span class="p">)</span>
        
        <span class="c1"># Use first value as base value if not specified
</span>        <span class="k">if</span> <span class="n">base_values</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">base_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">.</span><span class="n">items</span><span class="p">()}</span>
        
        <span class="c1"># Create experiment design
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">condition_counter</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Add baseline condition with all variables at base values
</span>        <span class="n">baseline</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"condition_id"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"baseline"</span><span class="p">,</span>
            <span class="s">"variables"</span><span class="p">:</span> <span class="n">base_values</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
        
        <span class="c1"># For each variable, create conditions varying only that variable
</span>        <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="c1"># Skip if this is the base value (already in baseline condition)
</span>                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">base_values</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Create a condition varying just this variable
</span>                <span class="n">variables</span> <span class="o">=</span> <span class="n">base_values</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                
                <span class="n">condition</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">"condition_id"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"condition_</span><span class="si">{</span><span class="n">condition_counter</span><span class="p">:</span><span class="mi">03</span><span class="n">d</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
                    <span class="s">"variables"</span><span class="p">:</span> <span class="n">variables</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
                <span class="n">condition_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Designed one-factor-at-a-time experiment with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span><span class="p">)</span><span class="si">}</span><span class="s"> conditions"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">run_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Execute the designed experiment by generating audio for all conditions.
        
        Returns:
            dict: Experiment results
        """</span>
        <span class="c1"># Verify we have a design
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"No experiment design. Use a design_* method first."</span><span class="p">)</span>
        
        <span class="c1"># Create results structure
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"experiment_name"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s">"timestamp"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="s">"model_type"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_type</span><span class="p">,</span>
            <span class="s">"model_size"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="p">,</span>
            <span class="s">"device"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">,</span>
            <span class="s">"control_variables"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">control_variables</span><span class="p">,</span>
            <span class="s">"experiment_variables"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">,</span>
            <span class="s">"conditions"</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Create conditions directory
</span>        <span class="n">conditions_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="s">"conditions"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">conditions_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Set control variables in generation parameters
</span>        <span class="n">base_params</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">control_variables</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Run each experimental condition
</span>        <span class="n">total_conditions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_design</span><span class="p">):</span>
            <span class="n">condition_id</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="s">"condition_id"</span><span class="p">]</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="s">"variables"</span><span class="p">]</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_conditions</span><span class="si">}</span><span class="s">] Running condition: </span><span class="si">{</span><span class="n">condition_id</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Create directory for this condition
</span>            <span class="n">condition_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions_dir</span><span class="p">,</span> <span class="n">condition_id</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">condition_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="c1"># Save condition details
</span>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">condition_dir</span><span class="p">,</span> <span class="s">"condition.json"</span><span class="p">),</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">({</span>
                    <span class="s">"condition_id"</span><span class="p">:</span> <span class="n">condition_id</span><span class="p">,</span>
                    <span class="s">"variables"</span><span class="p">:</span> <span class="n">variables</span><span class="p">,</span>
                    <span class="s">"control_variables"</span><span class="p">:</span> <span class="n">base_params</span>
                <span class="p">},</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="c1"># Extract prompt and other generation parameters
</span>            <span class="n">prompt</span> <span class="o">=</span> <span class="n">variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"prompt"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
            <span class="n">generation_params</span> <span class="o">=</span> <span class="n">base_params</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="c1"># Update generation parameters with experimental variables
</span>            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">var_name</span> <span class="o">!=</span> <span class="s">"prompt"</span><span class="p">:</span>  <span class="c1"># Handle prompt separately
</span>                    <span class="n">generation_params</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
            <span class="c1"># Set duration separately as it's a special parameter
</span>            <span class="n">duration</span> <span class="o">=</span> <span class="n">generation_params</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"duration"</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
            
            <span class="c1"># Set generation parameters
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">generation_params</span><span class="p">.</span><span class="n">items</span><span class="p">()</span> 
                   <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"temperature"</span><span class="p">,</span> <span class="s">"top_k"</span><span class="p">,</span> <span class="s">"top_p"</span><span class="p">,</span> <span class="s">"cfg_coef"</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="c1"># Generate audio
</span>            <span class="n">start_generate</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">wav</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
            <span class="n">generation_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_generate</span>
            
            <span class="c1"># Save the audio
</span>            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">condition_dir</span><span class="p">,</span> <span class="s">"output"</span><span class="p">)</span>
            <span class="n">audio_write</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span>
                <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
            <span class="p">)</span>
            
            <span class="c1"># Record results
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">"conditions"</span><span class="p">][</span><span class="n">condition_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">"variables"</span><span class="p">:</span> <span class="n">variables</span><span class="p">,</span>
                <span class="s">"output_file"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">,</span>
                <span class="s">"generation_time"</span><span class="p">:</span> <span class="n">generation_time</span>
            <span class="p">}</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Generated in </span><span class="si">{</span><span class="n">generation_time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s"</span><span class="p">)</span>
        
        <span class="c1"># Calculate total experiment time
</span>        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">"total_experiment_time"</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_time</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">"average_generation_time"</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">/</span> <span class="n">total_conditions</span>
        
        <span class="c1"># Save complete results
</span>        <span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="s">"experiment_results.json"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Experiment complete! </span><span class="si">{</span><span class="n">total_conditions</span><span class="si">}</span><span class="s"> conditions in </span><span class="si">{</span><span class="n">total_time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Results saved to </span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">create_experiment_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Create a comprehensive report of the experiment.
        
        This includes README, CSV listing, and visualizations.
        
        Returns:
            dict: Paths to report files
        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"No results available. Run the experiment first."</span><span class="p">)</span>
        
        <span class="n">report_files</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Create README with experiment overview
</span>        <span class="n">readme_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="s">"README.txt"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"EXPERIMENT: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"="</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Basic info
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"OVERVIEW:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Date: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Model: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_type</span><span class="p">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Device: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Conditions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">'conditions'</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Total time: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">'total_experiment_time'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Control variables
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"CONTROL VARIABLES:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">control_variables</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Experiment variables
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"EXPERIMENT VARIABLES:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Directory structure
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"DIRECTORY STRUCTURE:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- conditions/: Contains subdirectories for each experimental condition</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- conditions/*/output.wav: Generated audio for each condition</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- conditions/*/condition.json: Details of each condition</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- experiment_results.json: Complete experiment results</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- conditions.csv: CSV listing of all conditions</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">"prompt"</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- prompt_comparison.png: Visualization of prompt variations</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">"temperature"</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- temperature_comparison.png: Visualization of temperature variations</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        
        <span class="n">report_files</span><span class="p">[</span><span class="s">"readme"</span><span class="p">]</span> <span class="o">=</span> <span class="n">readme_path</span>
        
        <span class="c1"># Create CSV listing
</span>        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="s">"conditions.csv"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">""</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># Determine all possible variable columns
</span>            <span class="n">all_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">"conditions"</span><span class="p">].</span><span class="n">values</span><span class="p">():</span>
                <span class="n">all_vars</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="s">"variables"</span><span class="p">].</span><span class="n">keys</span><span class="p">())</span>
            
            <span class="c1"># Create CSV writer with dynamic columns
</span>            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Condition ID"</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_vars</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s">"Output File"</span><span class="p">,</span> <span class="s">"Generation Time (s)"</span><span class="p">]</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            
            <span class="c1"># Write each condition
</span>            <span class="k">for</span> <span class="n">condition_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">"conditions"</span><span class="p">].</span><span class="n">items</span><span class="p">():</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">condition_id</span><span class="p">]</span>
                
                <span class="c1"># Add each variable's value (or blank if not used in this condition)
</span>                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">"variables"</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span>
                
                <span class="c1"># Add output file and generation time
</span>                <span class="n">row</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">"output_file"</span><span class="p">]))</span>
                <span class="n">row</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s">'generation_time'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                
                <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        
        <span class="n">report_files</span><span class="p">[</span><span class="s">"csv"</span><span class="p">]</span> <span class="o">=</span> <span class="n">csv_path</span>
        
        <span class="c1"># Create visualizations if applicable
</span>        <span class="k">if</span> <span class="s">"temperature"</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_create_temperature_visualization</span><span class="p">()</span>
            <span class="n">report_files</span><span class="p">[</span><span class="s">"temperature_viz"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="s">"temperature_comparison.png"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s">"prompt"</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">[</span><span class="s">"prompt"</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_create_prompt_comparison</span><span class="p">()</span>
            <span class="n">report_files</span><span class="p">[</span><span class="s">"prompt_viz"</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="s">"prompt_comparison.png"</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Experiment report created!"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report_files</span>
    
    <span class="k">def</span> <span class="nf">_create_temperature_visualization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Create visualization of generation time vs temperature."""</span>
        <span class="k">if</span> <span class="s">"temperature"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Collect temperature and generation time data
</span>        <span class="n">temps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">"conditions"</span><span class="p">].</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">"temperature"</span> <span class="ow">in</span> <span class="n">condition</span><span class="p">[</span><span class="s">"variables"</span><span class="p">]:</span>
                <span class="n">temps</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="s">"variables"</span><span class="p">][</span><span class="s">"temperature"</span><span class="p">])</span>
                <span class="n">times</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="s">"generation_time"</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">temps</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Create the visualization
</span>        <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="s">'b--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Effect of Temperature on Generation Time"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"Temperature"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"Generation Time (seconds)"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Add annotations
</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="n">times</span><span class="p">)):</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s"</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="s">"offset points"</span>
            <span class="p">)</span>
        
        <span class="c1"># Save the figure
</span>        <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="s">"temperature_comparison.png"</span><span class="p">))</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_create_prompt_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Create visual comparison of different prompts."""</span>
        <span class="k">if</span> <span class="s">"prompt"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Limit to reasonable number of prompts
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_variables</span><span class="p">[</span><span class="s">"prompt"</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Collect prompt and generation time data
</span>        <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">results</span><span class="p">[</span><span class="s">"conditions"</span><span class="p">].</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">"prompt"</span> <span class="ow">in</span> <span class="n">condition</span><span class="p">[</span><span class="s">"variables"</span><span class="p">]:</span>
                <span class="c1"># Get shortened prompt for display
</span>                <span class="n">prompt</span> <span class="o">=</span> <span class="n">condition</span><span class="p">[</span><span class="s">"variables"</span><span class="p">][</span><span class="s">"prompt"</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">[:</span><span class="mi">27</span><span class="p">]</span> <span class="o">+</span> <span class="s">"..."</span>
                
                <span class="n">prompts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">times</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="s">"generation_time"</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prompts</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Create the visualization
</span>        <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)),</span> <span class="n">times</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Generation Time by Prompt"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">"Prompt"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"Generation Time (seconds)"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)),</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">"right"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s">"y"</span><span class="p">)</span>
        
        <span class="c1"># Add time labels
</span>        <span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">bar</span><span class="p">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="p">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">bar</span><span class="p">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s"</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s">"center"</span>
            <span class="p">)</span>
        
        <span class="c1"># Save the figure
</span>        <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="s">"prompt_comparison.png"</span><span class="p">))</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>This framework provides a scientific approach to exploring variations:</p>

<ol>
  <li>Precise control of experimental variables</li>
  <li>Multiple experimental design options (full factorial, one-factor-at-a-time)</li>
  <li>Comprehensive documentation with visualizations</li>
  <li>Clear organization of experimental conditions</li>
</ol>

<h2 id="building-an-audio-generation-automation-system">Building an Audio Generation Automation System</h2>

<p>Now let’s create a complete automation system for large-scale audio generation:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># audio_generation_automation.py
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">audiocraft.models</span> <span class="kn">import</span> <span class="n">MusicGen</span><span class="p">,</span> <span class="n">AudioGen</span>
<span class="kn">from</span> <span class="nn">audiocraft.data.audio</span> <span class="kn">import</span> <span class="n">audio_write</span>

<span class="k">class</span> <span class="nc">GenerationJob</span><span class="p">:</span>
    <span class="s">"""
    Represents a single generation job with all required parameters.
    
    This class encapsulates all the information needed to generate a single
    audio sample, making it easy to queue and track jobs in a batch system.
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="s">"""
        Initialize a generation job.
        
        Args:
            job_id (str): Unique identifier for this job
            prompt (str): Text prompt for generation
            output_dir (str): Directory to save output
            **params: Generation parameters (duration, temperature, etc.)
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">prompt</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        
        <span class="c1"># Set default parameter values if not provided
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"duration"</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"temperature"</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"top_k"</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"top_p"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">"cfg_coef"</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
        
        <span class="c1"># Track job status
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">"queued"</span>  <span class="c1"># queued, running, completed, failed
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Convert job to dictionary representation for serialization."""</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"job_id"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">job_id</span><span class="p">,</span>
            <span class="s">"prompt"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span>
            <span class="s">"output_dir"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="s">"params"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">params</span><span class="p">,</span>
            <span class="s">"status"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s">"start_time"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="s">"end_time"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">end_time</span><span class="p">,</span>
            <span class="s">"duration"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">start_time</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">end_time</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">"output_file"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">output_file</span><span class="p">,</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">error</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">GenerationWorker</span><span class="p">:</span>
    <span class="s">"""
    Worker that processes generation jobs from a queue.
    
    This worker runs in a separate thread to generate audio samples
    based on job specifications from a queue.
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">job_queue</span><span class="p">,</span> <span class="n">results_queue</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">model_size</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="s">"""
        Initialize a generation worker.
        
        Args:
            worker_id (int): Unique identifier for this worker
            job_queue (Queue): Queue to get jobs from
            results_queue (Queue): Queue to put results in
            model_type (str): Type of model to use ("music" or "audio")
            model_size (str): Size of model to use
            device (str): Device to run model on
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">worker_id</span> <span class="o">=</span> <span class="n">worker_id</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span> <span class="o">=</span> <span class="n">job_queue</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">results_queue</span> <span class="o">=</span> <span class="n">results_queue</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">model_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        
        <span class="c1"># Initialize model
</span>        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s">"music"</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MusicGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AudioGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Control flags
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">thread</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Start the worker thread."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_worker_loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Stop the worker thread."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_worker_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Main worker loop that processes jobs from the queue."""</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Worker </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s"> started on </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="si">}</span><span class="s"> using </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_type</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get job from queue with timeout to allow checking running flag
</span>                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                
                <span class="c1"># Process the job
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">_process_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                
                <span class="c1"># Mark job as done in queue
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span><span class="p">.</span><span class="n">task_done</span><span class="p">()</span>
                
            <span class="k">except</span> <span class="n">queue</span><span class="p">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="c1"># No jobs available, continue loop
</span>                <span class="k">continue</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Log error but keep worker alive
</span>                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Worker </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s"> encountered error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">continue</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Worker </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s"> stopped"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_process_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="s">"""
        Process a single generation job.
        
        Args:
            job (GenerationJob): Job to process
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Worker </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s"> processing job </span><span class="si">{</span><span class="n">job</span><span class="p">.</span><span class="n">job_id</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Update job status
</span>            <span class="n">job</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">"running"</span>
            <span class="n">job</span><span class="p">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="c1"># Ensure output directory exists
</span>            <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
            <span class="c1"># Extract parameters
</span>            <span class="n">duration</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"duration"</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
            
            <span class="c1"># Set generation parameters
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">job</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"temperature"</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">top_k</span><span class="o">=</span><span class="n">job</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"top_k"</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span>
                <span class="n">top_p</span><span class="o">=</span><span class="n">job</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"top_p"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                <span class="n">cfg_coef</span><span class="o">=</span><span class="n">job</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"cfg_coef"</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="c1"># Generate audio
</span>            <span class="n">wav</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">job</span><span class="p">.</span><span class="n">prompt</span><span class="p">])</span>
            
            <span class="c1"># Save output
</span>            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">job</span><span class="p">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="n">audio_write</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span>
                <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
            <span class="p">)</span>
            
            <span class="c1"># Update job status
</span>            <span class="n">job</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">"completed"</span>
            <span class="n">job</span><span class="p">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">job</span><span class="p">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span>
            
            <span class="c1"># Put result in results queue
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">results_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Worker </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s"> completed job </span><span class="si">{</span><span class="n">job</span><span class="p">.</span><span class="n">job_id</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">job</span><span class="p">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">job</span><span class="p">.</span><span class="n">start_time</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s)"</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Update job status on error
</span>            <span class="n">job</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">"failed"</span>
            <span class="n">job</span><span class="p">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">job</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            
            <span class="c1"># Put failed job in results queue
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">results_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Worker </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">worker_id</span><span class="si">}</span><span class="s"> failed job </span><span class="si">{</span><span class="n">job</span><span class="p">.</span><span class="n">job_id</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GenerationAutomationSystem</span><span class="p">:</span>
    <span class="s">"""
    Complete system for automating large-scale audio generation tasks.
    
    This system manages the entire generation workflow:
    - Loading and managing jobs from various sources
    - Running multiple workers to process jobs concurrently
    - Tracking job progress and results
    - Organizing and documenting output
    - Handling errors and retries
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_output_dir</span><span class="o">=</span><span class="s">"automated_generation"</span><span class="p">):</span>
        <span class="s">"""
        Initialize the automation system.
        
        Args:
            base_output_dir (str): Base directory for all generation output
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">base_output_dir</span> <span class="o">=</span> <span class="n">base_output_dir</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base_output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Create session timestamp and directory
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"session_</span><span class="si">{</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y%m%d_%H%M%S'</span><span class="p">)</span><span class="si">}</span><span class="s">"</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">session_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_output_dir</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">session_id</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Create log directory
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="s">"logs"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Create output directory
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="s">"output"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Initialize queues
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">results_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>
        
        <span class="c1"># Initialize workers list
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Job tracking
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">failed_jobs</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Status flags
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">result_thread</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">add_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Add a single generation job to the queue.
        
        Args:
            prompt (str): Text prompt for generation
            params (dict): Generation parameters
            job_id (str): Optional job ID (generated if not provided)
            
        Returns:
            str: Job ID
        """</span>
        <span class="c1"># Generate job ID if not provided
</span>        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"job_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="mi">06</span><span class="n">d</span><span class="si">}</span><span class="s">"</span>
        
        <span class="c1"># Create job output directory
</span>        <span class="n">job_output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
        
        <span class="c1"># Create the job
</span>        <span class="n">job</span> <span class="o">=</span> <span class="n">GenerationJob</span><span class="p">(</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">job_output_dir</span><span class="p">,</span>
            <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="p">)</span>
        
        <span class="c1"># Add to tracking
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
        
        <span class="c1"># Add to queue if system is running
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">job_id</span>
    
    <span class="k">def</span> <span class="nf">add_jobs_from_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">common_params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Add multiple jobs from a list of prompts.
        
        Args:
            prompts (list): List of prompt strings
            common_params (dict): Parameters to use for all jobs
            
        Returns:
            list: List of job IDs
        """</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prompts</span><span class="p">):</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"job_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="mi">06</span><span class="n">d</span><span class="si">}</span><span class="s">"</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">common_params</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
            <span class="n">job_ids</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">job_ids</span>
    
    <span class="k">def</span> <span class="nf">add_jobs_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">prompt_column</span><span class="o">=</span><span class="s">"prompt"</span><span class="p">,</span> <span class="n">params_columns</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Add jobs from a CSV file.
        
        Args:
            csv_file (str): Path to CSV file
            prompt_column (str): Name of column containing prompts
            params_columns (list): Names of columns containing parameters
            
        Returns:
            list: List of job IDs
        """</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">""</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
                <span class="c1"># Extract prompt
</span>                <span class="k">if</span> <span class="n">prompt_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Warning: Row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> missing prompt column '</span><span class="si">{</span><span class="n">prompt_column</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="n">prompt</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">prompt_column</span><span class="p">]</span>
                
                <span class="c1"># Extract parameters if specified
</span>                <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">params_columns</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_columns</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                            <span class="c1"># Try to convert numeric values appropriately
</span>                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                                <span class="c1"># Convert to int if it's a whole number
</span>                                <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="n">is_integer</span><span class="p">():</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                                <span class="c1"># Keep as string if not numeric
</span>                                <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                
                <span class="c1"># Add the job
</span>                <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"job_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="mi">06</span><span class="n">d</span><span class="si">}</span><span class="s">"</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
                <span class="n">job_ids</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">job_ids</span>
    
    <span class="k">def</span> <span class="nf">add_jobs_from_variations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_prompt</span><span class="p">,</span> <span class="n">variations</span><span class="p">,</span> <span class="n">common_params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Add jobs from text variations of a base prompt.
        
        Args:
            base_prompt (str): Base prompt template with {var} placeholders
            variations (dict): Dictionary mapping variables to lists of values
            common_params (dict): Parameters to use for all jobs
            
        Returns:
            list: List of job IDs
        """</span>
        <span class="kn">import</span> <span class="nn">itertools</span>
        
        <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Get all variable names and possible values
</span>        <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">variations</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">variations</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">]</span>
        
        <span class="c1"># Generate all combinations
</span>        <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">var_values</span><span class="p">))</span>
        
        <span class="c1"># Generate a job for each combination
</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">combination</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">):</span>
            <span class="c1"># Create variable dictionary for this combination
</span>            <span class="n">vars_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">var_names</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> <span class="n">combination</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">))}</span>
            
            <span class="c1"># Format the prompt with these variables
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="n">base_prompt</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="o">**</span><span class="n">vars_dict</span><span class="p">)</span>
                
                <span class="c1"># Add the job
</span>                <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"job_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="mi">06</span><span class="n">d</span><span class="si">}</span><span class="s">"</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">common_params</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
                <span class="n">job_ids</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="nb">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Warning: Missing variable in prompt template: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="n">job_ids</span>
    
    <span class="k">def</span> <span class="nf">start_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s">"music"</span><span class="p">,</span> <span class="n">model_size</span><span class="o">=</span><span class="s">"small"</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Start worker threads to process the job queue.
        
        Args:
            num_workers (int): Number of worker threads to start
            model_type (str): Type of model to use
            model_size (str): Size of model to use
            devices (list): List of devices to use. If None, will automatically select.
                          If fewer devices than workers, will cycle through available devices.
            
        Returns:
            bool: True if workers started successfully
        """</span>
        <span class="c1"># Determine devices if not specified
</span>        <span class="k">if</span> <span class="n">devices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Use all available CUDA devices
</span>                <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s">"cuda:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">device_count</span><span class="p">())]</span>
            <span class="k">elif</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="c1"># Use MPS (Apple Silicon)
</span>                <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="s">"mps"</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fall back to CPU
</span>                <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="s">"cpu"</span><span class="p">]</span>
        
        <span class="c1"># Make sure we have at least one device
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">devices</span><span class="p">:</span>
            <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="s">"cpu"</span><span class="p">]</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Starting </span><span class="si">{</span><span class="n">num_workers</span><span class="si">}</span><span class="s"> workers on devices: </span><span class="si">{</span><span class="n">devices</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Create and start workers
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_workers</span><span class="p">):</span>
            <span class="c1"># Select device (cycling through available devices)
</span>            <span class="n">device</span> <span class="o">=</span> <span class="n">devices</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">)]</span>
            
            <span class="c1"># Create worker
</span>            <span class="n">worker</span> <span class="o">=</span> <span class="n">GenerationWorker</span><span class="p">(</span>
                <span class="n">worker_id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">job_queue</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span><span class="p">,</span>
                <span class="n">results_queue</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">results_queue</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span>
                <span class="n">model_size</span><span class="o">=</span><span class="n">model_size</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device</span>
            <span class="p">)</span>
            
            <span class="c1"># Add to workers list
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">workers</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
            
            <span class="c1"># Start the worker
</span>            <span class="n">worker</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c1"># Start result processing thread
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">result_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_process_results</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">result_thread</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">result_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c1"># Add all tracked jobs to the queue
</span>        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">job</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">"queued"</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">_process_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Process completed jobs from the results queue."""</span>
        <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get result from queue with timeout
</span>                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">results_queue</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                
                <span class="c1"># Process the result
</span>                <span class="k">if</span> <span class="n">job</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">"completed"</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">[</span><span class="n">job</span><span class="p">.</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">"failed"</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">job</span><span class="p">.</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
                
                <span class="c1"># Mark as done in queue
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">results_queue</span><span class="p">.</span><span class="n">task_done</span><span class="p">()</span>
                
                <span class="c1"># Save intermediate progress periodically
</span>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">_save_progress</span><span class="p">()</span>
                
            <span class="k">except</span> <span class="n">queue</span><span class="p">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="c1"># No results available, continue loop
</span>                <span class="k">continue</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Log error but keep thread alive
</span>                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error processing results: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">continue</span>
    
    <span class="k">def</span> <span class="nf">_save_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Save current progress to log file."""</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="s">"progress.json"</span><span class="p">)</span>
        
        <span class="n">progress</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"session_id"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="s">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">),</span>
            <span class="s">"total_jobs"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">),</span>
            <span class="s">"completed_jobs"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">),</span>
            <span class="s">"failed_jobs"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">failed_jobs</span><span class="p">),</span>
            <span class="s">"queued_jobs"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">failed_jobs</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">wait_until_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress_interval</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
        <span class="s">"""
        Wait until all jobs are processed.
        
        Args:
            progress_interval (float): Interval in seconds to print progress updates
            
        Returns:
            dict: Summary of processing results
        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"System is not running. Start workers first."</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="n">last_update</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">total_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">)</span>
        
        <span class="c1"># Wait for queue to be empty
</span>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">job_queue</span><span class="p">.</span><span class="n">unfinished_tasks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Print progress update at specified interval
</span>            <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_update</span> <span class="o">&gt;</span> <span class="n">progress_interval</span><span class="p">:</span>
                <span class="n">completed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">)</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">failed_jobs</span><span class="p">)</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">total_jobs</span> <span class="o">-</span> <span class="n">completed</span> <span class="o">-</span> <span class="n">failed</span>
                
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Progress: </span><span class="si">{</span><span class="n">completed</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_jobs</span><span class="si">}</span><span class="s"> completed, </span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s"> failed, </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s"> remaining"</span><span class="p">)</span>
                <span class="n">last_update</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="c1"># Small sleep to prevent CPU spinning
</span>            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c1"># Final progress update
</span>        <span class="n">completed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">)</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">failed_jobs</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"All jobs processed: </span><span class="si">{</span><span class="n">completed</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_jobs</span><span class="si">}</span><span class="s"> completed, </span><span class="si">{</span><span class="n">failed</span><span class="si">}</span><span class="s"> failed"</span><span class="p">)</span>
        
        <span class="c1"># Create summary
</span>        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"session_id"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="s">"total_jobs"</span><span class="p">:</span> <span class="n">total_jobs</span><span class="p">,</span>
            <span class="s">"completed_jobs"</span><span class="p">:</span> <span class="n">completed</span><span class="p">,</span>
            <span class="s">"failed_jobs"</span><span class="p">:</span> <span class="n">failed</span><span class="p">,</span>
            <span class="s">"session_dir"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">session_dir</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">summary</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Stop all workers and the result processing thread."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="c1"># Stop workers
</span>        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="n">worker</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
        
        <span class="c1"># Wait for result thread to finish
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">result_thread</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">result_thread</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        
        <span class="c1"># Clear workers list
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">print</span><span class="p">(</span><span class="s">"System stopped"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">create_final_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Create a comprehensive final report of the generation session.
        
        Returns:
            dict: Paths to report files
        """</span>
        <span class="n">report_files</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Create summary file
</span>        <span class="n">summary_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="s">"summary.json"</span><span class="p">)</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"session_id"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
            <span class="s">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">),</span>
            <span class="s">"total_jobs"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">),</span>
            <span class="s">"completed_jobs"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">),</span>
            <span class="s">"failed_jobs"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">failed_jobs</span><span class="p">),</span>
            <span class="s">"completion_rate"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">jobs</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
        
        <span class="c1"># Calculate statistics if we have completed jobs
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">:</span>
            <span class="c1"># Calculate timing statistics
</span>            <span class="n">durations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">completed_jobs</span><span class="p">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="n">job</span><span class="p">.</span><span class="n">end_time</span><span class="p">:</span>
                    <span class="n">durations</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">job</span><span class="p">.</span><span class="n">start_time</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">durations</span><span class="p">:</span>
                <span class="n">summary</span><span class="p">[</span><span class="s">"timing"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">"average_duration"</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">durations</span><span class="p">),</span>
                    <span class="s">"min_duration"</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">durations</span><span class="p">),</span>
                    <span class="s">"max_duration"</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">durations</span><span class="p">),</span>
                    <span class="s">"total_processing_time"</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span>
                <span class="p">}</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">summary_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">report_files</span><span class="p">[</span><span class="s">"summary"</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_path</span>
        
        <span class="c1"># Create CSV listings of jobs
</span>        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="s">"jobs.csv"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">""</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
            <span class="c1"># Write header
</span>            <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">([</span>
                <span class="s">"Job ID"</span><span class="p">,</span> <span class="s">"Status"</span><span class="p">,</span> <span class="s">"Prompt"</span><span class="p">,</span> <span class="s">"Duration (s)"</span><span class="p">,</span> 
                <span class="s">"Output File"</span><span class="p">,</span> <span class="s">"Error"</span><span class="p">,</span> <span class="s">"Temperature"</span><span class="p">,</span> <span class="s">"Top-k"</span><span class="p">,</span> <span class="s">"Top-p"</span>
            <span class="p">])</span>
            
            <span class="c1"># Write all jobs
</span>            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">jobs</span><span class="p">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="n">job</span><span class="p">.</span><span class="n">end_time</span><span class="p">:</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="n">job</span><span class="p">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">job</span><span class="p">.</span><span class="n">start_time</span>
                
                <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">([</span>
                    <span class="n">job</span><span class="p">.</span><span class="n">job_id</span><span class="p">,</span>
                    <span class="n">job</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="n">job</span><span class="p">.</span><span class="n">prompt</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s">"..."</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">prompt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="n">job</span><span class="p">.</span><span class="n">prompt</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">duration</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">"</span> <span class="k">if</span> <span class="n">duration</span> <span class="k">else</span> <span class="s">""</span><span class="p">,</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">output_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">job</span><span class="p">.</span><span class="n">output_file</span> <span class="k">else</span> <span class="s">""</span><span class="p">,</span>
                    <span class="n">job</span><span class="p">.</span><span class="n">error</span> <span class="ow">or</span> <span class="s">""</span><span class="p">,</span>
                    <span class="n">job</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"temperature"</span><span class="p">,</span> <span class="s">""</span><span class="p">),</span>
                    <span class="n">job</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"top_k"</span><span class="p">,</span> <span class="s">""</span><span class="p">),</span>
                    <span class="n">job</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"top_p"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
                <span class="p">])</span>
        
        <span class="n">report_files</span><span class="p">[</span><span class="s">"csv"</span><span class="p">]</span> <span class="o">=</span> <span class="n">csv_path</span>
        
        <span class="c1"># Create README with session overview
</span>        <span class="n">readme_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="s">"README.txt"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme_path</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"GENERATION SESSION: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">session_id</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"="</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">session_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">19</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Basic statistics
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"SESSION SUMMARY:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Total jobs: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s">'total_jobs'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Completed: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s">'completed_jobs'</span><span class="p">]</span><span class="si">}</span><span class="s"> "</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"(</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s">'completion_rate'</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">:.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%)</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Failed: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s">'failed_jobs'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s">"timing"</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">TIMING INFORMATION:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Average generation time: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s">'timing'</span><span class="p">][</span><span class="s">'average_duration'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Minimum time: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s">'timing'</span><span class="p">][</span><span class="s">'min_duration'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Maximum time: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s">'timing'</span><span class="p">][</span><span class="s">'max_duration'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- Total processing time: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s">'timing'</span><span class="p">][</span><span class="s">'total_processing_time'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">DIRECTORY STRUCTURE:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- output/: Contains all generated audio files</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- output/{job_id}/: Job-specific output directories</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- logs/: Log files and progress tracking</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- summary.json: Complete session summary</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- jobs.csv: CSV listing of all jobs</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">NOTES:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Failed jobs can be found in jobs.csv with status 'failed'</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Each job output directory contains the generated audio</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        
        <span class="n">report_files</span><span class="p">[</span><span class="s">"readme"</span><span class="p">]</span> <span class="o">=</span> <span class="n">readme_path</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Final report created:"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">report_files</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">report_files</span>
</code></pre></div></div>

<p>This automation system provides everything needed for large-scale production:</p>

<ol>
  <li><strong>Comprehensive job management</strong>: Add jobs individually, from lists, CSV files, or by generating variations</li>
  <li><strong>Multi-worker processing</strong>: Uses multiple workers across available devices</li>
  <li><strong>Progress tracking</strong>: Live updates on job status</li>
  <li><strong>Error handling</strong>: Robust error tracking and reporting</li>
  <li><strong>Detailed documentation</strong>: Comprehensive reports and logs</li>
</ol>

<h2 id="automated-testing-and-quality-control">Automated Testing and Quality Control</h2>

<p>For production applications, it’s important to have automated testing and quality control. Here’s a framework for implementing this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># audio_quality_control.py
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchaudio</span>
<span class="kn">from</span> <span class="nn">audiocraft.models</span> <span class="kn">import</span> <span class="n">MusicGen</span>
<span class="kn">from</span> <span class="nn">audiocraft.data.audio</span> <span class="kn">import</span> <span class="n">audio_write</span>

<span class="k">class</span> <span class="nc">AudioQualityControl</span><span class="p">:</span>
    <span class="s">"""
    Automated quality control system for generated audio.
    
    This class provides methods to assess the quality of generated audio
    and detect common issues such as silence, clipping, and repetition.
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Initialize the quality control system."""</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio_tensor</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">32000</span><span class="p">):</span>
        <span class="s">"""
        Perform comprehensive quality checks on an audio tensor.
        
        Args:
            audio_tensor (torch.Tensor): Audio tensor to check
            sample_rate (int): Sample rate of the audio
            
        Returns:
            dict: Quality assessment results
        """</span>
        <span class="c1"># Convert to numpy for analysis if needed
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">audio_tensor</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">audio_np</span> <span class="o">=</span> <span class="n">audio_tensor</span><span class="p">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">audio_np</span> <span class="o">=</span> <span class="n">audio_tensor</span>
        
        <span class="c1"># Initialize results dictionary
</span>        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"passed"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">"issues"</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">"metrics"</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Check for silence
</span>        <span class="n">silence_check</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">check_silence</span><span class="p">(</span><span class="n">audio_np</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silence_check</span><span class="p">[</span><span class="s">"passed"</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="s">"passed"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">results</span><span class="p">[</span><span class="s">"issues"</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"Silence: </span><span class="si">{</span><span class="n">silence_check</span><span class="p">[</span><span class="s">'details'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s">"metrics"</span><span class="p">][</span><span class="s">"silence"</span><span class="p">]</span> <span class="o">=</span> <span class="n">silence_check</span>
        
        <span class="c1"># Check for clipping
</span>        <span class="n">clipping_check</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">check_clipping</span><span class="p">(</span><span class="n">audio_np</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clipping_check</span><span class="p">[</span><span class="s">"passed"</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="s">"passed"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">results</span><span class="p">[</span><span class="s">"issues"</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"Clipping: </span><span class="si">{</span><span class="n">clipping_check</span><span class="p">[</span><span class="s">'details'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s">"metrics"</span><span class="p">][</span><span class="s">"clipping"</span><span class="p">]</span> <span class="o">=</span> <span class="n">clipping_check</span>
        
        <span class="c1"># Check for repetition
</span>        <span class="n">repetition_check</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">check_repetition</span><span class="p">(</span><span class="n">audio_np</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repetition_check</span><span class="p">[</span><span class="s">"passed"</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="s">"passed"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">results</span><span class="p">[</span><span class="s">"issues"</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"Repetition: </span><span class="si">{</span><span class="n">repetition_check</span><span class="p">[</span><span class="s">'details'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s">"metrics"</span><span class="p">][</span><span class="s">"repetition"</span><span class="p">]</span> <span class="o">=</span> <span class="n">repetition_check</span>
        
        <span class="c1"># Check for imbalance
</span>        <span class="n">balance_check</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">check_spectral_balance</span><span class="p">(</span><span class="n">audio_np</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">balance_check</span><span class="p">[</span><span class="s">"passed"</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="s">"passed"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">results</span><span class="p">[</span><span class="s">"issues"</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"Spectral imbalance: </span><span class="si">{</span><span class="n">balance_check</span><span class="p">[</span><span class="s">'details'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s">"metrics"</span><span class="p">][</span><span class="s">"spectral_balance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">balance_check</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">check_silence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">threshold_db</span><span class="o">=-</span><span class="mi">60</span><span class="p">,</span> <span class="n">max_silent_percentage</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="s">"""
        Check if audio contains too much silence.
        
        Args:
            audio (numpy.ndarray): Audio data
            threshold_db (float): Silence threshold in dB
            max_silent_percentage (float): Maximum allowed percentage of silence
            
        Returns:
            dict: Check results
        """</span>
        <span class="c1"># Convert dB threshold to amplitude
</span>        <span class="n">threshold_amp</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">threshold_db</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span>
        
        <span class="c1"># Calculate RMS amplitude in short windows
</span>        <span class="n">window_size</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="n">hop_size</span> <span class="o">=</span> <span class="n">window_size</span> <span class="o">//</span> <span class="mi">2</span>
        
        <span class="n">n_windows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span><span class="p">)</span> <span class="o">//</span> <span class="n">hop_size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">silent_windows</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_windows</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">hop_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">window_size</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">audio</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">window</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">rms</span> <span class="o">&lt;</span> <span class="n">threshold_amp</span><span class="p">:</span>
                <span class="n">silent_windows</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Calculate percentage of silent windows
</span>        <span class="n">silent_percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">silent_windows</span> <span class="o">/</span> <span class="n">n_windows</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">n_windows</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Check if silence exceeds threshold
</span>        <span class="n">passed</span> <span class="o">=</span> <span class="n">silent_percentage</span> <span class="o">&lt;=</span> <span class="n">max_silent_percentage</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"passed"</span><span class="p">:</span> <span class="n">passed</span><span class="p">,</span>
            <span class="s">"silent_percentage"</span><span class="p">:</span> <span class="n">silent_percentage</span><span class="p">,</span>
            <span class="s">"details"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">silent_percentage</span><span class="p">:.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">% of audio is silent (threshold: </span><span class="si">{</span><span class="n">max_silent_percentage</span><span class="si">}</span><span class="s">%)"</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_clipping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">max_clip_percentage</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="s">"""
        Check if audio contains clipping.
        
        Args:
            audio (numpy.ndarray): Audio data
            threshold (float): Clipping threshold (0.0-1.0)
            max_clip_percentage (float): Maximum allowed percentage of clipping
            
        Returns:
            dict: Check results
        """</span>
        <span class="c1"># Count samples above threshold
</span>        <span class="n">clipped_samples</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="n">clip_percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">clipped_samples</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Check if clipping exceeds threshold
</span>        <span class="n">passed</span> <span class="o">=</span> <span class="n">clip_percentage</span> <span class="o">&lt;=</span> <span class="n">max_clip_percentage</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"passed"</span><span class="p">:</span> <span class="n">passed</span><span class="p">,</span>
            <span class="s">"clip_percentage"</span><span class="p">:</span> <span class="n">clip_percentage</span><span class="p">,</span>
            <span class="s">"details"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">clip_percentage</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% of samples show clipping (threshold: </span><span class="si">{</span><span class="n">max_clip_percentage</span><span class="si">}</span><span class="s">%)"</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_repetition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">segment_duration</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="s">"""
        Check if audio contains excessive repetition.
        
        Args:
            audio (numpy.ndarray): Audio data
            sample_rate (int): Sample rate of the audio
            segment_duration (float): Duration of segments to compare in seconds
            similarity_threshold (float): Similarity threshold for repetition detection
            
        Returns:
            dict: Check results
        """</span>
        <span class="c1"># Calculate segment size in samples
</span>        <span class="n">segment_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">segment_duration</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
        
        <span class="c1"># If audio is too short for analysis, return passed
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">segment_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s">"passed"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s">"repetition_score"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s">"details"</span><span class="p">:</span> <span class="s">"Audio too short for repetition analysis"</span>
            <span class="p">}</span>
        
        <span class="c1"># Divide audio into segments
</span>        <span class="n">num_segments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span> <span class="o">//</span> <span class="n">segment_size</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">audio</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">segment_size</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">segment_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_segments</span><span class="p">)]</span>
        
        <span class="c1"># Calculate cross-correlation between consecutive segments
</span>        <span class="n">max_correlation</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_segments</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">max_correlation</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_correlation</span><span class="p">,</span> <span class="n">correlation</span><span class="p">)</span>
        
        <span class="c1"># Check if repetition exceeds threshold
</span>        <span class="n">passed</span> <span class="o">=</span> <span class="n">max_correlation</span> <span class="o">&lt;</span> <span class="n">similarity_threshold</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"passed"</span><span class="p">:</span> <span class="n">passed</span><span class="p">,</span>
            <span class="s">"repetition_score"</span><span class="p">:</span> <span class="n">max_correlation</span><span class="p">,</span>
            <span class="s">"details"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Maximum segment correlation: </span><span class="si">{</span><span class="n">max_correlation</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> (threshold: </span><span class="si">{</span><span class="n">similarity_threshold</span><span class="si">}</span><span class="s">)"</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_spectral_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">min_db_range</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="s">"""
        Check spectral balance of audio.
        
        Args:
            audio (numpy.ndarray): Audio data
            sample_rate (int): Sample rate of the audio
            min_db_range (float): Minimum required dynamic range in dB
            
        Returns:
            dict: Check results
        """</span>
        <span class="c1"># Calculate spectrum
</span>        <span class="n">n_fft</span> <span class="o">=</span> <span class="mi">2048</span>
        <span class="n">hop_length</span> <span class="o">=</span> <span class="n">n_fft</span> <span class="o">//</span> <span class="mi">4</span>
        
        <span class="c1"># Compute spectrogram
</span>        <span class="n">audio_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">audio</span><span class="p">).</span><span class="nb">float</span><span class="p">()</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">Spectrogram</span><span class="p">(</span>
            <span class="n">n_fft</span><span class="o">=</span><span class="n">n_fft</span><span class="p">,</span>
            <span class="n">hop_length</span><span class="o">=</span><span class="n">hop_length</span><span class="p">,</span>
            <span class="n">power</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)(</span><span class="n">audio_tensor</span><span class="p">)</span>
        
        <span class="c1"># Convert to dB scale (avoid log of zero)
</span>        <span class="n">spec_db</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span><span class="n">spec</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        
        <span class="c1"># Calculate average spectrum across time
</span>        <span class="n">avg_spectrum</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec_db</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="n">numpy</span><span class="p">()</span>
        
        <span class="c1"># Calculate spectrum range in dB
</span>        <span class="n">db_range</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">avg_spectrum</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">avg_spectrum</span><span class="p">)</span>
        
        <span class="c1"># Check if spectral range is sufficient
</span>        <span class="n">passed</span> <span class="o">=</span> <span class="n">db_range</span> <span class="o">&gt;=</span> <span class="n">min_db_range</span>
        
        <span class="c1"># Calculate spectrum tilt (high frequency vs low frequency energy)
</span>        <span class="n">low_energy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_spectrum</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">avg_spectrum</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">high_energy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_spectrum</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">avg_spectrum</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">:])</span>
        <span class="n">tilt</span> <span class="o">=</span> <span class="n">low_energy</span> <span class="o">-</span> <span class="n">high_energy</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">"passed"</span><span class="p">:</span> <span class="n">passed</span><span class="p">,</span>
            <span class="s">"db_range"</span><span class="p">:</span> <span class="n">db_range</span><span class="p">,</span>
            <span class="s">"spectral_tilt"</span><span class="p">:</span> <span class="n">tilt</span><span class="p">,</span>
            <span class="s">"details"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Spectral range: </span><span class="si">{</span><span class="n">db_range</span><span class="p">:.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> dB (threshold: </span><span class="si">{</span><span class="n">min_db_range</span><span class="si">}</span><span class="s"> dB), Tilt: </span><span class="si">{</span><span class="n">tilt</span><span class="p">:.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> dB"</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">batch_check_audio_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio_files</span><span class="p">):</span>
        <span class="s">"""
        Check quality of multiple audio files.
        
        Args:
            audio_files (list): List of audio file paths
            
        Returns:
            dict: Check results for each file
        """</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">audio_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load audio file
</span>                <span class="n">waveform</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                
                <span class="c1"># Convert to mono if needed
</span>                <span class="k">if</span> <span class="n">waveform</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">waveform</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                
                <span class="c1"># Check audio quality
</span>                <span class="n">check_result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">check_audio</span><span class="p">(</span><span class="n">waveform</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sample_rate</span><span class="p">)</span>
                
                <span class="c1"># Store results
</span>                <span class="n">results</span><span class="p">[</span><span class="n">file_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_result</span>
                
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Handle errors
</span>                <span class="n">results</span><span class="p">[</span><span class="n">file_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">"passed"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s">"issues"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s">"Error processing file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">],</span>
                    <span class="s">"metrics"</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div>

<p>This quality control system can be integrated into your batch processing workflow to automatically detect issues with generated audio, such as:</p>

<ol>
  <li><strong>Silence detection</strong>: Identifies audio with excessive silent segments</li>
  <li><strong>Clipping detection</strong>: Finds samples with amplitude distortion</li>
  <li><strong>Repetition detection</strong>: Detects repetitive patterns that might indicate model issues</li>
  <li><strong>Spectral balance</strong>: Ensures audio has appropriate frequency distribution</li>
</ol>

<h2 id="hands-on-challenge-build-a-music-generation-factory">Hands-on Challenge: Build a Music Generation Factory</h2>

<p>Now it’s time to apply everything you’ve learned to create a complete music generation factory:</p>

<ol>
  <li>Create a comprehensive pipeline that:
    <ul>
      <li>Takes a CSV file with music generation specifications (prompts, parameters)</li>
      <li>Processes batches of generations efficiently</li>
      <li>Implements quality control to filter out problematic generations</li>
      <li>Creates well-organized output with comprehensive documentation</li>
    </ul>
  </li>
  <li>Extend the pipeline with:
    <ul>
      <li>A retry mechanism for failed generations</li>
      <li>A results evaluation system that rates generations</li>
      <li>Parallel processing across multiple available devices</li>
    </ul>
  </li>
  <li>Create a reporting system that:
    <ul>
      <li>Generates summary statistics on generation quality</li>
      <li>Creates visualizations of key metrics</li>
      <li>Identifies optimal parameter settings based on quality scores</li>
    </ul>
  </li>
</ol>

<p><strong>Bonus Challenge</strong>: Implement a web dashboard that monitors generation progress and displays results in real-time.</p>

<h2 id="key-takeaways">Key Takeaways</h2>

<ul>
  <li>Batch processing is essential for scaling AI audio generation to production levels</li>
  <li>Well-designed pipelines with clear separation of concerns improve maintainability</li>
  <li>Systematic experimentation helps identify optimal parameters for different use cases</li>
  <li>Proper organization and documentation are crucial when working with large volumes of generated content</li>
  <li>Quality control systems help maintain consistent output quality</li>
  <li>Resource optimization is important for efficient large-scale generation</li>
</ul>

<h2 id="next-steps">Next Steps</h2>

<p>Now that you’ve mastered MusicGen and learned how to scale your generation processes, you’re ready to move on to the next section of our tutorial:</p>

<ul>
  <li><strong>Chapter 10: Introduction to AudioGen</strong> - Shift focus from music to sound effects generation</li>
  <li><strong>Chapter 11: Sound Effect Generation Techniques</strong> - Learn specialized techniques for SFX</li>
  <li><strong>Chapter 12: Audio Scene Composition</strong> - Combine multiple sound elements into cohesive scenes</li>
  <li><strong>Chapter 13: Sound Design Workflows</strong> - Build professional sound design pipelines</li>
</ul>

<h2 id="further-reading">Further Reading</h2>

<ul>
  <li><a href="https://ai.meta.com/blog/audiocraft-musicgen-audiogen-encodec-generative-ai-audio/">Large-Scale Audio Generation with AudioCraft</a></li>
  <li><a href="https://pytorch.org/tutorials/intermediate/model_parallel_tutorial.html">Model Parallelism for Efficient Generation</a></li>
  <li><a href="https://arxiv.org/abs/2104.01778">Scientific Experimentation with AI Systems</a></li>
  <li><a href="https://proceedings.mlr.press/v119/turner20a/turner20a.pdf">Systematic Parameter Optimization</a></li>
  <li><a href="https://arxiv.org/abs/2206.01283">Quality Control for Audio Generation</a></li>
</ul>

  
  
  
  
  
  
  
  
</div>

<div class="chapter-navigation">
  
  <a href="/chapters/part2/basic-music/" class="prev-chapter">
    <span class="nav-label">Previous</span>
    <span class="nav-title">Chapter 5: Basic Music Generation</span>
  </a>
  
  
  
  <a href="/chapters/part2/melody-conditioning/" class="next-chapter">
    <span class="nav-label">Next</span>
    <span class="nav-title">Melody Conditioning for AI Music Generation</span>
  </a>
  
</div>

<!-- Copyright footer for all chapter pages -->
<div class="copyright-footer">
  <hr>
  <p>
    Copyright © 2025 Scott Friedman.
    <br>
    This work is licensed under the <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.
  </p>
</div>


        </div>
      </main>

      <footer class="site-footer">
        <div class="container">
          <div class="footer-col-wrapper">
            <div class="footer-col">
              <p>A hands-on guide to creating music, sound effects, and audio experiences with AI</p>
              <p>
                <a href="https://github.com/facebookresearch/audiocraft">AudioCraft GitHub Repository</a>
              </p>
            </div>
            <div class="footer-col">
              <p class="copyright">
                Copyright © 2025 Scott Friedman.<br>
                Licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a>.
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>