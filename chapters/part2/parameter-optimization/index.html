<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Parameter Optimization for Music Generation</title>
  <meta name="description" content="“My music generation AI system is working, but the results are way too random and weird sounding. Sometimes they’re too repetitive, other times they’re chaot...">
  <link rel="canonical" href="https://scttfrdmn.github.io/practical-meta-audiocraft/chapters/part2/parameter-optimization/">
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .wrapper {
      max-width: 100%;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 20px;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    h1 { color: #1a73e8; }
    h2 { color: #34a853; }
    a {
      color: #1a73e8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .site-header {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
      margin-bottom: 30px;
    }
    .site-title {
      margin: 0;
      font-size: 1.8rem;
    }
    .site-title a {
      color: #1a73e8;
      text-decoration: none;
    }
    .site-nav {
      float: right;
      margin-top: 10px;
    }
    .site-nav .page-link {
      margin-left: 20px;
    }
    .nav-trigger {
      display: none;
    }
    .menu-icon {
      display: none;
    }
    .page-content {
      padding: 20px 0;
    }
    .site-footer {
      border-top: 1px solid #eee;
      padding: 30px 0;
      margin-top: 60px;
    }
    .footer-col-wrapper {
      display: flex;
      flex-wrap: wrap;
    }
    .footer-col {
      flex: 1;
      min-width: 200px;
      padding-right: 20px;
    }
    code {
      background-color: #f5f5f5;
      padding: 2px 5px;
      border-radius: 3px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .highlight {
      background-color: #f5f5f5;
      border-radius: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px 12px;
    }
    th {
      background-color: #f5f5f5;
      text-align: left;
    }
    button, .button {
      display: inline-block;
      background-color: #1a73e8;
      color: white !important;
      padding: 10px 20px;
      border-radius: 4px;
      font-weight: bold;
      margin-top: 20px;
      border: none;
      cursor: pointer;
      text-decoration: none !important;
    }
    button:hover, .button:hover {
      background-color: #0d65d9;
    }
    .feature {
      background-color: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #1a73e8;
      margin-bottom: 20px;
    }
    
    @media screen and (max-width: 600px) {
      .site-nav {
        position: absolute;
        top: 70px;
        right: 20px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        text-align: right;
        padding: 0;
        z-index: 1;
      }
      .site-nav .page-link {
        display: block;
        padding: 10px;
        margin: 0;
      }
      .site-nav .menu-icon {
        display: block;
        float: right;
        width: 36px;
        height: 26px;
        line-height: 0;
        padding-top: 10px;
        text-align: center;
      }
      .site-nav .trigger {
        clear: both;
        display: none;
      }
      .site-nav input:checked ~ .trigger {
        display: block;
        padding-bottom: 5px;
      }
      .footer-col-wrapper {
        flex-direction: column;
      }
      .footer-col {
        margin-bottom: 20px;
      }
    }
  </style>
</head><body>
    <div class="wrapper">
      <header class="site-header">
        <div class="container">
          <h1 class="site-title"><a href="/practical-meta-audiocraft/">Practical Meta AudioCraft</a></h1>
          <nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger">
              <span class="menu-icon">
                <svg viewBox="0 0 18 15" width="18px" height="15px">
                  <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484c0-0.82,0.665-1.485,1.484-1.485 h15.032C17.335,0,18,0.665,18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516 c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,6.031,18,6.696,18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516c0-0.82,0.665-1.483,1.484-1.483h15.032 C17.335,12.031,18,12.696,18,13.516z"/>
                </svg>
              </span>
            </label>

            <div class="trigger">
              <a class="page-link" href="/practical-meta-audiocraft/">Home</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part1/introduction/">Getting Started</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part2/basic-music/">MusicGen</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part3/introduction-to-audiogen/">AudioGen</a>
              <a class="page-link" href="/practical-meta-audiocraft/tutorials/getting-started/">Tutorials</a>
            </div>
          </nav>
        </div>
      </header>

      <main class="page-content" aria-label="Content">
        <div class="container">
          <div class="chapter">
  <div class="chapter-header">
    <div class="chapter-metadata">
      <span class="difficulty intermediate">Intermediate</span>
      <span class="estimated-time">45</span>
    </div>
    <h1>Parameter Optimization for Music Generation</h1>
  </div>
  
  
  
  <blockquote>
  <p><em>“My music generation AI system is working, but the results are way too random and weird sounding. Sometimes they’re too repetitive, other times they’re chaotic. There must be some way to control this better. I’ve read about temperature, top-k, and other parameters, but I have no idea how to set them for consistent, high-quality results.”</em></p>

  <p>— Mia Chen, music technology startup founder</p>
</blockquote>

<h1 id="chapter-7-parameter-optimization-for-music-generation">Chapter 7: Parameter Optimization for Music Generation</h1>

<h2 id="the-challenge">The Challenge</h2>

<p>You’ve mastered prompt engineering, but your music generation results still vary widely in quality. Sometimes they’re uninspired and repetitive, other times they’re chaotic and disorganized. The same prompt can yield dramatically different results with each generation.</p>

<p>In this chapter, we’ll tackle the challenge of finding optimal parameter settings for MusicGen to produce consistently high-quality outputs that match your creative intent. We’ll systematically explore how each generation parameter affects the output and develop strategies for finding the right balance between predictability and creativity.</p>

<h2 id="learning-objectives">Learning Objectives</h2>

<p>By the end of this chapter, you will be able to:</p>

<ul>
  <li>Understand how each MusicGen generation parameter affects the output quality and characteristics</li>
  <li>Develop systematic testing methodologies to find optimal parameter combinations</li>
  <li>Create parameter presets tailored to different musical genres and applications</li>
  <li>Implement a parameter optimization workflow for your music generation pipeline</li>
  <li>Diagnose and fix common parameter-related issues in AI-generated music</li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Basic understanding of MusicGen (Chapter 5)</li>
  <li>Experience with prompt engineering for music (Chapter 6)</li>
  <li>Python environment with AudioCraft installed</li>
</ul>

<h2 id="key-concepts-the-generation-parameter-space">Key Concepts: The Generation Parameter Space</h2>

<p>MusicGen, like other generative models, offers several parameters that control the generation process. These parameters don’t affect what content is generated (that’s the prompt’s job) but rather how the model navigates its probability space to create that content.</p>

<p>Let’s first understand the core parameters available in MusicGen:</p>

<h3 id="temperature">Temperature</h3>

<p>Temperature controls the randomness of the generation process. It directly scales the logits (unnormalized probabilities) before sampling, affecting how likely the model is to choose lower-probability options.</p>

<ul>
  <li><strong>Low temperature (0.1 - 0.6)</strong>: More deterministic, favors high-probability outputs, often more repetitive but coherent</li>
  <li><strong>Medium temperature (0.7 - 1.2)</strong>: Balanced randomness, good mix of predictability and variation</li>
  <li><strong>High temperature (1.3 - 2.0)</strong>: More chaotic and experimental, explores unusual combinations</li>
</ul>

<p>Temperature is the most important parameter for controlling generation diversity, acting as a “creativity knob” that balances between safe, predictable outputs and wild, experimental ones.</p>

<h3 id="top-k-sampling">Top-k Sampling</h3>

<p>Top-k sampling restricts the model to only consider the k most likely tokens at each generation step. This parameter sets a hard limit on the diversity of choices:</p>

<ul>
  <li><strong>Low k (50 - 100)</strong>: More coherent but limited in variety</li>
  <li><strong>Medium k (200 - 300)</strong>: Good balance for most applications</li>
  <li><strong>High k (500+)</strong>: More diverse outputs, potentially less coherent</li>
</ul>

<h3 id="top-p-nucleus-sampling">Top-p (Nucleus) Sampling</h3>

<p>Top-p sampling, also called nucleus sampling, dynamically selects the smallest set of tokens whose cumulative probability exceeds the threshold p:</p>

<ul>
  <li><strong>Low p (0.1 - 0.3)</strong>: Very conservative sampling, more predictable</li>
  <li><strong>Medium p (0.4 - 0.7)</strong>: Balanced approach for most applications</li>
  <li><strong>High p (0.8 - 0.95)</strong>: More unexpected choices, higher diversity</li>
</ul>

<p>Note: When top_p is set to 0.0, nucleus sampling is disabled in MusicGen.</p>

<h3 id="classifier-free-guidance-cfg_coef">Classifier-Free Guidance (cfg_coef)</h3>

<p>This parameter controls how strictly the model follows the conditioning (your prompt). Higher values make the model adhere more closely to the prompt, potentially at the cost of quality:</p>

<ul>
  <li><strong>Low cfg_coef (1.0 - 2.0)</strong>: More freedom to deviate from the prompt, often more musical</li>
  <li><strong>Medium cfg_coef (2.5 - 3.5)</strong>: Good balance between prompt adherence and quality</li>
  <li><strong>High cfg_coef (4.0 - 10.0)</strong>: Strongly adheres to prompt, sometimes at cost of naturalness</li>
</ul>

<h2 id="understanding-parameter-interactions">Understanding Parameter Interactions</h2>

<p>These parameters interact in complex ways. For example:</p>

<ol>
  <li>A high temperature with a low top-k might still produce conservative outputs</li>
  <li>A low temperature with a high top-p might produce more diverse results than expected</li>
  <li>A high cfg_coef can compensate for a high-temperature setting by keeping generation more aligned with the prompt</li>
</ol>

<p>The key is finding the right balance for your specific application, which requires systematic testing.</p>

<h2 id="systematic-parameter-testing">Systematic Parameter Testing</h2>

<p>Let’s implement a parameter exploration system that allows us to understand how different settings affect our output:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># parameter_explorer.py
</span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">audiocraft.models</span> <span class="kn">import</span> <span class="n">MusicGen</span>
<span class="kn">from</span> <span class="nn">audiocraft.data.audio</span> <span class="kn">import</span> <span class="n">audio_write</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">ParameterExplorer</span><span class="p">:</span>
    <span class="s">"""
    A tool for systematic exploration of MusicGen parameters.
    
    This class helps identify optimal parameter combinations by
    generating multiple samples with different parameter settings
    and organizing the results for easy comparison.
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_size</span><span class="o">=</span><span class="s">"medium"</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Initialize the parameter explorer with a MusicGen model."""</span>
        <span class="c1"># Determine device automatically if not specified
</span>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"mps"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using MPS (Metal) for generation"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using CUDA for generation"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"cpu"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using CPU for generation (this will be slow)"</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">model_size</span>
        
        <span class="c1"># Load the model
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Loading MusicGen </span><span class="si">{</span><span class="n">model_size</span><span class="si">}</span><span class="s"> model..."</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MusicGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Track experiment history
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_history</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">explore_single_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">parameter_values</span><span class="p">,</span> 
                                 <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Explore the effect of varying a single parameter while keeping others constant.
        
        Args:
            prompt (str): Text description of the music to generate
            parameter_name (str): Parameter to vary ('temperature', 'top_k', 'top_p', or 'cfg_coef')
            parameter_values (list): List of values to test for the parameter
            duration (float): Length of each sample in seconds
            output_dir (str): Directory to save samples, defaults to parameter name + timestamp
            
        Returns:
            str: Path to output directory containing the generated samples
        """</span>
        <span class="c1"># Setup default parameters
</span>        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'duration'</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
            <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="p">}</span>
        
        <span class="c1"># Create output directory with timestamp
</span>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y%m%d_%H%M%S"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s">_exploration_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">"</span>
        
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Save experiment information
</span>        <span class="n">experiment_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'prompt'</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s">'parameter_varied'</span><span class="p">:</span> <span class="n">parameter_name</span><span class="p">,</span>
            <span class="s">'values_tested'</span><span class="p">:</span> <span class="n">parameter_values</span><span class="p">,</span>
            <span class="s">'default_parameters'</span><span class="p">:</span> <span class="n">default_params</span><span class="p">,</span>
            <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s">'model_size'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span>
        <span class="p">}</span>
        
        <span class="c1"># Save experiment metadata
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"experiment_info.json"</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">experiment_info</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
        <span class="c1"># Save prompt for reference
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"prompt.txt"</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"Prompt: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"Parameter explored: </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"Values tested: </span><span class="si">{</span><span class="n">parameter_values</span><span class="si">}</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Default parameters:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">default_params</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param</span> <span class="o">!=</span> <span class="n">parameter_name</span><span class="p">:</span>  <span class="c1"># Don't list the parameter we're varying
</span>                    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Track overall progress
</span>        <span class="n">total_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_values</span><span class="p">)</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Generate samples for each parameter value
</span>        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameter_values</span><span class="p">:</span>
            <span class="n">completed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">completed</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_tests</span><span class="si">}</span><span class="s">] Testing </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s">..."</span><span class="p">)</span>
            
            <span class="c1"># Set generation parameters, with our test parameter modified
</span>            <span class="n">generation_params</span> <span class="o">=</span> <span class="n">default_params</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">generation_params</span><span class="p">[</span><span class="n">parameter_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span><span class="o">**</span><span class="n">generation_params</span><span class="p">)</span>
            
            <span class="c1"># Generate audio with these parameters
</span>            <span class="n">wav</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
            
            <span class="c1"># Save with parameter value in filename
</span>            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">audio_write</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span>
                <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
            <span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Saved sample with </span><span class="si">{</span><span class="n">parameter_name</span><span class="si">}</span><span class="s">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">)</span>
        
        <span class="c1"># Create a README with listening instructions
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_create_readme</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
        
        <span class="c1"># Add to experiment history
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_history</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">experiment_info</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Exploration complete! All </span><span class="si">{</span><span class="n">total_tests</span><span class="si">}</span><span class="s"> samples saved to </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dir</span>
    
    <span class="k">def</span> <span class="nf">explore_parameter_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">parameter_grid</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Explore combinations of parameters using a grid search approach.
        
        Args:
            prompt (str): Text description of the music to generate
            parameter_grid (dict): Dictionary mapping parameter names to lists of values
                                  e.g., {'temperature': [0.5, 1.0], 'top_k': [100, 250]}
            duration (float): Length of each sample in seconds
            output_dir (str): Directory to save samples, defaults to 'parameter_grid' + timestamp
            
        Returns:
            str: Path to output directory containing the generated samples
        """</span>
        <span class="c1"># Create output directory with timestamp
</span>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y%m%d_%H%M%S"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"parameter_grid_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">"</span>
        
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Default parameters
</span>        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'duration'</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
            <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="p">}</span>
        
        <span class="c1"># Update with parameters from grid
</span>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameter_grid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">default_params</span><span class="p">:</span>
                <span class="c1"># Remove from defaults since we'll be varying it
</span>                <span class="n">default_params</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        
        <span class="c1"># Save experiment information
</span>        <span class="n">experiment_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'prompt'</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s">'parameter_grid'</span><span class="p">:</span> <span class="n">parameter_grid</span><span class="p">,</span>
            <span class="s">'default_parameters'</span><span class="p">:</span> <span class="n">default_params</span><span class="p">,</span>
            <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s">'model_size'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span>
        <span class="p">}</span>
        
        <span class="c1"># Save metadata
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"experiment_info.json"</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">experiment_info</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Generate all parameter combinations
</span>        <span class="kn">import</span> <span class="nn">itertools</span>
        
        <span class="c1"># Get all parameter names and their possible values from the grid
</span>        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameter_grid</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">param_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">parameter_grid</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">]</span>
        
        <span class="c1"># Generate all combinations of parameter values
</span>        <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">param_values</span><span class="p">))</span>
        
        <span class="c1"># Track progress
</span>        <span class="n">total_combinations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combinations</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Testing </span><span class="si">{</span><span class="n">total_combinations</span><span class="si">}</span><span class="s"> parameter combinations..."</span><span class="p">)</span>
        
        <span class="c1"># Generate samples for each parameter combination
</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">combination</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">):</span>
            <span class="c1"># Create parameter dictionary for this combination
</span>            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">'duration'</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="p">}</span>
            
            <span class="c1"># Add fixed parameters
</span>            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">default_params</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                
            <span class="c1"># Add grid parameters for this combination
</span>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">combination</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            
            <span class="c1"># Create descriptive filename based on parameters
</span>            <span class="n">filename_parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">):</span>
                <span class="c1"># Format value to 1 decimal place if it's a float
</span>                <span class="n">value</span> <span class="o">=</span> <span class="n">combination</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">value</span><span class="p">:.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">"</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">filename_parts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">param</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}{</span><span class="n">value_str</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="n">filename</span> <span class="o">=</span> <span class="s">"_"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename_parts</span><span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_combinations</span><span class="si">}</span><span class="s">] Testing combination: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Set generation parameters
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            
            <span class="c1"># Generate audio
</span>            <span class="n">wav</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
            
            <span class="c1"># Save the audio
</span>            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">audio_write</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span>
                <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
            <span class="p">)</span>
            
            <span class="c1"># Also save parameter info in a JSON file
</span>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.json"</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Saved sample to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">)</span>
        
        <span class="c1"># Create README with instructions
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"README.txt"</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"PARAMETER GRID EXPLORATION</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"==========================</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"Prompt: </span><span class="se">\"</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="se">\"\n\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Parameters explored:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">parameter_grid</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Fixed parameters:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">default_params</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Filename format explains the parameters used:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Example: tem1.0_top250.wav means temperature=1.0, top_k=250</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"How to compare samples:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"1. Listen systematically to isolate the effect of each parameter</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"2. Each sample has a JSON file with the exact parameters used</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"3. Take notes on which combinations work best for your use case</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># Add to experiment history
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">experiment_history</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">experiment_info</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Grid exploration complete! All </span><span class="si">{</span><span class="n">total_combinations</span><span class="si">}</span><span class="s"> samples saved to </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dir</span>
    
    <span class="k">def</span> <span class="nf">load_best_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_path</span><span class="p">):</span>
        <span class="s">"""
        Load parameter settings from a JSON file.
        
        This is useful for reusing parameter combinations you've identified as optimal.
        """</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># Remove non-generation parameters
</span>        <span class="k">if</span> <span class="s">'duration'</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'duration'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="mf">10.0</span>
            
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Loaded parameters from </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Parameters: </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">duration</span>
    
    <span class="k">def</span> <span class="nf">save_preset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">""</span><span class="p">):</span>
        <span class="s">"""Save a parameter preset for future use."""</span>
        <span class="n">preset</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'name'</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s">'parameters'</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
            <span class="s">'description'</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s">'model_size'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="p">,</span>
            <span class="s">'created'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1"># Create presets directory if it doesn't exist
</span>        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s">"parameter_presets"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Save preset
</span>        <span class="n">preset_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">"parameter_presets"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.json"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">preset_path</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">preset</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Saved preset '</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">' to </span><span class="si">{</span><span class="n">preset_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">preset_path</span>
    
    <span class="k">def</span> <span class="nf">_create_readme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">parameter_name</span><span class="p">,</span> <span class="n">prompt</span><span class="p">):</span>
        <span class="s">"""Create a README file with guidance on parameter effects."""</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"README.txt"</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">parameter_name</span><span class="p">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s"> EXPLORATION SAMPLES</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">parameter_name</span><span class="p">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s"> EXPLORATION SAMPLES"</span><span class="p">)</span><span class="o">+</span><span class="s">"</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"Prompt used: </span><span class="se">\"</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="se">\"\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"How to interpret these samples:</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">parameter_name</span> <span class="o">==</span> <span class="s">"temperature"</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"TEMPERATURE controls randomness in generation:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Lower values (0.1-0.7): More predictable, sometimes repetitive</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Medium values (0.8-1.2): Good balance of consistency and creativity</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Higher values (1.3+): More experimental, unexpected, sometimes chaotic</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Recommendation: Start with 0.7-1.0 for most applications.</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Use lower values for more consistent, genre-typical results.</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Use higher values for creative exploration.</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">parameter_name</span> <span class="o">==</span> <span class="s">"top_k"</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"TOP_K limits how many options the model considers at each step:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Lower values (50-100): More focused but potentially repetitive</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Medium values (150-300): Good balance for most music</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Higher values (400+): Greater variety but potentially less coherent</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Recommendation: 250 is a good default. Increase for more</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"experimental results, decrease for more coherent, safer output.</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">parameter_name</span> <span class="o">==</span> <span class="s">"top_p"</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"TOP_P (nucleus sampling) dynamically limits token selection:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Note: In MusicGen, top_p=0.0 means nucleus sampling is disabled</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Lower values (0.1-0.3): Very conservative, highly predictable</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Medium values (0.4-0.7): Balanced approach</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Higher values (0.8-0.95): Diverse but potentially less coherent</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Recommendation: Either use 0.0 (disabled) and rely on top_k,</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"or try values around 0.9 with top_k=0 for a different sampling approach.</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">parameter_name</span> <span class="o">==</span> <span class="s">"cfg_coef"</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"CFG_COEF (classifier-free guidance) controls prompt adherence:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Lower values (1-2): More musical but may stray from prompt</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Medium values (2.5-3.5): Good balance for most use cases</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"- Higher values (4-10): Strictly follows prompt, sometimes at quality cost</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Recommendation: 3.0 is a good default. Increase if model ignores</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"important aspects of your prompt. Decrease if output sounds forced or unnatural.</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">explore_temperature</span><span class="p">():</span>
    <span class="s">"""Example function to explore temperature parameter."""</span>
    <span class="n">explorer</span> <span class="o">=</span> <span class="n">ParameterExplorer</span><span class="p">(</span><span class="n">model_size</span><span class="o">=</span><span class="s">"medium"</span><span class="p">)</span>
    
    <span class="n">prompt</span> <span class="o">=</span> <span class="s">"A smooth jazz piece with piano, saxophone, and light drums"</span>
    
    <span class="c1"># Test a range of temperature values
</span>    <span class="n">temperatures</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">]</span>
    
    <span class="n">explorer</span><span class="p">.</span><span class="n">explore_single_parameter</span><span class="p">(</span>
        <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
        <span class="n">parameter_name</span><span class="o">=</span><span class="s">"temperature"</span><span class="p">,</span>
        <span class="n">parameter_values</span><span class="o">=</span><span class="n">temperatures</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="s">"temperature_test"</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">explore_parameter_combinations</span><span class="p">():</span>
    <span class="s">"""Example function to explore combinations of parameters."""</span>
    <span class="n">explorer</span> <span class="o">=</span> <span class="n">ParameterExplorer</span><span class="p">(</span><span class="n">model_size</span><span class="o">=</span><span class="s">"medium"</span><span class="p">)</span>
    
    <span class="n">prompt</span> <span class="o">=</span> <span class="s">"An electronic track with a driving beat and ambient synth pads"</span>
    
    <span class="c1"># Define a parameter grid to explore
</span>    <span class="n">parameter_grid</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'temperature'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span>
        <span class="s">'top_k'</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">250</span><span class="p">],</span>
        <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="c1"># This will test all combinations: 3 temperatures × 2 top_k values × 2 cfg values = 12 combinations
</span>    <span class="n">explorer</span><span class="p">.</span><span class="n">explore_parameter_grid</span><span class="p">(</span>
        <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
        <span class="n">parameter_grid</span><span class="o">=</span><span class="n">parameter_grid</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="s">"parameter_grid_test"</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="c1"># Uncomment the function you want to run
</span>    <span class="n">explore_temperature</span><span class="p">()</span>
    <span class="c1"># explore_parameter_combinations()
</span></code></pre></div></div>

<p>This comprehensive system allows you to:</p>

<ol>
  <li>Test individual parameters in isolation to understand their effects</li>
  <li>Explore parameter combinations to find optimal settings</li>
  <li>Save and reuse successful parameter presets</li>
  <li>Document your findings for future reference</li>
</ol>

<h2 id="genre-specific-parameter-optimization">Genre-Specific Parameter Optimization</h2>

<p>Different musical genres often benefit from different parameter settings. Here are some starting points based on extensive testing:</p>

<h3 id="classical-music">Classical Music</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">classical_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>     <span class="c1"># Lower temperature for structured, coherent development
</span>    <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>           <span class="c1"># Standard top_k works well
</span>    <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>           <span class="c1"># Disable nucleus sampling
</span>    <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">3.0</span>         <span class="c1"># Standard guidance
</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="electronic-music">Electronic Music</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">electronic_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>     <span class="c1"># Slightly higher for interesting textures and sounds
</span>    <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>           <span class="c1"># Higher diversity for electronic elements
</span>    <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>           <span class="c1"># Disable nucleus sampling
</span>    <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">2.5</span>         <span class="c1"># Slightly lower to allow creative sound design
</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="jazz">Jazz</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jazz_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>     <span class="c1"># Higher temperature for improvisational feel
</span>    <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>           <span class="c1"># Higher diversity for jazz explorations
</span>    <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>           <span class="c1"># Disable nucleus sampling
</span>    <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">2.0</span>         <span class="c1"># Lower guidance to allow "jazz improvisation"
</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="rockpop">Rock/Pop</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rock_pop_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>     <span class="c1"># Balanced temperature for structured but engaging music
</span>    <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>           <span class="c1"># Moderate diversity
</span>    <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>           <span class="c1"># Disable nucleus sampling
</span>    <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">3.5</span>         <span class="c1"># Higher guidance for clear genre adherence
</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="ambientatmospheric">Ambient/Atmospheric</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ambient_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>     <span class="c1"># Balanced for evolving textures
</span>    <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>           <span class="c1"># Standard diversity
</span>    <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>           <span class="c1"># Disable nucleus sampling
</span>    <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">2.8</span>         <span class="c1"># Moderate guidance
</span><span class="p">}</span>
</code></pre></div></div>

<h2 id="parameter-optimization-workflow">Parameter Optimization Workflow</h2>

<p>Let’s develop a systematic workflow for finding optimal parameters for your specific needs:</p>

<ol>
  <li><strong>Start with baselines</strong>: Begin with the genre-specific presets above as starting points</li>
  <li><strong>Isolate and test</strong>: Use the <code class="language-plaintext highlighter-rouge">explore_single_parameter</code> method to understand each parameter in isolation</li>
  <li><strong>Narrow down ranges</strong>: Identify promising value ranges for each parameter</li>
  <li><strong>Grid search</strong>: Use <code class="language-plaintext highlighter-rouge">explore_parameter_grid</code> to test combinations within those promising ranges</li>
  <li><strong>Evaluate results</strong>: Create a consistent rating system for generated outputs</li>
  <li><strong>Fine-tune</strong>: Make small adjustments to the best combinations</li>
  <li><strong>Create presets</strong>: Save your optimal settings as presets for different use cases</li>
</ol>

<h2 id="common-parameter-related-issues-and-solutions">Common Parameter-Related Issues and Solutions</h2>

<table>
  <thead>
    <tr>
      <th>Issue</th>
      <th>Probable Parameter Cause</th>
      <th>Solution</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Output is too random/chaotic</td>
      <td>Temperature too high</td>
      <td>Reduce temperature to 0.6-0.8</td>
    </tr>
    <tr>
      <td>Output is too repetitive</td>
      <td>Temperature too low</td>
      <td>Increase temperature to 1.0-1.2</td>
    </tr>
    <tr>
      <td>Output ignores aspects of the prompt</td>
      <td>cfg_coef too low</td>
      <td>Increase cfg_coef to 3.5-4.5</td>
    </tr>
    <tr>
      <td>Output sounds forced and unnatural</td>
      <td>cfg_coef too high</td>
      <td>Decrease cfg_coef to 2.0-2.5</td>
    </tr>
    <tr>
      <td>Output lacks variety between generations</td>
      <td>Sampling too restrictive</td>
      <td>Increase top_k or experiment with top_p</td>
    </tr>
    <tr>
      <td>Output is too generic</td>
      <td>Temperature too low, top_k too low</td>
      <td>Increase both for more creative results</td>
    </tr>
  </tbody>
</table>

<h2 id="complete-implementation-parameter-optimization-suite">Complete Implementation: Parameter Optimization Suite</h2>

<p>Let’s create a complete parameter optimization tool that builds on our ParameterExplorer class and adds a rating system to help you track which settings work best:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># parameter_optimization_suite.py
</span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">audiocraft.models</span> <span class="kn">import</span> <span class="n">MusicGen</span>
<span class="kn">from</span> <span class="nn">audiocraft.data.audio</span> <span class="kn">import</span> <span class="n">audio_write</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">class</span> <span class="nc">ParameterOptimizationSuite</span><span class="p">:</span>
    <span class="s">"""
    A comprehensive suite for optimizing MusicGen parameters and tracking results.
    
    Features:
    - Systematic parameter exploration
    - Result rating and tracking
    - Visualization of parameter effects
    - Preset management
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_size</span><span class="o">=</span><span class="s">"medium"</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">results_dir</span><span class="o">=</span><span class="s">"parameter_results"</span><span class="p">):</span>
        <span class="s">"""Initialize the optimization suite."""</span>
        <span class="c1"># Determine device automatically if not specified
</span>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"mps"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using MPS (Metal) for generation"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using CUDA for generation"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s">"cpu"</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Using CPU for generation (this will be slow)"</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">model_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">results_dir</span> <span class="o">=</span> <span class="n">results_dir</span>
        
        <span class="c1"># Create results directory if it doesn't exist
</span>        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Results tracking
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">results_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="s">"parameter_results.csv"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_initialize_results_tracking</span><span class="p">()</span>
        
        <span class="c1"># Load the model
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Loading MusicGen </span><span class="si">{</span><span class="n">model_size</span><span class="si">}</span><span class="s"> model..."</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MusicGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="n">model_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Standard presets
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">standard_presets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"balanced"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
                <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">3.0</span>
            <span class="p">},</span>
            <span class="s">"creative"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
                <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>
                <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">2.0</span>
            <span class="p">},</span>
            <span class="s">"conservative"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span>
                <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">3.5</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">_initialize_results_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Initialize or verify the results CSV file."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">''</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">([</span>
                    <span class="s">'timestamp'</span><span class="p">,</span> <span class="s">'prompt'</span><span class="p">,</span> <span class="s">'temperature'</span><span class="p">,</span> <span class="s">'top_k'</span><span class="p">,</span> <span class="s">'top_p'</span><span class="p">,</span> <span class="s">'cfg_coef'</span><span class="p">,</span>
                    <span class="s">'duration'</span><span class="p">,</span> <span class="s">'output_file'</span><span class="p">,</span> <span class="s">'rating'</span><span class="p">,</span> <span class="s">'notes'</span>
                <span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">generate_with_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        Generate a sample with specific parameters and track the result.
        
        Args:
            prompt (str): Text description of the music to generate
            params (dict): Generation parameters (temperature, top_k, etc.)
            duration (float): Length of sample in seconds
            output_dir (str): Directory to save sample
            
        Returns:
            str: Path to the generated audio file
        """</span>
        <span class="c1"># Create output directory
</span>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y%m%d_%H%M%S"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s">"sample_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Set generation parameters
</span>        <span class="n">generation_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'duration'</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="s">'temperature'</span><span class="p">:</span> <span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'temperature'</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s">'top_k'</span><span class="p">:</span> <span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'top_k'</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span>
            <span class="s">'top_p'</span><span class="p">:</span> <span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'top_p'</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="n">params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'cfg_coef'</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span><span class="o">**</span><span class="n">generation_params</span><span class="p">)</span>
        
        <span class="c1"># Generate audio
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Generating sample with parameters: </span><span class="si">{</span><span class="n">generation_params</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">wav</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
        
        <span class="c1"># Save the audio
</span>        <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"sample_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">"</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
        <span class="n">audio_write</span><span class="p">(</span>
            <span class="n">output_path</span><span class="p">,</span>
            <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="s">"loudness"</span>
        <span class="p">)</span>
        
        <span class="c1"># Save parameters and prompt
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.json"</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">({</span>
                <span class="s">'prompt'</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                <span class="s">'parameters'</span><span class="p">:</span> <span class="n">generation_params</span><span class="p">,</span>
                <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                <span class="s">'model_size'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span>
            <span class="p">},</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Log to results CSV
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_file</span><span class="p">,</span> <span class="s">'a'</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">''</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">writerow</span><span class="p">([</span>
                <span class="n">timestamp</span><span class="p">,</span>
                <span class="n">prompt</span><span class="p">,</span>
                <span class="n">generation_params</span><span class="p">[</span><span class="s">'temperature'</span><span class="p">],</span>
                <span class="n">generation_params</span><span class="p">[</span><span class="s">'top_k'</span><span class="p">],</span>
                <span class="n">generation_params</span><span class="p">[</span><span class="s">'top_p'</span><span class="p">],</span>
                <span class="n">generation_params</span><span class="p">[</span><span class="s">'cfg_coef'</span><span class="p">],</span>
                <span class="n">duration</span><span class="p">,</span>
                <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">,</span>
                <span class="s">""</span><span class="p">,</span> <span class="c1"># Empty rating to be filled later
</span>                <span class="s">""</span>  <span class="c1"># Empty notes to be filled later
</span>            <span class="p">])</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Generated and saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">.wav"</span>
    
    <span class="k">def</span> <span class="nf">rate_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">rating</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="s">""</span><span class="p">):</span>
        <span class="s">"""
        Rate a generated sample and add notes.
        
        Args:
            file_path (str): Path to the audio file
            rating (int): Rating from 1-10
            notes (str): Optional notes about the quality
        """</span>
        <span class="c1"># Read current CSV
</span>        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_file</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">''</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="n">rows</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_path</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">notes</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">rows</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">updated</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Warning: Could not find </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s"> in results log"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
            
        <span class="c1"># Write updated CSV
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_file</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">''</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
            
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Updated rating for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">rating</span><span class="si">}</span><span class="s">/10"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">generate_parameter_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
        <span class="s">"""
        Generate a series of samples varying one parameter.
        
        Args:
            prompt (str): Text description of the music
            parameter (str): Parameter to vary
            values (list): List of values to test
            duration (float): Length of each sample in seconds
        """</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y%m%d_%H%M%S"</span><span class="p">)</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s">_series_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Default parameters
</span>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'temperature'</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s">'top_k'</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
            <span class="s">'top_p'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="p">}</span>
        
        <span class="c1"># Generate for each value
</span>        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">test_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">test_params</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
            <span class="n">output_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s">"</span>
            <span class="n">sample_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_name</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="p">.</span><span class="n">generate_with_params</span><span class="p">(</span>
                <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">test_params</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="n">sample_dir</span>
            <span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s"> variations in </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dir</span>
    
    <span class="k">def</span> <span class="nf">analyze_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Analyze parameter ratings to identify optimal settings.
        
        Returns:
            dict: Analysis of parameter effects on ratings
        """</span>
        <span class="c1"># Read results CSV
</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_file</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s">''</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>  <span class="c1"># Skip header
</span>            
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="c1"># Skip entries without ratings
</span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span>
                    <span class="k">continue</span>
                    
                <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s">'prompt'</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s">'temperature'</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s">'top_k'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="s">'top_p'</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                    <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                    <span class="s">'duration'</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
                    <span class="s">'output_file'</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                    <span class="s">'rating'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>
                    <span class="s">'notes'</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                <span class="p">})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"No rated samples found. Rate some samples first."</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
            
        <span class="c1"># Calculate average rating for each parameter value
</span>        <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'temperature'</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s">'top_k'</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s">'top_p'</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s">'overall_best'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">'parameter_correlations'</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># For each parameter, group by value and calculate average rating
</span>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'temperature'</span><span class="p">,</span> <span class="s">'top_k'</span><span class="p">,</span> <span class="s">'top_p'</span><span class="p">,</span> <span class="s">'cfg_coef'</span><span class="p">]:</span>
            <span class="n">param_values</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param_values</span><span class="p">:</span>
                    <span class="n">param_values</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">param_values</span><span class="p">[</span><span class="n">value</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s">'rating'</span><span class="p">])</span>
            
            <span class="c1"># Calculate averages
</span>            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">ratings</span> <span class="ow">in</span> <span class="n">param_values</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">avg_rating</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
                <span class="n">analysis</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">'avg_rating'</span><span class="p">:</span> <span class="n">avg_rating</span><span class="p">,</span>
                    <span class="s">'sample_count'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
                <span class="p">}</span>
        
        <span class="c1"># Find overall best-rated sample
</span>        <span class="n">best_sample</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">'rating'</span><span class="p">])</span>
        <span class="n">analysis</span><span class="p">[</span><span class="s">'overall_best'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'prompt'</span><span class="p">:</span> <span class="n">best_sample</span><span class="p">[</span><span class="s">'prompt'</span><span class="p">],</span>
            <span class="s">'parameters'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'temperature'</span><span class="p">:</span> <span class="n">best_sample</span><span class="p">[</span><span class="s">'temperature'</span><span class="p">],</span>
                <span class="s">'top_k'</span><span class="p">:</span> <span class="n">best_sample</span><span class="p">[</span><span class="s">'top_k'</span><span class="p">],</span>
                <span class="s">'top_p'</span><span class="p">:</span> <span class="n">best_sample</span><span class="p">[</span><span class="s">'top_p'</span><span class="p">],</span>
                <span class="s">'cfg_coef'</span><span class="p">:</span> <span class="n">best_sample</span><span class="p">[</span><span class="s">'cfg_coef'</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s">'rating'</span><span class="p">:</span> <span class="n">best_sample</span><span class="p">[</span><span class="s">'rating'</span><span class="p">],</span>
            <span class="s">'output_file'</span><span class="p">:</span> <span class="n">best_sample</span><span class="p">[</span><span class="s">'output_file'</span><span class="p">]</span>
        <span class="p">}</span>
        
        <span class="c1"># Calculate correlations between parameters and ratings
</span>        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
        <span class="n">ratings</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s">'rating'</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'temperature'</span><span class="p">,</span> <span class="s">'top_k'</span><span class="p">,</span> <span class="s">'top_p'</span><span class="p">,</span> <span class="s">'cfg_coef'</span><span class="p">]:</span>
            <span class="n">param_values</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">param_values</span><span class="p">,</span> <span class="n">ratings</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">analysis</span><span class="p">[</span><span class="s">'parameter_correlations'</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlation</span>
        
        <span class="k">return</span> <span class="n">analysis</span>
    
    <span class="k">def</span> <span class="nf">visualize_parameter_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Generate plots showing how parameters affect ratings."""</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">analyze_results</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Create output directory for plots
</span>        <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">results_dir</span><span class="p">,</span> <span class="s">"parameter_plots"</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Plot for each parameter
</span>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'temperature'</span><span class="p">,</span> <span class="s">'top_k'</span><span class="p">,</span> <span class="s">'cfg_coef'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                <span class="k">continue</span>
                
            <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            
            <span class="c1"># Extract data for plotting
</span>            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ratings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="n">param</span><span class="p">].</span><span class="n">items</span><span class="p">():</span>
                <span class="n">values</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">ratings</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'avg_rating'</span><span class="p">])</span>
                <span class="n">counts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'sample_count'</span><span class="p">])</span>
            
            <span class="c1"># Sort by parameter value
</span>            <span class="n">sorted_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">counts</span><span class="p">))</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sorted_data</span><span class="p">]</span>
            <span class="n">ratings</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sorted_data</span><span class="p">]</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sorted_data</span><span class="p">]</span>
            
            <span class="c1"># Plot average ratings
</span>            <span class="n">plt</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">tick_label</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">"Average Rating (1-10)"</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s">"Effect of </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s"> on Music Quality"</span><span class="p">)</span>
            
            <span class="c1"># Add sample counts
</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
                <span class="n">plt</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="sa">f</span><span class="s">"n=</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">'center'</span><span class="p">)</span>
            
            <span class="c1"># Add correlation coefficient
</span>            <span class="n">correlation</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s">'parameter_correlations'</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Correlation: </span><span class="si">{</span><span class="n">correlation</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">'center'</span><span class="p">)</span>
            
            <span class="c1"># Save plot
</span>            <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">_effect.png"</span><span class="p">))</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Create overall recommendations summary
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="s">"parameter_recommendations.txt"</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"PARAMETER OPTIMIZATION RECOMMENDATIONS</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"====================================</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Best overall parameters found:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s">'overall_best'</span><span class="p">]</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"From prompt: </span><span class="se">\"</span><span class="si">{</span><span class="n">best</span><span class="p">[</span><span class="s">'prompt'</span><span class="p">]</span><span class="si">}</span><span class="se">\"\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">best</span><span class="p">[</span><span class="s">'parameters'</span><span class="p">].</span><span class="n">items</span><span class="p">():</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"Rating: </span><span class="si">{</span><span class="n">best</span><span class="p">[</span><span class="s">'rating'</span><span class="p">]</span><span class="si">}</span><span class="s">/10</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Parameter-specific recommendations:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'temperature'</span><span class="p">,</span> <span class="s">'top_k'</span><span class="p">,</span> <span class="s">'cfg_coef'</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                    <span class="k">continue</span>
                    
                <span class="c1"># Find best value for this parameter
</span>                <span class="n">best_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="n">param</span><span class="p">].</span><span class="n">items</span><span class="p">(),</span> 
                                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">'avg_rating'</span><span class="p">])</span>
                
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">: Best value = </span><span class="si">{</span><span class="n">best_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> "</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"(avg rating: </span><span class="si">{</span><span class="n">best_value</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">'avg_rating'</span><span class="p">]:.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">/10)</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            
            <span class="c1"># Add correlation insights
</span>            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Parameter correlations with quality:</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="s">'parameter_correlations'</span><span class="p">].</span><span class="n">items</span><span class="p">():</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="s">"higher is better"</span> <span class="k">if</span> <span class="n">corr</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="k">else</span> <span class="p">(</span>
                    <span class="s">"lower is better"</span> <span class="k">if</span> <span class="n">corr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span> <span class="k">else</span> <span class="s">"minimal effect"</span><span class="p">)</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s">"- </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">corr</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Visualization complete. Plots and recommendations saved to </span><span class="si">{</span><span class="n">plots_dir</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plots_dir</span>
    
    <span class="k">def</span> <span class="nf">get_preset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preset_name</span><span class="p">):</span>
        <span class="s">"""Get parameters from a standard or saved preset."""</span>
        <span class="c1"># Check standard presets first
</span>        <span class="k">if</span> <span class="n">preset_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">standard_presets</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">standard_presets</span><span class="p">[</span><span class="n">preset_name</span><span class="p">]</span>
            
        <span class="c1"># Check saved presets
</span>        <span class="n">preset_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">"parameter_presets"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">preset_name</span><span class="si">}</span><span class="s">.json"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">preset_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">preset_path</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">preset</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">preset</span><span class="p">[</span><span class="s">'parameters'</span><span class="p">]</span>
            
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Preset '</span><span class="si">{</span><span class="n">preset_name</span><span class="si">}</span><span class="s">' not found"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">save_preset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">""</span><span class="p">):</span>
        <span class="s">"""Save a parameter preset for future use."""</span>
        <span class="n">preset</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'name'</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s">'parameters'</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
            <span class="s">'description'</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s">'model_size'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="p">,</span>
            <span class="s">'created'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1"># Create presets directory if it doesn't exist
</span>        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s">"parameter_presets"</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Save preset
</span>        <span class="n">preset_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">"parameter_presets"</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.json"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">preset_path</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">preset</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Saved preset '</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">' to </span><span class="si">{</span><span class="n">preset_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">preset_path</span>
    
    <span class="k">def</span> <span class="nf">export_optimal_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Export the current optimal parameters based on analysis.
        """</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">analyze_results</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">[</span><span class="s">'overall_best'</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Insufficient data for optimization. Rate more samples first."</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
            
        <span class="n">optimal_params</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s">'overall_best'</span><span class="p">][</span><span class="s">'parameters'</span><span class="p">]</span>
        
        <span class="c1"># Save as a preset
</span>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y%m%d"</span><span class="p">)</span>
        <span class="n">preset_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"optimal_params_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s">"</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">save_preset</span><span class="p">(</span>
            <span class="n">preset_name</span><span class="p">,</span>
            <span class="n">optimal_params</span><span class="p">,</span>
            <span class="sa">f</span><span class="s">"Optimized parameters based on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s">'temperature'</span><span class="p">])</span><span class="si">}</span><span class="s"> samples"</span>
        <span class="p">)</span>

<span class="c1"># Example usage
</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">ParameterOptimizationSuite</span><span class="p">(</span><span class="n">model_size</span><span class="o">=</span><span class="s">"medium"</span><span class="p">)</span>
    
    <span class="c1"># Generate samples with different parameters
</span>    <span class="n">prompt</span> <span class="o">=</span> <span class="s">"A cinematic orchestral piece with dramatic strings and brass"</span>
    
    <span class="c1"># Generate with standard presets
</span>    <span class="k">for</span> <span class="n">preset_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"balanced"</span><span class="p">,</span> <span class="s">"creative"</span><span class="p">,</span> <span class="s">"conservative"</span><span class="p">]:</span>
        <span class="n">preset_params</span> <span class="o">=</span> <span class="n">suite</span><span class="p">.</span><span class="n">get_preset</span><span class="p">(</span><span class="n">preset_name</span><span class="p">)</span>
        <span class="n">suite</span><span class="p">.</span><span class="n">generate_with_params</span><span class="p">(</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">preset_params</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="mf">8.0</span>
        <span class="p">)</span>
    
    <span class="c1"># Try temperature variations
</span>    <span class="n">suite</span><span class="p">.</span><span class="n">generate_parameter_series</span><span class="p">(</span>
        <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
        <span class="n">parameter</span><span class="o">=</span><span class="s">"temperature"</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
        <span class="n">duration</span><span class="o">=</span><span class="mf">5.0</span>
    <span class="p">)</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s">"Generated samples with various parameters."</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Listen to the samples and rate them using suite.rate_sample(file_path, rating, notes)"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Then run suite.analyze_results() and suite.visualize_parameter_effects()"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>This complete implementation gives you everything you need to systematically find the best parameters for your use case, including:</p>

<ol>
  <li>A way to generate samples with different parameter settings</li>
  <li>A rating system to track which settings work best</li>
  <li>Analysis tools to identify optimal parameters</li>
  <li>Visualization of parameter effects on music quality</li>
  <li>A preset system for saving and reusing successful parameter combinations</li>
</ol>

<h2 id="common-pitfalls-and-solutions">Common Pitfalls and Solutions</h2>

<h3 id="1-focusing-too-much-on-single-parameters">1. Focusing Too Much on Single Parameters</h3>

<p><strong>Pitfall</strong>: Testing parameters in isolation without considering their interactions.</p>

<p><strong>Solution</strong>: Always test parameter combinations after understanding individual effects. The grid search approach in our ParameterOptimizationSuite handles this systematically.</p>

<h3 id="2-over-optimizing-for-a-specific-prompt">2. Over-Optimizing for a Specific Prompt</h3>

<p><strong>Pitfall</strong>: Finding parameters that work well for one prompt but don’t generalize.</p>

<p><strong>Solution</strong>: Test your parameter settings with multiple different prompts in the same genre or style to ensure they’re robust.</p>

<h3 id="3-ignoring-hardware-constraints">3. Ignoring Hardware Constraints</h3>

<p><strong>Pitfall</strong>: Finding optimal parameters that work on your development machine but cause out-of-memory errors in production.</p>

<p><strong>Solution</strong>: Consider memory usage in your optimization. Higher top_k values and larger models use more memory. Set a realistic memory budget and optimize within those constraints.</p>

<h3 id="4-relying-too-heavily-on-temperature">4. Relying Too Heavily on Temperature</h3>

<p><strong>Pitfall</strong>: Using temperature as the only control knob for generation quality.</p>

<p><strong>Solution</strong>: Explore the full parameter space. Sometimes adjusting cfg_coef or top_k can solve problems more effectively than changing temperature.</p>

<h3 id="5-not-documenting-your-findings">5. Not Documenting Your Findings</h3>

<p><strong>Pitfall</strong>: Finding great parameter combinations but forgetting which settings led to which results.</p>

<p><strong>Solution</strong>: Use the rating and notes features in our ParameterOptimizationSuite to keep track of what works and why.</p>

<h2 id="hands-on-challenge-build-your-own-parameter-presets">Hands-on Challenge: Build Your Own Parameter Presets</h2>

<p>Now that you understand how MusicGen parameters affect generation, it’s time to create your own presets:</p>

<ol>
  <li>Choose a musical genre you want to optimize for</li>
  <li>Using the ParameterOptimizationSuite, test at least three variations of each parameter</li>
  <li>Rate each sample on a scale of 1-10</li>
  <li>Analyze your results to identify trends</li>
  <li>Create and save at least three presets:
    <ul>
      <li>A “safe” preset for reliable, consistent results</li>
      <li>A “balanced” preset for everyday use</li>
      <li>A “creative” preset for experimental exploration</li>
    </ul>
  </li>
  <li>Test your presets with three different prompts to ensure they generalize well</li>
</ol>

<p><strong>Bonus Challenge</strong>: Create a hybrid approach that varies parameters based on prompt content. For example, increase temperature for “experimental” prompts, decrease it for “traditional” prompts.</p>

<h2 id="key-takeaways">Key Takeaways</h2>

<ul>
  <li>MusicGen parameters offer fine-grained control over the generation process</li>
  <li>Temperature is the most impactful parameter, controlling randomness and creativity</li>
  <li>Different genres and applications benefit from different parameter settings</li>
  <li>Systematic parameter testing leads to more consistent, high-quality results</li>
  <li>Parameter optimization is an iterative process that improves with feedback</li>
  <li>Creating parameter presets can save time and improve workflow efficiency</li>
  <li>The interaction between parameters is often more important than individual settings</li>
</ul>

<h2 id="next-steps">Next Steps</h2>

<p>Now that you’ve mastered parameter optimization, you’re ready to move on to more advanced MusicGen features:</p>

<ul>
  <li><strong>Chapter 8: Melody Conditioning</strong> - Learn how to condition MusicGen on existing melodies</li>
  <li><strong>Chapter 9: Batch Processing and Automation</strong> - Scale up your music generation workflow</li>
</ul>

<h2 id="further-reading">Further Reading</h2>

<ul>
  <li><a href="https://github.com/facebookresearch/audiocraft/blob/main/docs/MUSICGEN.md#generation-parameters">AudioCraft GitHub: Generation Parameters</a></li>
  <li><a href="https://huggingface.co/blog/how-to-generate">Sampling Strategies in Language Models</a></li>
  <li><a href="https://arxiv.org/abs/2207.12598">Classifier-Free Guidance Explained</a></li>
  <li><a href="https://arxiv.org/abs/2205.05674">Parameter Optimization for Creative AI</a></li>
  <li><a href="https://arxiv.org/abs/2306.05284">MusicGen: Simple and Controllable Music Generation</a></li>
</ul>

  
  
  
  
  
  
  
  
</div>

<div class="chapter-navigation">
  
  <a href="/chapters/part2/melody-conditioning/" class="prev-chapter">
    <span class="nav-label">Previous</span>
    <span class="nav-title">Melody Conditioning for AI Music Generation</span>
  </a>
  
  
  
  <a href="/chapters/part2/prompt-engineering/" class="next-chapter">
    <span class="nav-label">Next</span>
    <span class="nav-title">Chapter 6: Prompt Engineering for Music</span>
  </a>
  
</div>

<!-- Copyright footer for all chapter pages -->
<div class="copyright-footer">
  <hr>
  <p>
    Copyright © 2025 Scott Friedman.
    <br>
    This work is licensed under the <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.
  </p>
</div>


        </div>
      </main>

      <footer class="site-footer">
        <div class="container">
          <div class="footer-col-wrapper">
            <div class="footer-col">
              <p>A hands-on guide to creating music, sound effects, and audio experiences with AI</p>
              <p>
                <a href="https://github.com/facebookresearch/audiocraft">AudioCraft GitHub Repository</a>
              </p>
            </div>
            <div class="footer-col">
              <p class="copyright">
                Copyright © 2025 Scott Friedman.<br>
                Licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a>.
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>