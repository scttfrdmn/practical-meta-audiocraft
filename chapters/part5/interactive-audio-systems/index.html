<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chapter 20: Interactive Audio Systems</title>
  <meta name="description" content="“Our players are exploring this vast open world we’ve created, but the audio feels static. How can we use AudioCraft to create a dynamic soundscape that resp...">
  <link rel="canonical" href="https://scttfrdmn.github.io/practical-meta-audiocraft/chapters/part5/interactive-audio-systems/">
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .wrapper {
      max-width: 100%;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 20px;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    h1 { color: #1a73e8; }
    h2 { color: #34a853; }
    a {
      color: #1a73e8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .site-header {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
      margin-bottom: 30px;
    }
    .site-title {
      margin: 0;
      font-size: 1.8rem;
    }
    .site-title a {
      color: #1a73e8;
      text-decoration: none;
    }
    .site-nav {
      float: right;
      margin-top: 10px;
    }
    .site-nav .page-link {
      margin-left: 20px;
    }
    .nav-trigger {
      display: none;
    }
    .menu-icon {
      display: none;
    }
    .page-content {
      padding: 20px 0;
    }
    .site-footer {
      border-top: 1px solid #eee;
      padding: 30px 0;
      margin-top: 60px;
    }
    .footer-col-wrapper {
      display: flex;
      flex-wrap: wrap;
    }
    .footer-col {
      flex: 1;
      min-width: 200px;
      padding-right: 20px;
    }
    code {
      background-color: #f5f5f5;
      padding: 2px 5px;
      border-radius: 3px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .highlight {
      background-color: #f5f5f5;
      border-radius: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px 12px;
    }
    th {
      background-color: #f5f5f5;
      text-align: left;
    }
    button, .button {
      display: inline-block;
      background-color: #1a73e8;
      color: white !important;
      padding: 10px 20px;
      border-radius: 4px;
      font-weight: bold;
      margin-top: 20px;
      border: none;
      cursor: pointer;
      text-decoration: none !important;
    }
    button:hover, .button:hover {
      background-color: #0d65d9;
    }
    .feature {
      background-color: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #1a73e8;
      margin-bottom: 20px;
    }
    
    @media screen and (max-width: 600px) {
      .site-nav {
        position: absolute;
        top: 70px;
        right: 20px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        text-align: right;
        padding: 0;
        z-index: 1;
      }
      .site-nav .page-link {
        display: block;
        padding: 10px;
        margin: 0;
      }
      .site-nav .menu-icon {
        display: block;
        float: right;
        width: 36px;
        height: 26px;
        line-height: 0;
        padding-top: 10px;
        text-align: center;
      }
      .site-nav .trigger {
        clear: both;
        display: none;
      }
      .site-nav input:checked ~ .trigger {
        display: block;
        padding-bottom: 5px;
      }
      .footer-col-wrapper {
        flex-direction: column;
      }
      .footer-col {
        margin-bottom: 20px;
      }
    }
  </style>
</head><body>
    <div class="wrapper">
      <header class="site-header">
        <div class="container">
          <h1 class="site-title"><a href="/practical-meta-audiocraft/">Practical Meta AudioCraft</a></h1>
          <nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger" />
            <label for="nav-trigger">
              <span class="menu-icon">
                <svg viewBox="0 0 18 15" width="18px" height="15px">
                  <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484c0-0.82,0.665-1.485,1.484-1.485 h15.032C17.335,0,18,0.665,18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516 c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,6.031,18,6.696,18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516c0-0.82,0.665-1.483,1.484-1.483h15.032 C17.335,12.031,18,12.696,18,13.516z"/>
                </svg>
              </span>
            </label>

            <div class="trigger">
              <a class="page-link" href="/practical-meta-audiocraft/">Home</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part1/introduction/">Getting Started</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part2/basic-music/">MusicGen</a>
              <a class="page-link" href="/practical-meta-audiocraft/chapters/part3/introduction-to-audiogen/">AudioGen</a>
              <a class="page-link" href="/practical-meta-audiocraft/tutorials/getting-started/">Tutorials</a>
            </div>
          </nav>
        </div>
      </header>

      <main class="page-content" aria-label="Content">
        <div class="container">
          <div class="chapter">
  <div class="chapter-header">
    <div class="chapter-metadata">
      <span class="difficulty advanced">Advanced</span>
      <span class="estimated-time">4 hours</span>
    </div>
    <h1>Chapter 20: Interactive Audio Systems</h1>
  </div>
  
  
  
  <blockquote>
  <p>“Our players are exploring this vast open world we’ve created, but the audio feels static. How can we use AudioCraft to create a dynamic soundscape that responds to their actions, changes with the environment, and creates a more immersive experience?” — <em>Maya Chen, Audio Director, Open World Game Studio</em></p>
</blockquote>

<h1 id="chapter-20-interactive-audio-systems">Chapter 20: Interactive Audio Systems</h1>

<h2 id="the-challenge">The Challenge</h2>

<p>Modern interactive applications demand audio that responds dynamically to user actions, environmental conditions, and narrative progression. Traditional approaches using pre-recorded audio assets quickly become limiting—either requiring enormous asset libraries or falling short on variety and responsiveness. Developers and audio designers need systems that can generate appropriate audio on-demand while maintaining cohesive audio experiences across changing conditions.</p>

<p>Creating these interactive audio systems presents several technical challenges: managing transitions between audio states, synchronizing multiple audio elements, developing parameter-driven generation, and implementing efficient real-time processing. These challenges are further complicated by the need to build systems that are both technically robust and creatively expressive.</p>

<p>In this chapter, you’ll learn how to create comprehensive interactive audio systems that leverage AudioCraft’s generative capabilities. We’ll design and implement parameter-driven audio environments, adaptive music systems, and emotion-aware audio that responds contextually to game states and user actions.</p>

<h2 id="learning-objectives">Learning Objectives</h2>

<p>By the end of this chapter, you’ll be able to:</p>

<ul>
  <li>Design responsive audio systems that adapt to user actions and application states</li>
  <li>Implement parameter-driven audio generation for dynamic environments</li>
  <li>Create procedural audio layers that evolve over time based on changing conditions</li>
  <li>Build interactive music systems with seamless, adaptive transitions</li>
  <li>Develop emotion-aware audio that responds intelligently to narrative context</li>
</ul>

<h2 id="prerequisites">Prerequisites</h2>

<p>Before proceeding, ensure you have:</p>
<ul>
  <li>Completed the chapters on basic MusicGen and AudioGen usage</li>
  <li>Completed Chapter 18 on building a complete audio pipeline</li>
  <li>Understanding of parameter-based generation and audio scripting</li>
  <li>Familiarity with Python class design and a basic understanding of Unity C# (for integration examples)</li>
</ul>

<h2 id="key-concepts">Key Concepts</h2>

<h3 id="environmental-parameter-systems">Environmental Parameter Systems</h3>

<p>Interactive audio begins with a well-designed parameter system that captures the relevant aspects of your virtual environment and user actions. These parameters serve as the bridge between your application state and the audio generation process.</p>

<p>Effective parameter systems share certain characteristics. They represent continuous aspects of the environment (such as time, weather intensity, or danger level) as normalized values between 0 and 1, making them easier to interpolate and combine. They include both environmental attributes (like weather type or location) and emotional/narrative states (such as tension or mystery level).</p>

<p>Through carefully designed parameter mapping, even a small set of parameters can create rich, varied, and contextually appropriate audio. The mapping process translates abstract parameters into concrete generation prompts and audio processing settings.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Conceptual example of environmental parameters
</span><span class="n">forest_dawn</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"environment_type"</span><span class="p">:</span> <span class="s">"forest"</span><span class="p">,</span>
    <span class="s">"time_of_day"</span><span class="p">:</span> <span class="mf">6.5</span><span class="p">,</span>       <span class="c1"># Hours (dawn)
</span>    <span class="s">"weather_type"</span><span class="p">:</span> <span class="s">"clear"</span><span class="p">,</span>
    <span class="s">"weather_intensity"</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>  <span class="c1"># Light morning dew
</span>    <span class="s">"tension"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>            <span class="c1"># Peaceful
</span>    <span class="s">"population_density"</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="c1"># Moderate wildlife
</span><span class="p">}</span>

<span class="c1"># Mapping to a generation prompt
</span><span class="n">prompt</span> <span class="o">=</span> <span class="s">"Forest ambience with early morning birds chirping and awakening forest, 
          clear and calm conditions, and moderate wildlife sounds"</span>
</code></pre></div></div>

<h3 id="state-based-audio-architecture">State-Based Audio Architecture</h3>

<p>While continuous parameters provide nuanced control, many applications also benefit from a state-based approach that manages distinct audio modes. Each state represents a specific context (like exploration, combat, or victory) with its own audio characteristics and behavior.</p>

<p>A state-based architecture defines both the properties of each state and the valid transitions between states. This enables controlled progression through different audio experiences while maintaining musical and tonal coherence. Each state can have its own generation parameters, audio processing settings, and layering configuration.</p>

<p>The power of this approach comes from combining predefined state structure with generative variety. Each time a state is triggered, the system can generate new audio content appropriate to that state, creating experiences that are both consistent and novel.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Conceptual example of a music state
</span><span class="n">exploration_state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"state_id"</span><span class="p">:</span> <span class="s">"exploration"</span><span class="p">,</span>
    <span class="s">"description"</span><span class="p">:</span> <span class="s">"Peaceful exploration music with ambient elements"</span><span class="p">,</span>
    <span class="s">"intensity"</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="s">"energy"</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
    <span class="s">"tension"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s">"can_transition_to"</span><span class="p">:</span> <span class="p">[</span><span class="s">"tension"</span><span class="p">,</span> <span class="s">"combat"</span><span class="p">,</span> <span class="s">"discovery"</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Associated generation parameters
</span><span class="n">exploration_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"duration"</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>
    <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s">"cfg_coef"</span><span class="p">:</span> <span class="mf">3.0</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="solution-walkthrough">Solution Walkthrough</h2>

<h3 id="1-building-a-parameter-driven-audio-environment">1. Building a Parameter-Driven Audio Environment</h3>

<p>Let’s begin by implementing a system that dynamically generates environmental audio based on a comprehensive set of parameters:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torchaudio</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">audiocraft.models</span> <span class="kn">import</span> <span class="n">AudioGen</span>

<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">EnvironmentParameters</span><span class="p">:</span>
    <span class="s">"""Parameters that define an audio environment state."""</span>
    
    <span class="c1"># Environment type
</span>    <span class="n">environment_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># e.g., "forest", "city", "dungeon"
</span>    
    <span class="c1"># Time parameters
</span>    <span class="n">time_of_day</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-24 hour
</span>    <span class="n">day_night_cycle</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 transition value
</span>    
    <span class="c1"># Weather parameters
</span>    <span class="n">weather_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># e.g., "clear", "rain", "storm"
</span>    <span class="n">weather_intensity</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 intensity
</span>    <span class="n">wind_intensity</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 intensity
</span>    
    <span class="c1"># Mood/tension parameters
</span>    <span class="n">tension</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 tension level
</span>    <span class="n">danger</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 danger level
</span>    
    <span class="c1"># Population parameters
</span>    <span class="n">population_density</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 population density
</span>    <span class="n">civilization_proximity</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 proximity (0=wilderness, 1=urban)
</span>    
    <span class="c1"># Magic/supernatural parameters
</span>    <span class="n">magic_presence</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 magic level
</span>    <span class="n">supernatural_activity</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 supernatural activity
</span>    
    <span class="c1"># Custom parameters
</span>    <span class="n">custom_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="s">"""Convert to dictionary for serialization."""</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">__dict__</span><span class="p">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">'custom_parameters'</span><span class="p">}</span> <span class="o">|</span> <span class="bp">self</span><span class="p">.</span><span class="n">custom_parameters</span>
    
    <span class="k">def</span> <span class="nf">get_time_period</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Get the time period based on time of day."""</span>
        <span class="k">if</span> <span class="mi">5</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">time_of_day</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"dawn"</span>
        <span class="k">elif</span> <span class="mi">8</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">time_of_day</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"morning"</span>
        <span class="k">elif</span> <span class="mi">12</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">time_of_day</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"afternoon"</span>
        <span class="k">elif</span> <span class="mi">17</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">time_of_day</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"evening"</span>
        <span class="k">elif</span> <span class="mi">20</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">time_of_day</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="ow">or</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">time_of_day</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"night"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"day"</span>
</code></pre></div></div>

<p>Next, let’s implement the <code class="language-plaintext highlighter-rouge">ParametricAudioGenerator</code> class that will transform these parameters into audio:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ParametricAudioGenerator</span><span class="p">:</span>
    <span class="s">"""
    Generates audio based on environmental parameters.
    
    This system takes a set of environmental parameters (weather, time, mood, etc.)
    and generates appropriate audio using AudioCraft models.
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"parametric_audio"</span><span class="p">,</span>
        <span class="n">model_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"medium"</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">):</span>
        <span class="s">"""
        Initialize the parametric audio generator.
        
        Args:
            output_dir: Directory for output files
            model_size: Size of AudioGen model to use
            device: Device to run model on (cuda, mps, cpu)
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">model_size</span>
        
        <span class="c1"># Initialize device
</span>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">,</span> <span class="s">"mps"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"mps"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"cpu"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        
        <span class="c1"># Create output directory
</span>        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Initialize model (lazy loaded)
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Load environment templates
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"environment_templates.json"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">load_templates</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Lazy-load the AudioGen model."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Loading AudioGen model (</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="si">}</span><span class="s">)..."</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">AudioGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_model</span>
    
    <span class="k">def</span> <span class="nf">generate_prompt_from_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">EnvironmentParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""
        Generate a textual prompt based on environmental parameters.
        
        Args:
            params: Environmental parameters
            
        Returns:
            Prompt string for audio generation
        """</span>
        <span class="c1"># Get the environment template
</span>        <span class="k">if</span> <span class="n">params</span><span class="p">.</span><span class="n">environment_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">environment_templates</span><span class="p">:</span>
            <span class="c1"># Fall back to forest if not found
</span>            <span class="n">env_template</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">environment_templates</span><span class="p">[</span><span class="s">"forest"</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env_template</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">environment_templates</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">environment_type</span><span class="p">]</span>
        
        <span class="c1"># Get time description
</span>        <span class="n">time_period</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">get_time_period</span><span class="p">()</span>
        <span class="n">time_desc</span> <span class="o">=</span> <span class="n">env_template</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"time_mapping"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">time_period</span><span class="p">,</span> <span class="n">time_period</span><span class="p">)</span>
        
        <span class="c1"># Get weather description
</span>        <span class="n">weather_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">find_closest_mapping</span><span class="p">(</span>
            <span class="n">env_template</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"weather_mapping"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">params</span><span class="p">.</span><span class="n">weather_type</span><span class="p">,</span>
            <span class="s">"clear"</span>
        <span class="p">)</span>
        <span class="n">weather_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">interpolate_value</span><span class="p">(</span><span class="n">weather_mapping</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">weather_intensity</span><span class="p">)</span>
        
        <span class="c1"># Apply wind modifier if available and significant
</span>        <span class="k">if</span> <span class="n">params</span><span class="p">.</span><span class="n">wind_intensity</span> <span class="o">&gt;</span> <span class="mf">0.3</span> <span class="ow">and</span> <span class="s">"wind_mapping"</span> <span class="ow">in</span> <span class="n">env_template</span><span class="p">:</span>
            <span class="n">wind_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">interpolate_value</span><span class="p">(</span><span class="n">env_template</span><span class="p">[</span><span class="s">"wind_mapping"</span><span class="p">],</span> <span class="n">params</span><span class="p">.</span><span class="n">wind_intensity</span><span class="p">)</span>
            <span class="n">weather_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">weather_desc</span><span class="si">}</span><span class="s"> with </span><span class="si">{</span><span class="n">wind_desc</span><span class="si">}</span><span class="s">"</span>
        
        <span class="c1"># Handle tension/mood
</span>        <span class="k">if</span> <span class="s">"tension_mapping"</span> <span class="ow">in</span> <span class="n">env_template</span><span class="p">:</span>
            <span class="n">tension_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">interpolate_value</span><span class="p">(</span><span class="n">env_template</span><span class="p">[</span><span class="s">"tension_mapping"</span><span class="p">],</span> <span class="n">params</span><span class="p">.</span><span class="n">tension</span><span class="p">)</span>
            <span class="n">mood_desc</span> <span class="o">=</span> <span class="n">tension_desc</span>
        <span class="k">elif</span> <span class="s">"mood_mapping"</span> <span class="ow">in</span> <span class="n">env_template</span><span class="p">:</span>
            <span class="n">mood_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">interpolate_value</span><span class="p">(</span><span class="n">env_template</span><span class="p">[</span><span class="s">"mood_mapping"</span><span class="p">],</span> <span class="n">params</span><span class="p">.</span><span class="n">tension</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mood_desc</span> <span class="o">=</span> <span class="s">"neutral"</span>
        
        <span class="c1"># Handle wildlife/population
</span>        <span class="k">if</span> <span class="s">"wildlife_density_mapping"</span> <span class="ow">in</span> <span class="n">env_template</span><span class="p">:</span>
            <span class="n">wildlife_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">interpolate_value</span><span class="p">(</span>
                <span class="n">env_template</span><span class="p">[</span><span class="s">"wildlife_density_mapping"</span><span class="p">],</span>
                <span class="n">params</span><span class="p">.</span><span class="n">population_density</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wildlife_desc</span> <span class="o">=</span> <span class="s">"moderate"</span>
        
        <span class="c1"># Handle population for urban environments
</span>        <span class="k">if</span> <span class="s">"population_mapping"</span> <span class="ow">in</span> <span class="n">env_template</span><span class="p">:</span>
            <span class="n">population_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">interpolate_value</span><span class="p">(</span>
                <span class="n">env_template</span><span class="p">[</span><span class="s">"population_mapping"</span><span class="p">],</span>
                <span class="n">params</span><span class="p">.</span><span class="n">population_density</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">population_desc</span> <span class="o">=</span> <span class="s">"moderate"</span>
        
        <span class="c1"># Handle supernatural elements
</span>        <span class="k">if</span> <span class="s">"magic_mapping"</span> <span class="ow">in</span> <span class="n">env_template</span><span class="p">:</span>
            <span class="n">supernatural_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">interpolate_value</span><span class="p">(</span>
                <span class="n">env_template</span><span class="p">[</span><span class="s">"magic_mapping"</span><span class="p">],</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">magic_presence</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">supernatural_activity</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s">"supernatural_mapping"</span> <span class="ow">in</span> <span class="n">env_template</span><span class="p">:</span>
            <span class="n">supernatural_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">interpolate_value</span><span class="p">(</span>
                <span class="n">env_template</span><span class="p">[</span><span class="s">"supernatural_mapping"</span><span class="p">],</span>
                <span class="n">params</span><span class="p">.</span><span class="n">supernatural_activity</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">supernatural_desc</span> <span class="o">=</span> <span class="s">""</span>
        
        <span class="c1"># Build the final prompt using the template
</span>        <span class="n">base_prompt</span> <span class="o">=</span> <span class="n">env_template</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"base_prompt"</span><span class="p">,</span> <span class="s">"Environmental ambience with {time_desc} atmosphere"</span><span class="p">)</span>
        
        <span class="c1"># Replace placeholders with actual values
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="n">base_prompt</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
            <span class="n">time_desc</span><span class="o">=</span><span class="n">time_desc</span><span class="p">,</span>
            <span class="n">weather_desc</span><span class="o">=</span><span class="n">weather_desc</span><span class="p">,</span>
            <span class="n">mood_desc</span><span class="o">=</span><span class="n">mood_desc</span><span class="p">,</span>
            <span class="n">wildlife_desc</span><span class="o">=</span><span class="n">wildlife_desc</span><span class="p">,</span>
            <span class="n">population_desc</span><span class="o">=</span><span class="n">population_desc</span><span class="p">,</span>
            <span class="n">supernatural_desc</span><span class="o">=</span><span class="n">supernatural_desc</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">prompt</span>
    
    <span class="k">def</span> <span class="nf">generate_parametric_audio</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">EnvironmentParameters</span><span class="p">,</span>
        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">output_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">generation_params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="s">"""
        Generate audio based on environmental parameters.
        
        Args:
            params: Environmental parameters
            duration: Duration in seconds
            output_filename: Optional filename for saving
            generation_params: Optional generation parameters
            
        Returns:
            Tuple of (audio_tensor, sample_rate, prompt)
        """</span>
        <span class="c1"># Generate the prompt
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">generate_prompt_from_parameters</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        
        <span class="c1"># Default generation parameters
</span>        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"duration"</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s">"cfg_coef"</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
            <span class="s">"top_k"</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
            <span class="s">"top_p"</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="p">}</span>
        
        <span class="c1"># Merge with provided parameters
</span>        <span class="n">gen_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generation_params</span><span class="p">:</span>
            <span class="n">gen_params</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">generation_params</span><span class="p">)</span>
        
        <span class="c1"># Load model
</span>        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_model</span><span class="p">()</span>
        <span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span><span class="o">**</span><span class="n">gen_params</span><span class="p">)</span>
        
        <span class="c1"># Generate audio
</span>        <span class="n">wav</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
        
        <span class="c1"># Save if filename provided
</span>        <span class="k">if</span> <span class="n">output_filename</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">output_filename</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.wav'</span><span class="p">):</span>
                <span class="n">output_filename</span> <span class="o">+=</span> <span class="s">'.wav'</span>
            
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
            <span class="n">torchaudio</span><span class="p">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span>
                <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                <span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span>
            <span class="p">)</span>
            
            <span class="c1"># Save metadata
</span>            <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">output_path</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'.wav'</span><span class="p">,</span> <span class="s">'.json'</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                    <span class="s">"parameters"</span><span class="p">:</span> <span class="n">params</span><span class="p">.</span><span class="n">to_dict</span><span class="p">(),</span>
                    <span class="s">"generation_params"</span><span class="p">:</span> <span class="n">gen_params</span>
                <span class="p">}</span>
                <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Generated audio saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">prompt</span>
</code></pre></div></div>

<h3 id="2-creating-an-interactive-music-system">2. Creating an Interactive Music System</h3>

<p>Next, let’s implement a music generation system that responds to gameplay events and states:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">MusicState</span><span class="p">:</span>
    <span class="s">"""Represents a music state with associated parameters."""</span>
    
    <span class="n">state_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    
    <span class="c1"># Main parameters
</span>    <span class="n">intensity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># 0-1 intensity
</span>    <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># 0-1 energy level
</span>    
    <span class="c1"># Emotional parameters
</span>    <span class="n">tension</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># 0-1 tension level
</span>    <span class="n">danger</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># 0-1 danger level
</span>    <span class="n">mystery</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># 0-1 mystery level
</span>    <span class="n">triumph</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># 0-1 triumph level
</span>    
    <span class="c1"># Musical parameters
</span>    <span class="n">tempo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># BPM
</span>    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"C"</span>  <span class="c1"># Musical key
</span>    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s">"major"</span><span class="p">,</span> <span class="s">"minor"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"major"</span>
    
    <span class="c1"># Transition parameters
</span>    <span class="n">transition_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span>  <span class="c1"># Seconds
</span>    <span class="n">can_transition_to</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    
    <span class="c1"># Generation parameters
</span>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"{description} with {intensity_desc} intensity, {energy_desc} energy, and {emotion_desc} emotion. {tempo} BPM in {key} {mode}."</span>
    <span class="n">generation_params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_intensity_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Get textual description of intensity."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">intensity</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"low"</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">intensity</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"moderate"</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">intensity</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"high"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"very high"</span>
    
    <span class="k">def</span> <span class="nf">get_energy_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Get textual description of energy."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">energy</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"calm"</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">energy</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"steady"</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">energy</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"energetic"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"extremely energetic"</span>
    
    <span class="k">def</span> <span class="nf">get_emotion_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Get the dominant emotion based on parameters."""</span>
        <span class="n">emotions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">tension</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">emotions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"tense </span><span class="si">{</span><span class="s">'and suspenseful'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">tension</span> <span class="o">&gt;</span> <span class="mf">0.75</span> <span class="k">else</span> <span class="s">''</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">danger</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">emotions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"dangerous </span><span class="si">{</span><span class="s">'and threatening'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">danger</span> <span class="o">&gt;</span> <span class="mf">0.75</span> <span class="k">else</span> <span class="s">''</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">mystery</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">emotions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"mysterious </span><span class="si">{</span><span class="s">'and enigmatic'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">mystery</span> <span class="o">&gt;</span> <span class="mf">0.75</span> <span class="k">else</span> <span class="s">''</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">triumph</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">emotions</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"triumphant </span><span class="si">{</span><span class="s">'and victorious'</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">triumph</span> <span class="o">&gt;</span> <span class="mf">0.75</span> <span class="k">else</span> <span class="s">''</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">emotions</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">"major"</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">"uplifting"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">"somber"</span>
        
        <span class="k">return</span> <span class="s">" and "</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">emotions</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""Generate a text prompt based on the music state."""</span>
        <span class="c1"># Get textual descriptions
</span>        <span class="n">intensity_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_intensity_description</span><span class="p">()</span>
        <span class="n">energy_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_energy_description</span><span class="p">()</span>
        <span class="n">emotion_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_emotion_description</span><span class="p">()</span>
        
        <span class="c1"># Format the prompt template
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">prompt_template</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">intensity_desc</span><span class="o">=</span><span class="n">intensity_desc</span><span class="p">,</span>
            <span class="n">energy_desc</span><span class="o">=</span><span class="n">energy_desc</span><span class="p">,</span>
            <span class="n">emotion_desc</span><span class="o">=</span><span class="n">emotion_desc</span><span class="p">,</span>
            <span class="n">tempo</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">tempo</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">mode</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">prompt</span>
</code></pre></div></div>

<p>Now, let’s implement the main <code class="language-plaintext highlighter-rouge">InteractiveMusicSystem</code> class:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">InteractiveMusicSystem</span><span class="p">:</span>
    <span class="s">"""
    Interactive music system that adapts to gameplay events and states.
    
    This system manages a collection of music states and transitions,
    generating adaptive music based on gameplay context.
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"interactive_music"</span><span class="p">,</span>
        <span class="n">model_size</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"small"</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">):</span>
        <span class="s">"""
        Initialize the interactive music system.
        
        Args:
            output_dir: Directory for output files
            model_size: Size of MusicGen model to use
            device: Device to run model on (cuda, mps, cpu)
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">model_size</span> <span class="o">=</span> <span class="n">model_size</span>
        
        <span class="c1"># Initialize device
</span>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"cuda"</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">,</span> <span class="s">"mps"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"mps"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">"cpu"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        
        <span class="c1"># Create output directory
</span>        <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c1"># Initialize model (lazy loaded)
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c1"># Music states
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Load music state definitions
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">states_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">"music_states.json"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">load_states</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Lazy-load the MusicGen model."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Loading MusicGen model (</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="si">}</span><span class="s">)..."</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">MusicGen</span><span class="p">.</span><span class="n">get_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">model_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">_model</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_model</span>
    
    <span class="k">def</span> <span class="nf">create_default_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Create a set of default music states."""</span>
        <span class="c1"># Create exploration, tension, combat, victory, and discovery states
</span>        <span class="n">exploration</span> <span class="o">=</span> <span class="n">MusicState</span><span class="p">(</span>
            <span class="n">state_id</span><span class="o">=</span><span class="s">"exploration"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s">"Peaceful exploration music with ambient elements"</span><span class="p">,</span>
            <span class="n">intensity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="n">energy</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
            <span class="n">tension</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">mystery</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
            <span class="n">tempo</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">"major"</span><span class="p">,</span>
            <span class="n">can_transition_to</span><span class="o">=</span><span class="p">[</span><span class="s">"tension"</span><span class="p">,</span> <span class="s">"combat"</span><span class="p">,</span> <span class="s">"discovery"</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">exploration</span><span class="p">.</span><span class="n">generation_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"duration"</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>
            <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s">"cfg_coef"</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="s">"exploration"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exploration</span>
        
        <span class="c1"># Add other default states...
</span>    
    <span class="k">def</span> <span class="nf">generate_music_for_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">override_params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="s">"""
        Generate music for a specific state.
        
        Args:
            state_id: ID of the music state
            output_filename: Optional filename for saving
            override_params: Optional parameter overrides
            
        Returns:
            Tuple of (audio_tensor, sample_rate, prompt)
        """</span>
        <span class="k">if</span> <span class="n">state_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"State '</span><span class="si">{</span><span class="n">state_id</span><span class="si">}</span><span class="s">' not found"</span><span class="p">)</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">state_id</span><span class="p">]</span>
        
        <span class="c1"># Generate the prompt
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">generate_prompt</span><span class="p">()</span>
        
        <span class="c1"># Get generation parameters
</span>        <span class="n">gen_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">generation_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override_params</span><span class="p">:</span>
            <span class="n">gen_params</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">override_params</span><span class="p">)</span>
        
        <span class="c1"># Load model
</span>        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_model</span><span class="p">()</span>
        <span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span><span class="o">**</span><span class="n">gen_params</span><span class="p">)</span>
        
        <span class="c1"># Generate music
</span>        <span class="n">wav</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
        
        <span class="c1"># Save if filename provided
</span>        <span class="k">if</span> <span class="n">output_filename</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">output_filename</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.wav'</span><span class="p">):</span>
                <span class="n">output_filename</span> <span class="o">+=</span> <span class="s">'.wav'</span>
            
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
            <span class="n">torchaudio</span><span class="p">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span>
                <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                <span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span>
            <span class="p">)</span>
            
            <span class="c1"># Save metadata
</span>            <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">output_path</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'.wav'</span><span class="p">,</span> <span class="s">'.json'</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">"state_id"</span><span class="p">:</span> <span class="n">state_id</span><span class="p">,</span>
                    <span class="s">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
                    <span class="s">"state"</span><span class="p">:</span> <span class="n">state</span><span class="p">.</span><span class="n">to_dict</span><span class="p">(),</span>
                    <span class="s">"generation_params"</span><span class="p">:</span> <span class="n">gen_params</span>
                <span class="p">}</span>
                <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Generated music saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">prompt</span>
    
    <span class="k">def</span> <span class="nf">generate_transition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">from_state_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">to_state_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="s">"""
        Generate a transition between two music states.
        
        Args:
            from_state_id: Starting state ID
            to_state_id: Target state ID
            output_filename: Optional filename for saving
            duration: Optional duration override
            
        Returns:
            Tuple of (audio_tensor, sample_rate, prompt)
        """</span>
        <span class="k">if</span> <span class="n">from_state_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"State '</span><span class="si">{</span><span class="n">from_state_id</span><span class="si">}</span><span class="s">' not found"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">to_state_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"State '</span><span class="si">{</span><span class="n">to_state_id</span><span class="si">}</span><span class="s">' not found"</span><span class="p">)</span>
        
        <span class="n">from_state</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">from_state_id</span><span class="p">]</span>
        <span class="n">to_state</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">states</span><span class="p">[</span><span class="n">to_state_id</span><span class="p">]</span>
        
        <span class="c1"># Check if transition is allowed
</span>        <span class="k">if</span> <span class="n">to_state_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">from_state</span><span class="p">.</span><span class="n">can_transition_to</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Warning: Transition from '</span><span class="si">{</span><span class="n">from_state_id</span><span class="si">}</span><span class="s">' to '</span><span class="si">{</span><span class="n">to_state_id</span><span class="si">}</span><span class="s">' is not defined as allowed"</span><span class="p">)</span>
        
        <span class="c1"># Create blend of the two states
</span>        <span class="n">transition_state</span> <span class="o">=</span> <span class="n">MusicState</span><span class="p">(</span>
            <span class="n">state_id</span><span class="o">=</span><span class="sa">f</span><span class="s">"transition_</span><span class="si">{</span><span class="n">from_state_id</span><span class="si">}</span><span class="s">_to_</span><span class="si">{</span><span class="n">to_state_id</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s">"Transition from </span><span class="si">{</span><span class="n">from_state</span><span class="p">.</span><span class="n">description</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">to_state</span><span class="p">.</span><span class="n">description</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
            <span class="n">intensity</span><span class="o">=</span><span class="p">(</span><span class="n">from_state</span><span class="p">.</span><span class="n">intensity</span> <span class="o">+</span> <span class="n">to_state</span><span class="p">.</span><span class="n">intensity</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">energy</span><span class="o">=</span><span class="p">(</span><span class="n">from_state</span><span class="p">.</span><span class="n">energy</span> <span class="o">+</span> <span class="n">to_state</span><span class="p">.</span><span class="n">energy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">tension</span><span class="o">=</span><span class="p">(</span><span class="n">from_state</span><span class="p">.</span><span class="n">tension</span> <span class="o">+</span> <span class="n">to_state</span><span class="p">.</span><span class="n">tension</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">danger</span><span class="o">=</span><span class="p">(</span><span class="n">from_state</span><span class="p">.</span><span class="n">danger</span> <span class="o">+</span> <span class="n">to_state</span><span class="p">.</span><span class="n">danger</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">mystery</span><span class="o">=</span><span class="p">(</span><span class="n">from_state</span><span class="p">.</span><span class="n">mystery</span> <span class="o">+</span> <span class="n">to_state</span><span class="p">.</span><span class="n">mystery</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">triumph</span><span class="o">=</span><span class="p">(</span><span class="n">from_state</span><span class="p">.</span><span class="n">triumph</span> <span class="o">+</span> <span class="n">to_state</span><span class="p">.</span><span class="n">triumph</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">tempo</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">from_state</span><span class="p">.</span><span class="n">tempo</span> <span class="o">+</span> <span class="n">to_state</span><span class="p">.</span><span class="n">tempo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="n">to_state</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>  <span class="c1"># Use target key for better transition
</span>            <span class="n">mode</span><span class="o">=</span><span class="n">to_state</span><span class="p">.</span><span class="n">mode</span>  <span class="c1"># Use target mode for better transition
</span>        <span class="p">)</span>
        
        <span class="c1"># Set transition prompt template
</span>        <span class="n">transition_state</span><span class="p">.</span><span class="n">prompt_template</span> <span class="o">=</span> <span class="s">"Transition music bridging {description}. Moving from {intensity_desc} intensity to {energy_desc} energy with {emotion_desc} emotion. {tempo} BPM in {key} {mode}."</span>
        
        <span class="c1"># Determine duration
</span>        <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Use average of the two states' transition times, or a default
</span>            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">from_state</span><span class="p">.</span><span class="n">transition_time</span> <span class="o">+</span> <span class="n">to_state</span><span class="p">.</span><span class="n">transition_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># Set generation parameters
</span>        <span class="n">transition_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"duration"</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="s">"temperature"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># Higher temperature for more variation
</span>            <span class="s">"cfg_coef"</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="p">}</span>
        
        <span class="c1"># Generate the transition music
</span>        <span class="k">if</span> <span class="n">output_filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"transition_</span><span class="si">{</span><span class="n">from_state_id</span><span class="si">}</span><span class="s">_to_</span><span class="si">{</span><span class="n">to_state_id</span><span class="si">}</span><span class="s">.wav"</span>
        
        <span class="c1"># The transition state ID doesn't exist in our states dictionary,
</span>        <span class="c1"># but we can still use generate_music_for_state by passing parameters directly
</span>        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_model</span><span class="p">()</span>
        <span class="n">model</span><span class="p">.</span><span class="n">set_generation_params</span><span class="p">(</span><span class="o">**</span><span class="n">transition_params</span><span class="p">)</span>
        
        <span class="c1"># Generate using the transition state
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="n">transition_state</span><span class="p">.</span><span class="n">generate_prompt</span><span class="p">()</span>
        <span class="n">wav</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">generate</span><span class="p">([</span><span class="n">prompt</span><span class="p">])</span>
        
        <span class="c1"># Save if filename provided
</span>        <span class="k">if</span> <span class="n">output_filename</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
            <span class="n">torchaudio</span><span class="p">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">output_path</span><span class="p">,</span>
                <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cpu</span><span class="p">(),</span>
                <span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span>
            <span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Transition audio saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">wav</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">prompt</span>
</code></pre></div></div>

<h3 id="3-runtime-integration-with-unity">3. Runtime Integration with Unity</h3>

<p>To use our generated audio effectively in real-time applications, let’s create a Unity C# script that handles interactive audio playback:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.Audio</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">GameAudio</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Parameter-driven audio controller for dynamic audio environments.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AudioParameter</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">10f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">changeSensitivity</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">triggersUpdate</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">lastUpdateValue</span><span class="p">;</span>
        
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">HasSignificantChange</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">float</span> <span class="n">delta</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="k">value</span> <span class="p">-</span> <span class="n">lastUpdateValue</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">delta</span> <span class="p">&gt;</span> <span class="p">(</span><span class="m">0.05f</span> <span class="p">/</span> <span class="n">changeSensitivity</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">public</span> <span class="k">void</span> <span class="nf">MarkUpdated</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">lastUpdateValue</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AudioLayer</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">AudioClip</span><span class="p">[]</span> <span class="n">possibleClips</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">volume</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">spatialBlend</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">loop</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Parameter Influence"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">primaryParameter</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(-</span><span class="m">1f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">primaryInfluence</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">secondaryParameter</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(-</span><span class="m">1f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">secondaryInfluence</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
        
        <span class="p">[</span><span class="n">HideInInspector</span><span class="p">]</span> <span class="k">public</span> <span class="n">AudioSource</span> <span class="n">source</span><span class="p">;</span>
        <span class="p">[</span><span class="n">HideInInspector</span><span class="p">]</span> <span class="k">public</span> <span class="kt">int</span> <span class="n">lastClipIndex</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AudioState</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">AudioClip</span> <span class="n">primaryClip</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">AudioClip</span><span class="p">[]</span> <span class="n">layerClips</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">transitionTime</span> <span class="p">=</span> <span class="m">2f</span><span class="p">;</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Parameter Thresholds"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">triggerParameter</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">minimumValue</span> <span class="p">=</span> <span class="m">0.7f</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">class</span> <span class="nc">InteractiveAudioController</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Audio Layers"</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AudioLayer</span><span class="p">&gt;</span> <span class="n">audioLayers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AudioLayer</span><span class="p">&gt;();</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Parameters"</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AudioParameter</span><span class="p">&gt;</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AudioParameter</span><span class="p">&gt;();</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"States"</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AudioState</span><span class="p">&gt;</span> <span class="n">audioStates</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">AudioState</span><span class="p">&gt;();</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">string</span> <span class="n">defaultState</span><span class="p">;</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Settings"</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">AudioMixerGroup</span> <span class="n">mixerGroup</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">updateInterval</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">crossfadeDuration</span> <span class="p">=</span> <span class="m">1.5f</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">bool</span> <span class="n">debugMode</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        
        <span class="c1">// Internal state</span>
        <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AudioParameter</span><span class="p">&gt;</span> <span class="n">parameterLookup</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AudioParameter</span><span class="p">&gt;();</span>
        <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AudioState</span><span class="p">&gt;</span> <span class="n">stateLookup</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">AudioState</span><span class="p">&gt;();</span>
        <span class="k">private</span> <span class="n">AudioState</span> <span class="n">currentState</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">float</span> <span class="n">timeSinceLastUpdate</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">bool</span> <span class="n">initialized</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Initialize</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            
            <span class="c1">// Create parameter lookup</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">param</span> <span class="k">in</span> <span class="n">parameters</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">parameterLookup</span><span class="p">[</span><span class="n">param</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="p">=</span> <span class="n">param</span><span class="p">;</span>
                <span class="n">param</span><span class="p">.</span><span class="nf">MarkUpdated</span><span class="p">();</span>
            <span class="p">}</span>
            
            <span class="c1">// Create state lookup</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">state</span> <span class="k">in</span> <span class="n">audioStates</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stateLookup</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Initialize audio sources for layers</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">layer</span> <span class="k">in</span> <span class="n">audioLayers</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">sourceObj</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GameObject</span><span class="p">(</span><span class="s">$"Layer - </span><span class="p">{</span><span class="n">layer</span><span class="p">.</span><span class="n">name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="n">sourceObj</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="nf">SetParent</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
                
                <span class="n">layer</span><span class="p">.</span><span class="n">source</span> <span class="p">=</span> <span class="n">sourceObj</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
                <span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">outputAudioMixerGroup</span> <span class="p">=</span> <span class="n">mixerGroup</span><span class="p">;</span>
                <span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">playOnAwake</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">loop</span> <span class="p">=</span> <span class="n">layer</span><span class="p">.</span><span class="n">loop</span><span class="p">;</span>
                <span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">spatialBlend</span> <span class="p">=</span> <span class="n">layer</span><span class="p">.</span><span class="n">spatialBlend</span><span class="p">;</span>
                <span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span> <span class="c1">// Start silent</span>
            <span class="p">}</span>
            
            <span class="c1">// Set default state</span>
            <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">defaultState</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">stateLookup</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">defaultState</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="nf">TransitionToState</span><span class="p">(</span><span class="n">defaultState</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="n">initialized</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">initialized</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">Initialize</span><span class="p">();</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Check for parameter updates</span>
            <span class="n">timeSinceLastUpdate</span> <span class="p">+=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">timeSinceLastUpdate</span> <span class="p">&gt;=</span> <span class="n">updateInterval</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">bool</span> <span class="n">shouldUpdate</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                
                <span class="c1">// Check if any parameters have changed significantly</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">param</span> <span class="k">in</span> <span class="n">parameters</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">triggersUpdate</span> <span class="p">&amp;&amp;</span> <span class="n">param</span><span class="p">.</span><span class="nf">HasSignificantChange</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="n">shouldUpdate</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                        <span class="n">param</span><span class="p">.</span><span class="nf">MarkUpdated</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                
                <span class="c1">// Check for state transitions based on parameters</span>
                <span class="nf">CheckStateTransitions</span><span class="p">();</span>
                
                <span class="c1">// Update audio based on parameters</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">shouldUpdate</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nf">UpdateAudioLayers</span><span class="p">();</span>
                <span class="p">}</span>
                
                <span class="n">timeSinceLastUpdate</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">CheckStateTransitions</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">state</span> <span class="k">in</span> <span class="n">audioStates</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="p">==</span> <span class="n">currentState</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">triggerParameter</span><span class="p">)</span> <span class="p">&amp;&amp;</span> 
                    <span class="n">parameterLookup</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">triggerParameter</span><span class="p">,</span> <span class="k">out</span> <span class="n">AudioParameter</span> <span class="n">param</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="k">value</span> <span class="p">&gt;=</span> <span class="n">state</span><span class="p">.</span><span class="n">minimumValue</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nf">TransitionToState</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateAudioLayers</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">layer</span> <span class="k">in</span> <span class="n">audioLayers</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Calculate layer volume based on parameters</span>
                <span class="kt">float</span> <span class="n">parameterFactor</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">primaryParameter</span><span class="p">)</span> <span class="p">&amp;&amp;</span> 
                    <span class="n">parameterLookup</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">primaryParameter</span><span class="p">,</span> <span class="k">out</span> <span class="n">AudioParameter</span> <span class="n">primaryParam</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">// Apply primary influence (positive or negative)</span>
                    <span class="kt">float</span> <span class="n">primaryFactor</span> <span class="p">=</span> <span class="n">layer</span><span class="p">.</span><span class="n">primaryInfluence</span> <span class="p">&gt;</span> <span class="m">0</span> 
                        <span class="p">?</span> <span class="n">primaryParam</span><span class="p">.</span><span class="k">value</span> <span class="p">*</span> <span class="n">layer</span><span class="p">.</span><span class="n">primaryInfluence</span>
                        <span class="p">:</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">primaryParam</span><span class="p">.</span><span class="k">value</span><span class="p">)</span> <span class="p">*</span> <span class="p">-</span><span class="n">layer</span><span class="p">.</span><span class="n">primaryInfluence</span><span class="p">;</span>
                    
                    <span class="n">parameterFactor</span> <span class="p">*=</span> <span class="n">primaryFactor</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">secondaryParameter</span><span class="p">)</span> <span class="p">&amp;&amp;</span> 
                    <span class="n">parameterLookup</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">secondaryParameter</span><span class="p">,</span> <span class="k">out</span> <span class="n">AudioParameter</span> <span class="n">secondaryParam</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">// Apply secondary influence (positive or negative)</span>
                    <span class="kt">float</span> <span class="n">secondaryFactor</span> <span class="p">=</span> <span class="n">layer</span><span class="p">.</span><span class="n">secondaryInfluence</span> <span class="p">&gt;</span> <span class="m">0</span> 
                        <span class="p">?</span> <span class="n">secondaryParam</span><span class="p">.</span><span class="k">value</span> <span class="p">*</span> <span class="n">layer</span><span class="p">.</span><span class="n">secondaryInfluence</span>
                        <span class="p">:</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">secondaryParam</span><span class="p">.</span><span class="k">value</span><span class="p">)</span> <span class="p">*</span> <span class="p">-</span><span class="n">layer</span><span class="p">.</span><span class="n">secondaryInfluence</span><span class="p">;</span>
                    
                    <span class="n">parameterFactor</span> <span class="p">*=</span> <span class="n">secondaryFactor</span><span class="p">;</span>
                <span class="p">}</span>
                
                <span class="c1">// Apply parameter factor to layer volume</span>
                <span class="kt">float</span> <span class="n">targetVolume</span> <span class="p">=</span> <span class="n">layer</span><span class="p">.</span><span class="n">volume</span> <span class="p">*</span> <span class="n">parameterFactor</span><span class="p">;</span>
                
                <span class="c1">// Update audio source</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">!=</span> <span class="n">targetVolume</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">FadeVolume</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">targetVolume</span><span class="p">,</span> <span class="n">crossfadeDuration</span><span class="p">));</span>
                <span class="p">}</span>
                
                <span class="c1">// Choose appropriate clip if needed</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">possibleClips</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">layer</span><span class="p">.</span><span class="n">possibleClips</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// Get parameter value for clip selection</span>
                    <span class="kt">float</span> <span class="n">selectionValue</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
                    
                    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">primaryParameter</span><span class="p">)</span> <span class="p">&amp;&amp;</span> 
                        <span class="n">parameterLookup</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">primaryParameter</span><span class="p">,</span> <span class="k">out</span> <span class="n">AudioParameter</span> <span class="n">selectionParam</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="n">selectionValue</span> <span class="p">=</span> <span class="n">selectionParam</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
                    <span class="p">}</span>
                    
                    <span class="c1">// Map parameter value to clip index</span>
                    <span class="kt">int</span> <span class="n">clipIndex</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">FloorToInt</span><span class="p">(</span><span class="n">selectionValue</span> <span class="p">*</span> <span class="n">layer</span><span class="p">.</span><span class="n">possibleClips</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                    <span class="n">clipIndex</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="n">clipIndex</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">layer</span><span class="p">.</span><span class="n">possibleClips</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
                    
                    <span class="c1">// Change clip if needed</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">clipIndex</span> <span class="p">!=</span> <span class="n">layer</span><span class="p">.</span><span class="n">lastClipIndex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">layer</span><span class="p">.</span><span class="n">lastClipIndex</span> <span class="p">=</span> <span class="n">clipIndex</span><span class="p">;</span>
                        
                        <span class="c1">// Only change clip if significant parameter change</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">selectionValue</span> <span class="p">-</span> <span class="m">0.5f</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0.2f</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">CrossfadeClip</span><span class="p">(</span>
                                <span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> 
                                <span class="n">layer</span><span class="p">.</span><span class="n">possibleClips</span><span class="p">[</span><span class="n">clipIndex</span><span class="p">],</span> 
                                <span class="n">crossfadeDuration</span>
                            <span class="p">));</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                
                <span class="c1">// Ensure layer is playing</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">isPlaying</span> <span class="p">&amp;&amp;</span> <span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">clip</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">layer</span><span class="p">.</span><span class="n">loop</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="nf">Play</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">public</span> <span class="k">void</span> <span class="nf">SetParameter</span><span class="p">(</span><span class="kt">string</span> <span class="n">paramName</span><span class="p">,</span> <span class="kt">float</span> <span class="k">value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">parameterLookup</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="k">out</span> <span class="n">AudioParameter</span> <span class="n">param</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">param</span><span class="p">.</span><span class="k">value</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp01</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">debugMode</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"[InteractiveAudio] Parameter '</span><span class="p">{</span><span class="n">paramName</span><span class="p">}</span><span class="s">' set to </span><span class="p">{</span><span class="n">param</span><span class="p">.</span><span class="k">value</span><span class="p">:</span><span class="n">F2</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debugMode</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"[InteractiveAudio] Parameter '</span><span class="p">{</span><span class="n">paramName</span><span class="p">}</span><span class="s">' not found"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">public</span> <span class="k">void</span> <span class="nf">TransitionToState</span><span class="p">(</span><span class="kt">string</span> <span class="n">stateName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">stateLookup</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">stateName</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"[InteractiveAudio] State '</span><span class="p">{</span><span class="n">stateName</span><span class="p">}</span><span class="s">' not found"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="n">AudioState</span> <span class="n">newState</span> <span class="p">=</span> <span class="n">stateLookup</span><span class="p">[</span><span class="n">stateName</span><span class="p">];</span>
            <span class="n">AudioState</span> <span class="n">previousState</span> <span class="p">=</span> <span class="n">currentState</span><span class="p">;</span>
            <span class="n">currentState</span> <span class="p">=</span> <span class="n">newState</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">debugMode</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"[InteractiveAudio] Transitioning to state: </span><span class="p">{</span><span class="n">stateName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="c1">// Setup transition</span>
            <span class="kt">float</span> <span class="n">transitionTime</span> <span class="p">=</span> <span class="n">newState</span><span class="p">.</span><span class="n">transitionTime</span><span class="p">;</span>
            
            <span class="c1">// Apply primary clip to first layer if available</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newState</span><span class="p">.</span><span class="n">primaryClip</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">audioLayers</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">primaryLayer</span> <span class="p">=</span> <span class="n">audioLayers</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
                <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">CrossfadeClip</span><span class="p">(</span><span class="n">primaryLayer</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">newState</span><span class="p">.</span><span class="n">primaryClip</span><span class="p">,</span> <span class="n">transitionTime</span><span class="p">));</span>
            <span class="p">}</span>
            
            <span class="c1">// Apply layer clips</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newState</span><span class="p">.</span><span class="n">layerClips</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">newState</span><span class="p">.</span><span class="n">layerClips</span><span class="p">.</span><span class="n">Length</span> <span class="p">&amp;&amp;</span> <span class="n">i</span> <span class="p">+</span> <span class="m">1</span> <span class="p">&lt;</span> <span class="n">audioLayers</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">layer</span> <span class="p">=</span> <span class="n">audioLayers</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">newState</span><span class="p">.</span><span class="n">layerClips</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">CrossfadeClip</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">newState</span><span class="p">.</span><span class="n">layerClips</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">transitionTime</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IEnumerator</span> <span class="nf">CrossfadeClip</span><span class="p">(</span>
            <span class="n">AudioSource</span> <span class="n">source</span><span class="p">,</span> <span class="n">AudioClip</span> <span class="n">newClip</span><span class="p">,</span> <span class="kt">float</span> <span class="n">fadeDuration</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">newClip</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
            
            <span class="c1">// If the source isn't playing at all, just set the clip directly</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">source</span><span class="p">.</span><span class="n">isPlaying</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">source</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">newClip</span><span class="p">;</span>
                <span class="n">source</span><span class="p">.</span><span class="nf">Play</span><span class="p">();</span>
                <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Remember the original volume</span>
            <span class="kt">float</span> <span class="n">originalVolume</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">volume</span><span class="p">;</span>
            
            <span class="c1">// Fade out current clip</span>
            <span class="kt">float</span> <span class="n">timeElapsed</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">timeElapsed</span> <span class="p">&lt;</span> <span class="n">fadeDuration</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Lerp</span><span class="p">(</span><span class="n">originalVolume</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">timeElapsed</span> <span class="p">/</span> <span class="p">(</span><span class="n">fadeDuration</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">));</span>
                <span class="n">timeElapsed</span> <span class="p">+=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
                <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Change clip</span>
            <span class="n">source</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
            <span class="n">source</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">newClip</span><span class="p">;</span>
            <span class="n">source</span><span class="p">.</span><span class="nf">Play</span><span class="p">();</span>
            <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
            
            <span class="c1">// Fade in new clip</span>
            <span class="n">timeElapsed</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">timeElapsed</span> <span class="p">&lt;</span> <span class="n">fadeDuration</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Lerp</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">originalVolume</span><span class="p">,</span> <span class="n">timeElapsed</span> <span class="p">/</span> <span class="p">(</span><span class="n">fadeDuration</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">));</span>
                <span class="n">timeElapsed</span> <span class="p">+=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
                <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Ensure we end at the exact target volume</span>
            <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">originalVolume</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IEnumerator</span> <span class="nf">FadeVolume</span><span class="p">(</span>
            <span class="n">AudioSource</span> <span class="n">source</span><span class="p">,</span> <span class="kt">float</span> <span class="n">targetVolume</span><span class="p">,</span> <span class="kt">float</span> <span class="n">fadeDuration</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
            
            <span class="kt">float</span> <span class="n">startVolume</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">volume</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">timeElapsed</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
            
            <span class="k">while</span> <span class="p">(</span><span class="n">timeElapsed</span> <span class="p">&lt;</span> <span class="n">fadeDuration</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Lerp</span><span class="p">(</span><span class="n">startVolume</span><span class="p">,</span> <span class="n">targetVolume</span><span class="p">,</span> <span class="n">timeElapsed</span> <span class="p">/</span> <span class="n">fadeDuration</span><span class="p">);</span>
                <span class="n">timeElapsed</span> <span class="p">+=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
                <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Ensure we end at the exact target volume</span>
            <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">targetVolume</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="4-implementing-emotion-driven-audio">4. Implementing Emotion-Driven Audio</h3>

<p>Finally, let’s create a system that maps emotional states to audio generation parameters:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">GameAudio</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Maps emotional states to audio parameters to drive</span>
    <span class="c1">/// emotion-aware audio systems.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmotionalState</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Core Emotions"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">joy</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">sadness</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">fear</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">anger</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">surprise</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">disgust</span><span class="p">;</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Extended Emotions"</span><span class="p">)]</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">tension</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">mystery</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">triumph</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">serenity</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)]</span> <span class="k">public</span> <span class="kt">float</span> <span class="n">despair</span><span class="p">;</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Sound Design"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">musicIntensity</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">musicEnergy</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">ambientTension</span> <span class="p">=</span> <span class="m">0.0f</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">float</span> <span class="n">reverbAmount</span> <span class="p">=</span> <span class="m">0.0f</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">suggestedAudioState</span><span class="p">;</span>
        
        <span class="k">public</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="nf">ToParameterDictionary</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;</span>
            <span class="p">{</span>
                <span class="p">{</span> <span class="s">"joy"</span><span class="p">,</span> <span class="n">joy</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"sadness"</span><span class="p">,</span> <span class="n">sadness</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"fear"</span><span class="p">,</span> <span class="n">fear</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"anger"</span><span class="p">,</span> <span class="n">anger</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"surprise"</span><span class="p">,</span> <span class="n">surprise</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"disgust"</span><span class="p">,</span> <span class="n">disgust</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"tension"</span><span class="p">,</span> <span class="n">tension</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"mystery"</span><span class="p">,</span> <span class="n">mystery</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"triumph"</span><span class="p">,</span> <span class="n">triumph</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"serenity"</span><span class="p">,</span> <span class="n">serenity</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"despair"</span><span class="p">,</span> <span class="n">despair</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"musicIntensity"</span><span class="p">,</span> <span class="n">musicIntensity</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"musicEnergy"</span><span class="p">,</span> <span class="n">musicEnergy</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"ambientTension"</span><span class="p">,</span> <span class="n">ambientTension</span> <span class="p">},</span>
                <span class="p">{</span> <span class="s">"reverbAmount"</span><span class="p">,</span> <span class="n">reverbAmount</span> <span class="p">}</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">class</span> <span class="nc">EmotionAwareAudioSystem</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">EmotionalState</span><span class="p">&gt;</span> <span class="n">emotionalStates</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">EmotionalState</span><span class="p">&gt;();</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">string</span> <span class="n">currentState</span> <span class="p">=</span> <span class="s">"neutral"</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">blendDuration</span> <span class="p">=</span> <span class="m">3.0f</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">bool</span> <span class="n">debugMode</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        
        <span class="p">[</span><span class="nf">Header</span><span class="p">(</span><span class="s">"Audio Controllers"</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">InteractiveAudioController</span> <span class="n">audioController</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">AudioSource</span> <span class="n">ambienceSource</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">AudioSource</span> <span class="n">musicSource</span><span class="p">;</span>
        <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">AudioMixerGroup</span> <span class="n">mixerGroup</span><span class="p">;</span>
        
        <span class="c1">// Internal state</span>
        <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">EmotionalState</span><span class="p">&gt;</span> <span class="n">stateLookup</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">EmotionalState</span><span class="p">&gt;();</span>
        <span class="k">private</span> <span class="n">EmotionalState</span> <span class="n">activeState</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">EmotionalState</span> <span class="n">targetState</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">float</span> <span class="n">blendProgress</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">currentParameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;();</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Initialize</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// Create state lookup</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">state</span> <span class="k">in</span> <span class="n">emotionalStates</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stateLookup</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Set initial state</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stateLookup</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="k">out</span> <span class="n">EmotionalState</span> <span class="n">initialState</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">activeState</span> <span class="p">=</span> <span class="n">initialState</span><span class="p">;</span>
                <span class="n">targetState</span> <span class="p">=</span> <span class="n">initialState</span><span class="p">;</span>
                <span class="nf">ApplyEmotionalState</span><span class="p">(</span><span class="n">initialState</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">emotionalStates</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Default to first state</span>
                <span class="n">activeState</span> <span class="p">=</span> <span class="n">emotionalStates</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
                <span class="n">targetState</span> <span class="p">=</span> <span class="n">activeState</span><span class="p">;</span>
                <span class="nf">ApplyEmotionalState</span><span class="p">(</span><span class="n">activeState</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="c1">// Find audio controller if not set</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">audioController</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">audioController</span> <span class="p">=</span> <span class="n">FindObjectOfType</span><span class="p">&lt;</span><span class="n">InteractiveAudioController</span><span class="p">&gt;();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// Handle blending between states</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">blendProgress</span> <span class="p">&lt;</span> <span class="m">1.0f</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">blendProgress</span> <span class="p">+=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span> <span class="p">/</span> <span class="n">blendDuration</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">blendProgress</span> <span class="p">&gt;=</span> <span class="m">1.0f</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// Blend complete</span>
                    <span class="n">blendProgress</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
                    <span class="n">activeState</span> <span class="p">=</span> <span class="n">targetState</span><span class="p">;</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="n">debugMode</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"[EmotionAudio] Blend to </span><span class="p">{</span><span class="n">targetState</span><span class="p">.</span><span class="n">name</span><span class="p">}</span><span class="s"> complete"</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// Update blended parameters</span>
                    <span class="nf">UpdateBlendedParameters</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">public</span> <span class="k">void</span> <span class="nf">SetEmotionalState</span><span class="p">(</span><span class="kt">string</span> <span class="n">stateName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">instant</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">stateLookup</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">stateName</span><span class="p">,</span> <span class="k">out</span> <span class="n">EmotionalState</span> <span class="n">newState</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">LogWarning</span><span class="p">(</span><span class="s">$"[EmotionAudio] Emotional state '</span><span class="p">{</span><span class="n">stateName</span><span class="p">}</span><span class="s">' not found"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">debugMode</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"[EmotionAudio] Setting emotional state to: </span><span class="p">{</span><span class="n">stateName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="c1">// Set target state</span>
            <span class="n">targetState</span> <span class="p">=</span> <span class="n">newState</span><span class="p">;</span>
            <span class="n">currentState</span> <span class="p">=</span> <span class="n">stateName</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">instant</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Apply immediately</span>
                <span class="n">activeState</span> <span class="p">=</span> <span class="n">targetState</span><span class="p">;</span>
                <span class="n">blendProgress</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
                <span class="nf">ApplyEmotionalState</span><span class="p">(</span><span class="n">activeState</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">// Start blending</span>
                <span class="n">blendProgress</span> <span class="p">=</span> <span class="m">0.0f</span><span class="p">;</span>
                
                <span class="c1">// Initialize blend with current parameters</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">activeState</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">currentParameters</span> <span class="p">=</span> <span class="n">activeState</span><span class="p">.</span><span class="nf">ToParameterDictionary</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">currentParameters</span> <span class="p">=</span> <span class="n">targetState</span><span class="p">.</span><span class="nf">ToParameterDictionary</span><span class="p">();</span>
                    <span class="n">blendProgress</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateBlendedParameters</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">activeState</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">targetState</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
            
            <span class="c1">// Get parameter dictionaries</span>
            <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">targetParams</span> <span class="p">=</span> <span class="n">targetState</span><span class="p">.</span><span class="nf">ToParameterDictionary</span><span class="p">();</span>
            
            <span class="c1">// Create blended dictionary</span>
            <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">blendedParams</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;();</span>
            
            <span class="c1">// Blend parameters</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">kvp</span> <span class="k">in</span> <span class="n">targetParams</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">float</span> <span class="n">startValue</span> <span class="p">=</span> <span class="n">currentParameters</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">kvp</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span> <span class="p">?</span> <span class="n">currentParameters</span><span class="p">[</span><span class="n">kvp</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">:</span> <span class="n">kvp</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
                <span class="kt">float</span> <span class="n">blendedValue</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Lerp</span><span class="p">(</span><span class="n">startValue</span><span class="p">,</span> <span class="n">kvp</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">blendProgress</span><span class="p">);</span>
                <span class="n">blendedParams</span><span class="p">[</span><span class="n">kvp</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">=</span> <span class="n">blendedValue</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Apply blended parameters</span>
            <span class="nf">ApplyParameters</span><span class="p">(</span><span class="n">blendedParams</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">ApplyEmotionalState</span><span class="p">(</span><span class="n">EmotionalState</span> <span class="n">state</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
            
            <span class="c1">// Convert state to parameters and apply</span>
            <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="nf">ToParameterDictionary</span><span class="p">();</span>
            <span class="nf">ApplyParameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">);</span>
            
            <span class="c1">// Apply suggested audio state if available</span>
            <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">suggestedAudioState</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">audioController</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">audioController</span><span class="p">.</span><span class="nf">TransitionToState</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">suggestedAudioState</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">private</span> <span class="k">void</span> <span class="nf">ApplyParameters</span><span class="p">(</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Apply to interactive audio controller</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">audioController</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">kvp</span> <span class="k">in</span> <span class="n">parameters</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">audioController</span><span class="p">.</span><span class="nf">SetParameter</span><span class="p">(</span><span class="n">kvp</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">kvp</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="c1">// Apply to mixer effects, music source, and ambience source</span>
            <span class="c1">// (See full implementation for details)</span>
        <span class="p">}</span>
        
        <span class="c1">// Designer-friendly methods to gradually adjust emotional states</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">AdjustEmotion</span><span class="p">(</span><span class="kt">string</span> <span class="n">emotion</span><span class="p">,</span> <span class="kt">float</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">float</span> <span class="n">blendTime</span> <span class="p">=</span> <span class="m">1.0f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">activeState</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
            
            <span class="c1">// Create a copy of the current state</span>
            <span class="n">EmotionalState</span> <span class="n">adjustedState</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EmotionalState</span><span class="p">();</span>
            
            <span class="c1">// Copy all values</span>
            <span class="n">adjustedState</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">activeState</span><span class="p">.</span><span class="n">name</span><span class="p">}</span><span class="s">_adjusted"</span><span class="p">;</span>
            <span class="n">adjustedState</span><span class="p">.</span><span class="n">joy</span> <span class="p">=</span> <span class="n">activeState</span><span class="p">.</span><span class="n">joy</span><span class="p">;</span>
            <span class="n">adjustedState</span><span class="p">.</span><span class="n">sadness</span> <span class="p">=</span> <span class="n">activeState</span><span class="p">.</span><span class="n">sadness</span><span class="p">;</span>
            <span class="n">adjustedState</span><span class="p">.</span><span class="n">fear</span> <span class="p">=</span> <span class="n">activeState</span><span class="p">.</span><span class="n">fear</span><span class="p">;</span>
            <span class="n">adjustedState</span><span class="p">.</span><span class="n">anger</span> <span class="p">=</span> <span class="n">activeState</span><span class="p">.</span><span class="n">anger</span><span class="p">;</span>
            <span class="c1">// ... copy other properties</span>
            
            <span class="c1">// Apply adjustment to specified emotion</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">emotion</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="s">"joy"</span><span class="p">:</span> <span class="n">adjustedState</span><span class="p">.</span><span class="n">joy</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp01</span><span class="p">(</span><span class="n">adjustedState</span><span class="p">.</span><span class="n">joy</span> <span class="p">+</span> <span class="n">amount</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s">"sadness"</span><span class="p">:</span> <span class="n">adjustedState</span><span class="p">.</span><span class="n">sadness</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp01</span><span class="p">(</span><span class="n">adjustedState</span><span class="p">.</span><span class="n">sadness</span> <span class="p">+</span> <span class="n">amount</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s">"fear"</span><span class="p">:</span> <span class="n">adjustedState</span><span class="p">.</span><span class="n">fear</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp01</span><span class="p">(</span><span class="n">adjustedState</span><span class="p">.</span><span class="n">fear</span> <span class="p">+</span> <span class="n">amount</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
                <span class="c1">// ... handle other emotions</span>
            <span class="p">}</span>
            
            <span class="c1">// Adjust derived audio parameters based on emotional changes</span>
            <span class="c1">// For example, increasing fear increases tension and decreases energy</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">emotion</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">()</span> <span class="p">==</span> <span class="s">"fear"</span> <span class="p">&amp;&amp;</span> <span class="n">amount</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">adjustedState</span><span class="p">.</span><span class="n">tension</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp01</span><span class="p">(</span><span class="n">adjustedState</span><span class="p">.</span><span class="n">tension</span> <span class="p">+</span> <span class="p">(</span><span class="n">amount</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">));</span>
                <span class="n">adjustedState</span><span class="p">.</span><span class="n">musicEnergy</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp01</span><span class="p">(</span><span class="n">adjustedState</span><span class="p">.</span><span class="n">musicEnergy</span> <span class="p">-</span> <span class="p">(</span><span class="n">amount</span> <span class="p">*</span> <span class="m">0.3f</span><span class="p">));</span>
                <span class="n">adjustedState</span><span class="p">.</span><span class="n">ambientTension</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp01</span><span class="p">(</span><span class="n">adjustedState</span><span class="p">.</span><span class="n">ambientTension</span> <span class="p">+</span> <span class="p">(</span><span class="n">amount</span> <span class="p">*</span> <span class="m">0.7f</span><span class="p">));</span>
            <span class="p">}</span>
            
            <span class="c1">// Set the adjusted state as target</span>
            <span class="n">targetState</span> <span class="p">=</span> <span class="n">adjustedState</span><span class="p">;</span>
            <span class="n">blendDuration</span> <span class="p">=</span> <span class="n">blendTime</span><span class="p">;</span>
            <span class="n">blendProgress</span> <span class="p">=</span> <span class="m">0.0f</span><span class="p">;</span>
            
            <span class="c1">// Initialize blend with current parameters</span>
            <span class="n">currentParameters</span> <span class="p">=</span> <span class="n">activeState</span><span class="p">.</span><span class="nf">ToParameterDictionary</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="complete-implementation">Complete Implementation</h2>

<p>The complete implementation of our interactive audio systems includes all the classes and methods we’ve covered, along with additional utilities for asset management, batch generation, and integration with game engines. The core concept remains the same: create parameter-driven audio that responds dynamically to game states and user actions.</p>

<p>For a full implementation, you would:</p>

<ol>
  <li>Set up a workflow to generate asset libraries using the Python generators</li>
  <li>Integrate the C# scripts into your Unity project</li>
  <li>Configure audio states, layers, and parameter mappings in the Unity Inspector</li>
  <li>Connect game events to the audio system through the parameter and state interfaces</li>
</ol>

<h2 id="variations-and-customizations">Variations and Customizations</h2>

<p>Let’s explore some variations of our solution to address different needs or preferences.</p>

<h3 id="variation-1-real-time-generation-pipeline">Variation 1: Real-Time Generation Pipeline</h3>

<p>For applications with available processing power and controlled latency requirements, you could implement a real-time generation pipeline:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RealtimeAudioGenerator</span><span class="p">:</span>
    <span class="s">"""
    Handles real-time generation of audio based on continuously updating parameters.
    
    This system uses a background worker thread to generate audio ahead of time,
    based on predicted parameter changes, ensuring seamless transitions.
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_duration</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">prediction_model</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Initialize thread-safe queue for generation requests
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">request_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        
        <span class="c1"># Initialize buffer for pre-generated audio
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">audio_buffer</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Set up worker thread
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">worker_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_generation_worker</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">worker_thread</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">worker_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_generation_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Worker thread that processes generation requests."""</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># Get next request from queue
</span>            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request_queue</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
            
            <span class="c1"># Generate audio for the request
</span>            <span class="n">audio</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_generate_audio</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            
            <span class="c1"># Add to buffer
</span>            <span class="n">buffer_key</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s">"key"</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">audio_buffer</span><span class="p">[</span><span class="n">buffer_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio</span>
            
            <span class="c1"># Mark task as done
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">request_queue</span><span class="p">.</span><span class="n">task_done</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">request_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">prediction_time</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="s">"""
        Request generation of audio for future parameters.
        
        Args:
            parameters: Environmental or music parameters
            prediction_time: How far in the future these parameters are expected
        """</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"key"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_buffer_key</span><span class="p">(</span><span class="n">parameters</span><span class="p">),</span>
            <span class="s">"parameters"</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
            <span class="s">"prediction_time"</span><span class="p">:</span> <span class="n">prediction_time</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">request_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="s">"""
        Get audio for the closest matching parameters in the buffer.
        
        Args:
            parameters: Current parameters
            
        Returns:
            Audio data for the closest match in the buffer
        """</span>
        <span class="n">buffer_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_buffer_key</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        
        <span class="c1"># If exact match exists, return it
</span>        <span class="k">if</span> <span class="n">buffer_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">audio_buffer</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">audio_buffer</span><span class="p">[</span><span class="n">buffer_key</span><span class="p">]</span>
        
        <span class="c1"># Otherwise find closest match
</span>        <span class="n">closest_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_find_closest_match</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">closest_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">audio_buffer</span><span class="p">[</span><span class="n">closest_key</span><span class="p">]</span>
        
        <span class="c1"># If no suitable match, generate synchronously (fallback)
</span>        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_generate_audio</span><span class="p">({</span><span class="s">"parameters"</span><span class="p">:</span> <span class="n">parameters</span><span class="p">})</span>
</code></pre></div></div>

<h3 id="variation-2-hierarchical-emotion-system">Variation 2: Hierarchical Emotion System</h3>

<p>For narrative-driven applications, a hierarchical emotion system provides more nuanced control:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HierarchicalEmotionSystem</span><span class="p">:</span>
    <span class="s">"""
    Manages audio emotions using a hierarchical structure of scene, sequence, and moment.
    
    - Scene: Overall emotional context (e.g., "creepy dungeon", "joyful celebration")
    - Sequence: Current narrative sequence (e.g., "confrontation", "revelation")
    - Moment: Immediate emotional beat (e.g., "sudden shock", "dawning realization")
    """</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">scene_emotion</span> <span class="o">=</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"neutral"</span><span class="p">,</span> <span class="s">"weight"</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sequence_emotion</span> <span class="o">=</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"neutral"</span><span class="p">,</span> <span class="s">"weight"</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span> <span class="o">=</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"neutral"</span><span class="p">,</span> <span class="s">"weight"</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s">"decay_rate"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">emotion_definitions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"neutral"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"joy"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s">"sadness"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s">"fear"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s">"anger"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s">"tension"</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s">"mystery"</span><span class="p">:</span> <span class="mf">0.2</span>
            <span class="p">},</span>
            <span class="s">"joyful"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"joy"</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s">"sadness"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s">"fear"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s">"anger"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s">"tension"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s">"mystery"</span><span class="p">:</span> <span class="mf">0.1</span>
            <span class="p">},</span>
            <span class="c1"># ... other emotion definitions
</span>        <span class="p">}</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">set_scene_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emotion_name</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="s">"""Set the scene-level emotion."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">scene_emotion</span> <span class="o">=</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="n">emotion_name</span><span class="p">,</span> <span class="s">"weight"</span><span class="p">:</span> <span class="n">weight</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">set_sequence_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emotion_name</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
        <span class="s">"""Set the sequence-level emotion."""</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sequence_emotion</span> <span class="o">=</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="n">emotion_name</span><span class="p">,</span> <span class="s">"weight"</span><span class="p">:</span> <span class="n">weight</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">trigger_moment_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emotion_name</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decay_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="s">"""
        Trigger a moment-level emotion that gradually decays.
        
        Args:
            emotion_name: Name of the emotion
            intensity: Initial intensity (0-1)
            decay_rate: How quickly the emotion fades (per second)
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"name"</span><span class="p">:</span> <span class="n">emotion_name</span><span class="p">,</span> 
            <span class="s">"weight"</span><span class="p">:</span> <span class="n">intensity</span><span class="p">,</span> 
            <span class="s">"decay_rate"</span><span class="p">:</span> <span class="n">decay_rate</span><span class="p">,</span>
            <span class="s">"start_time"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_current_emotion_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Calculate current emotion parameters based on all three levels.
        
        Returns:
            Dictionary of emotion parameters
        """</span>
        <span class="c1"># Update moment emotion based on decay
</span>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"start_time"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">last_update_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_update_time</span> <span class="o">=</span> <span class="n">current_time</span>
        
        <span class="c1"># Apply decay to moment emotion
</span>        <span class="k">if</span> <span class="s">"decay_rate"</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span><span class="p">:</span>
            <span class="n">decay_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span><span class="p">[</span><span class="s">"decay_rate"</span><span class="p">]</span> <span class="o">*</span> <span class="n">elapsed_time</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span><span class="p">[</span><span class="s">"weight"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span><span class="p">[</span><span class="s">"weight"</span><span class="p">]</span> <span class="o">-</span> <span class="n">decay_amount</span><span class="p">)</span>
        
        <span class="c1"># Get base parameters for each emotion
</span>        <span class="n">scene_params</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">emotion_definitions</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">scene_emotion</span><span class="p">[</span><span class="s">"name"</span><span class="p">],</span> <span class="p">{})</span>
        <span class="n">sequence_params</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">emotion_definitions</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">sequence_emotion</span><span class="p">[</span><span class="s">"name"</span><span class="p">],</span> <span class="p">{})</span>
        <span class="n">moment_params</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">emotion_definitions</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span><span class="p">[</span><span class="s">"name"</span><span class="p">],</span> <span class="p">{})</span>
        
        <span class="c1"># Calculate weights
</span>        <span class="n">total_weight</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">scene_emotion</span><span class="p">[</span><span class="s">"weight"</span><span class="p">]</span> <span class="o">+</span> 
            <span class="bp">self</span><span class="p">.</span><span class="n">sequence_emotion</span><span class="p">[</span><span class="s">"weight"</span><span class="p">]</span> <span class="o">+</span> 
            <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span><span class="p">[</span><span class="s">"weight"</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">scene_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">scene_emotion</span><span class="p">[</span><span class="s">"weight"</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_weight</span>
        <span class="n">sequence_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sequence_emotion</span><span class="p">[</span><span class="s">"weight"</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_weight</span>
        <span class="n">moment_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">moment_emotion</span><span class="p">[</span><span class="s">"weight"</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_weight</span>
        
        <span class="c1"># Blend parameters
</span>        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">scene_params</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">sequence_params</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">moment_params</span><span class="p">):</span>
            <span class="n">scene_value</span> <span class="o">=</span> <span class="n">scene_params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scene_weight</span>
            <span class="n">sequence_value</span> <span class="o">=</span> <span class="n">sequence_params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">sequence_weight</span>
            <span class="n">moment_value</span> <span class="o">=</span> <span class="n">moment_params</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">moment_weight</span>
            
            <span class="n">result</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">scene_value</span> <span class="o">+</span> <span class="n">sequence_value</span> <span class="o">+</span> <span class="n">moment_value</span>
        
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></div>

<h2 id="common-pitfalls-and-troubleshooting">Common Pitfalls and Troubleshooting</h2>

<h3 id="problem-audio-transition-artifacts">Problem: Audio Transition Artifacts</h3>

<p>When transitioning between states or adjusting parameters, you might encounter audible pops, clicks, or abrupt changes.</p>

<p><strong>Solution</strong>:</p>
<ul>
  <li>Use proper crossfading techniques with appropriate timing</li>
  <li>Implement amplitude-based crossfades that prevent zero-crossing issues</li>
  <li>Consider using an audio mixer with built-in smoothing for parameter changes:</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Example of improved crossfading in Unity</span>
<span class="k">private</span> <span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">IEnumerator</span> <span class="nf">ImprovedCrossfade</span><span class="p">(</span>
    <span class="n">AudioSource</span> <span class="n">source</span><span class="p">,</span> <span class="n">AudioClip</span> <span class="n">newClip</span><span class="p">,</span> <span class="kt">float</span> <span class="n">fadeDuration</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Create a separate source for crossfading</span>
    <span class="n">AudioSource</span> <span class="n">newSource</span> <span class="p">=</span> <span class="n">gameObject</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;();</span>
    <span class="n">newSource</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">newClip</span><span class="p">;</span>
    <span class="n">newSource</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    <span class="n">newSource</span><span class="p">.</span><span class="n">outputAudioMixerGroup</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">outputAudioMixerGroup</span><span class="p">;</span>
    <span class="n">newSource</span><span class="p">.</span><span class="n">spatialBlend</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">spatialBlend</span><span class="p">;</span>
    <span class="n">newSource</span><span class="p">.</span><span class="n">loop</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">loop</span><span class="p">;</span>
    
    <span class="c1">// Start playing the new source</span>
    <span class="n">newSource</span><span class="p">.</span><span class="nf">Play</span><span class="p">();</span>
    
    <span class="c1">// Crossfade between sources</span>
    <span class="kt">float</span> <span class="n">timeElapsed</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">timeElapsed</span> <span class="p">&lt;</span> <span class="n">fadeDuration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">t</span> <span class="p">=</span> <span class="n">timeElapsed</span> <span class="p">/</span> <span class="n">fadeDuration</span><span class="p">;</span>
        <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Lerp</span><span class="p">(</span><span class="m">1f</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
        <span class="n">newSource</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Lerp</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
        <span class="n">timeElapsed</span> <span class="p">+=</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">;</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// Ensure perfect end values</span>
    <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="m">0f</span><span class="p">;</span>
    <span class="n">newSource</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
    
    <span class="c1">// Stop and clean up the old source</span>
    <span class="n">source</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
    <span class="n">source</span><span class="p">.</span><span class="n">clip</span> <span class="p">=</span> <span class="n">newClip</span><span class="p">;</span>
    <span class="n">source</span><span class="p">.</span><span class="n">volume</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>
    
    <span class="c1">// Remove the temporary source</span>
    <span class="nf">Destroy</span><span class="p">(</span><span class="n">newSource</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="problem-parameter-optimization-challenges">Problem: Parameter Optimization Challenges</h3>

<p>Designing and tuning effective parameter mappings can be challenging and time-consuming.</p>

<p><strong>Solution</strong>:</p>
<ul>
  <li>Create a parameter visualization tool that shows how parameters affect prompt generation</li>
  <li>Implement a test harness for quickly auditioning different parameter combinations</li>
  <li>Use machine learning to optimize parameter mappings based on user feedback:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">visualize_parameter_mapping</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">"""
    Visualize how changing a parameter affects generated prompts.
    
    Args:
        generator: The ParametricAudioGenerator instance
        param_name: Name of parameter to visualize
        values: List of values to test (defaults to range from 0 to 1)
    """</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    
    <span class="c1"># Create base parameters
</span>    <span class="n">base_params</span> <span class="o">=</span> <span class="n">EnvironmentParameters</span><span class="p">(</span>
        <span class="n">environment_type</span><span class="o">=</span><span class="s">"forest"</span><span class="p">,</span>
        <span class="n">time_of_day</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">day_night_cycle</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">weather_type</span><span class="o">=</span><span class="s">"clear"</span><span class="p">,</span>
        <span class="n">weather_intensity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">wind_intensity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">tension</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">danger</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">population_density</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">civilization_proximity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">magic_presence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">supernatural_activity</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="p">)</span>
    
    <span class="c1"># Test different parameter values
</span>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="c1"># Set the parameter
</span>        <span class="nb">setattr</span><span class="p">(</span><span class="n">base_params</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Generate prompt
</span>        <span class="n">prompt</span> <span class="o">=</span> <span class="n">generator</span><span class="p">.</span><span class="n">generate_prompt_from_parameters</span><span class="p">(</span><span class="n">base_params</span><span class="p">)</span>
        
        <span class="c1"># Store result
</span>        <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s">"value"</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s">"prompt"</span><span class="p">:</span> <span class="n">prompt</span>
        <span class="p">})</span>
    
    <span class="c1"># Print results
</span>    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Parameter: </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"-"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s">'value'</span><span class="p">]:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s">'prompt'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"-"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="problem-memory-usage-in-real-time-applications">Problem: Memory Usage in Real-Time Applications</h3>

<p>Audio generation models can consume significant memory, which is particularly challenging in real-time applications with limited resources.</p>

<p><strong>Solution</strong>:</p>
<ul>
  <li>Implement a caching system for frequently used audio segments</li>
  <li>Use model quantization and optimization techniques for deployment</li>
  <li>Consider pre-generating asset libraries for common states and parameters:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">optimize_model_for_deployment</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">quantize</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="s">"""
    Optimize a model for deployment by quantizing and streamlining it.
    
    Args:
        model: The AudioCraft model to optimize
        output_path: Where to save the optimized model
        quantize: Whether to apply quantization
    """</span>
    <span class="c1"># 1. Trace the model
</span>    <span class="n">example_input</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># Example input tensor
</span>    <span class="n">traced_model</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">jit</span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">example_input</span><span class="p">)</span>
    
    <span class="c1"># 2. Quantize if requested
</span>    <span class="k">if</span> <span class="n">quantize</span><span class="p">:</span>
        <span class="n">quantized_model</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">quantization</span><span class="p">.</span><span class="n">quantize_dynamic</span><span class="p">(</span>
            <span class="n">traced_model</span><span class="p">,</span> <span class="p">{</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">},</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">qint8</span>
        <span class="p">)</span>
        <span class="n">export_model</span> <span class="o">=</span> <span class="n">quantized_model</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">export_model</span> <span class="o">=</span> <span class="n">traced_model</span>
    
    <span class="c1"># 3. Save the optimized model
</span>    <span class="n">torch</span><span class="p">.</span><span class="n">jit</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">export_model</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
    
    <span class="c1"># 4. Print memory savings
</span>    <span class="n">original_size</span> <span class="o">=</span> <span class="n">get_model_size</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">optimized_size</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>  <span class="c1"># MB
</span>    
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Original model size: </span><span class="si">{</span><span class="n">original_size</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Optimized model size: </span><span class="si">{</span><span class="n">optimized_size</span><span class="p">:.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Memory reduction: </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">optimized_size</span><span class="o">/</span><span class="n">original_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="hands-on-challenge-create-an-emotion-aware-audio-environment">Hands-on Challenge: Create an Emotion-Aware Audio Environment</h2>

<p><strong>Challenge:</strong> Build a complete emotion-aware audio environment that responds to a player’s game state.</p>

<ol>
  <li>Define five emotional states: neutral, tense, triumphant, mysterious, and defeated</li>
  <li>Create parameter mappings for each emotional state</li>
  <li>Implement transitions between states based on gameplay events</li>
  <li>Build a demonstration scene that shows all states and transitions</li>
  <li>Generate a complete asset package using AudioCraft</li>
</ol>

<p><strong>Steps to implement:</strong></p>

<ol>
  <li>Create the EmotionalState definitions for each of the five states</li>
  <li>Implement the parameter mappings for audio and music</li>
  <li>Build the interactive audio controllers that respond to these states</li>
  <li>Create a test scene with state trigger zones</li>
  <li>Generate the complete audio asset set using our AudioCraft systems</li>
</ol>

<h2 id="key-takeaways">Key Takeaways</h2>

<ul>
  <li>Parameter-driven audio generation enables responsive, contextual audio experiences</li>
  <li>State-based architectures provide structure and predictability for game audio systems</li>
  <li>Emotion mapping connects narrative and gameplay elements to appropriate audio characteristics</li>
  <li>Layered audio design allows for more nuanced and dynamic soundscapes</li>
  <li>Effective transitions are crucial for creating seamless interactive audio</li>
</ul>

<h2 id="next-steps">Next Steps</h2>

<p>Now that you’ve mastered interactive audio systems with AudioCraft, you’re ready to explore:</p>

<ul>
  <li><strong>Multimedia Integration</strong>: Connect audio generation with procedural visuals and gameplay systems</li>
  <li><strong>Narrative-Driven Audio</strong>: Create audio that responds to story progress and character emotions</li>
  <li><strong>User Interaction Models</strong>: Design audio systems that respond directly to user input and feedback</li>
</ul>

<h2 id="further-reading">Further Reading</h2>

<ul>
  <li><a href="https://www.fmod.com/resources/documentation-api">The Guide to Game Audio Implementation</a> - Comprehensive overview of game audio systems</li>
  <li><a href="https://mitpress.mit.edu/books/procedural-audio-games">Procedural Audio in Games</a> - Research on algorithmic sound generation</li>
  <li><a href="https://arxiv.org/abs/2010.14804">Emotional Music Generation</a> - Research paper on emotion-driven music systems</li>
  <li><a href="https://www.ias-symposium.org/">Interactive Audio Systems Symposium</a> - Conference proceedings on cutting-edge audio interaction</li>
</ul>

  
  
  
  
  
  
  
  
</div>

<div class="chapter-navigation">
  
  <a href="/chapters/conclusion" class="prev-chapter">
    <span class="nav-label">Previous</span>
    <span class="nav-title">Conclusion: Your Journey with Meta AudioCraft</span>
  </a>
  
  
  
  <a href="/chapters/part5/research-extensions-future-directions/" class="next-chapter">
    <span class="nav-label">Next</span>
    <span class="nav-title">Chapter 21: Research Extensions and Future Directions</span>
  </a>
  
</div>

<!-- Copyright footer for all chapter pages -->
<div class="copyright-footer">
  <hr>
  <p>
    Copyright © 2025 Scott Friedman.
    <br>
    This work is licensed under the <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.
  </p>
</div>


        </div>
      </main>

      <footer class="site-footer">
        <div class="container">
          <div class="footer-col-wrapper">
            <div class="footer-col">
              <p>A hands-on guide to creating music, sound effects, and audio experiences with AI</p>
              <p>
                <a href="https://github.com/facebookresearch/audiocraft">AudioCraft GitHub Repository</a>
              </p>
            </div>
            <div class="footer-col">
              <p class="copyright">
                Copyright © 2025 Scott Friedman.<br>
                Licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a>.
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>